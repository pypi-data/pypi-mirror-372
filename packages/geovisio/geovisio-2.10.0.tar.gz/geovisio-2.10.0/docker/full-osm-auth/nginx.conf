# Ningx configuration, do not hesitate to tune it for your needs (and to propose improvements on this)
worker_processes auto;

events { worker_connections 1024; }

http {

    sendfile on;

    upstream api {
        server api:5000;
    }
 
    upstream website {
        server website:3000;
    }

	server {
		listen 8080;

		# We need to set X-Forwarded headers, so the API can use them to make nice internal links
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		# Limit the files that can be sent to 100M
		client_max_body_size  100M;

		# buffer size when receiving big files. 6M should be enough for most pictures, but feel free to tune this value depending of your needs.
		client_body_buffer_size 6M;

		client_body_timeout	120s;
		send_timeout		60s;
		proxy_read_timeout	120s;
		proxy_send_timeout	120s;

		# Note: you might want to add some cache on some heavily used routes, likes high level zoom on /api/map
		location /api {
			proxy_pass http://api;
			proxy_redirect default;
		}

		location / {
			proxy_pass http://website;
			proxy_redirect default;
		}

		location = /robots.txt {
		alias /etc/nginx/robots.txt;
		default_type text/plain;
		}

		# we ask nginx to do a proxy to the pictures, so that they can be served directly, without going through the API
		# we use a trick to convert the picture's uuid to it's path in the storage
		rewrite ^/(permanent|derivates|derivatives)/([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])-(.*)$ /$1/$2/$3/$4/$5/$6 last;

		gzip	on;
		gzip_types	text/plain application/xml image/svg+xml text/css text/javascript text/xml application/json application/javascript;

		location /permanent/ {
			add_header	'Access-Control-Allow-Origin' '*';
			add_header  'Access-Control-Allow-Methods' 'GET, OPTIONS';
			root 		/data/geovisio;
		}

		location /derivates/ {
			add_header	'Access-Control-Allow-Origin' '*';
			add_header  'Access-Control-Allow-Methods' 'GET, OPTIONS';
			root 		/data/geovisio;
		}

		location /derivatives/ {
			alias 		/data/geovisio/derivates/;
			add_header	'Access-Control-Allow-Origin' '*';
			add_header  'Access-Control-Allow-Methods' 'GET, OPTIONS';
		}

	}
}
