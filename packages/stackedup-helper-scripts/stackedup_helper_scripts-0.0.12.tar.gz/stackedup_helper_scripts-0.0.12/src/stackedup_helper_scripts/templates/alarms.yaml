---
Description: OMBU Alarms

# Deafult OMBU setup alarms for one account, one SES Identity, a development
# aand production cluster.

Parameters:

  BaselineCost:
    Description: Expected monthly baseline AWS cost.
    Type: Number

  ThresholdCost:
    Description: Threshold cost about 50% of baseline cost.
    Type: Number

  SESIdentity:
    Description: A domain or email SES identity.
    Type: String

  SESIdentityFriendlyName:
    Description: Friendly name for identity.
    Type: String

  DevelopmentClusterStack:
    Description: The stack name that define the development cluster.
    Type: String

  DevelopmentDatabaseStorageThreshold:
    Description: The freespace left threshold in bytes.
    Type: Number

  ProductionClusterStack:
    Description: The stack name that define the production cluster.
    Type: String

  ProductionDatabaseStorageThreshold:
    Description: The freespace left threshold in bytes.
    Type: Number

  NotificationArn:
    Description: The ARN of the SNS topic to send notifications to.
    Type: String

Resources:

  RelaySNSTopic:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: alarm-parts/sns-relay.yaml
      Parameters:
        NotificationArn: !Ref NotificationArn

  AccountCostAlarm:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: alarm-parts/account-cost-alarm.yaml
      Parameters:
        BaselineCost: !Ref BaselineCost
        ThresholdCost: !Ref ThresholdCost
        NotificationArn: !GetAtt RelaySNSTopic.Outputs.RelaySNSTopicArn

  DevelopmentDatabaseAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: alarm-parts/database-alarms.yaml
      Parameters:
        DatabaseInstance:
          Fn::ImportValue:
            !Sub "${DevelopmentClusterStack}-DatabaseInstance"
        DatabaseStorageThreshold: !Ref DevelopmentDatabaseStorageThreshold
        NotificationArn: !GetAtt RelaySNSTopic.Outputs.RelaySNSTopicArn

  ProductionDatabaseAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: alarm-parts/database-alarms.yaml
      Parameters:
        DatabaseInstance:
          Fn::ImportValue:
            !Sub "${ProductionClusterStack}-DatabaseInstance"
        DatabaseStorageThreshold: !Ref ProductionDatabaseStorageThreshold
        NotificationArn: !GetAtt RelaySNSTopic.Outputs.RelaySNSTopicArn

  DevelopmentECSAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: alarm-parts/ecs-cluster-alarms.yaml
      Parameters:
        ClusterName:
          Fn::ImportValue:
            !Sub "${DevelopmentClusterStack}-ECSClusterName"
        NotificationArn: !GetAtt RelaySNSTopic.Outputs.RelaySNSTopicArn

  ProductionECSAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: alarm-parts/ecs-cluster-alarms.yaml
      Parameters:
        ClusterName:
          Fn::ImportValue:
            !Sub "${ProductionClusterStack}-ECSClusterName"
        NotificationArn: !GetAtt RelaySNSTopic.Outputs.RelaySNSTopicArn

  SESIdentityMonitor:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: alarm-parts/ses-identity-monitor-alarms.yaml
      Parameters:
        Identity: !Ref SESIdentity
        IdentityFriendlyName: !Ref SESIdentityFriendlyName
        NotificationArn: !GetAtt RelaySNSTopic.Outputs.RelaySNSTopicArn
