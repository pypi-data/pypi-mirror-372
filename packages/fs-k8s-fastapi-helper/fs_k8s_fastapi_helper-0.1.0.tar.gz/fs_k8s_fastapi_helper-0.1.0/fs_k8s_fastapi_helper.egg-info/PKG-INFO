Metadata-Version: 2.4
Name: fs-k8s-fastapi-helper
Version: 0.1.0
Summary: A Kubernetes health check probe helper for FastAPI applications
Author-email: wuzh <wuzh@fxiaoke.com>
Maintainer-email: wuzh <wuzh@fxiaoke.com>
License-Expression: MIT
Project-URL: Homepage, https://git.firstshare.cn/devops/fs-k8s-fastapi-helper
Project-URL: Documentation, https://git.firstshare.cn/devops/fs-k8s-fastapi-helper
Project-URL: Repository, https://git.firstshare.cn/devops/fs-k8s-fastapi-helper
Project-URL: Bug Tracker, https://git.firstshare.cn/devops/fs-k8s-fastapi-helper/-/issues
Keywords: kubernetes,k8s,fastapi,health-check,probe,liveness,readiness,microservices
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Classifier: Topic :: System :: Systems Administration
Classifier: Topic :: Internet :: WWW/HTTP :: HTTP Servers
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Operating System :: OS Independent
Classifier: Framework :: FastAPI
Requires-Python: >=3.7
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: fastapi[standard]>=0.100.0
Provides-Extra: dev
Requires-Dist: pytest>=6.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.18.0; extra == "dev"
Requires-Dist: black>=21.0; extra == "dev"
Requires-Dist: flake8>=3.8; extra == "dev"
Requires-Dist: mypy>=0.800; extra == "dev"
Requires-Dist: pre-commit>=2.15; extra == "dev"
Provides-Extra: test
Requires-Dist: pytest>=6.0; extra == "test"
Requires-Dist: pytest-asyncio>=0.18.0; extra == "test"
Requires-Dist: pytest-cov>=2.10; extra == "test"
Provides-Extra: docs
Requires-Dist: mkdocs>=1.2.0; extra == "docs"
Requires-Dist: mkdocs-material>=7.0; extra == "docs"
Dynamic: license-file

# fs-k8s-fastapi-helper

ä¸€ä¸ªä¸“ä¸ºKubernetesç¯å¢ƒè®¾è®¡çš„FastAPIåº”ç”¨å¥åº·æ£€æŸ¥æ¢é’ˆåŠ©æ‰‹ã€‚

## é¡¹ç›®ç®€ä»‹

FS K8s Python Helper æ˜¯ä¸€ä¸ªè½»é‡çº§çš„Pythonåº“ï¼Œä¸“é—¨ä¸ºåœ¨Kubernetesç¯å¢ƒä¸­è¿è¡Œçš„FastAPIåº”ç”¨æä¾›æ ‡å‡†åŒ–çš„å¥åº·æ£€æŸ¥æ¢é’ˆã€‚å®ƒç®€åŒ–äº†K8så¥åº·æ£€æŸ¥çš„é…ç½®ï¼Œæä¾›äº†å¼€ç®±å³ç”¨çš„å­˜æ´»æ¢é’ˆ(liveness probe)å’Œå°±ç»ªæ¢é’ˆ(readiness probe)å®ç°ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **å¿«é€Ÿé›†æˆ**: ä¸€è¡Œä»£ç å³å¯ä¸ºFastAPIåº”ç”¨æ·»åŠ K8så¥åº·æ£€æŸ¥æ¢é’ˆ
- ğŸ” **æ™ºèƒ½æ£€æµ‹**: æ”¯æŒè‡ªå®šä¹‰ç›®æ ‡è·¯å¾„çš„å°±ç»ªæ£€æŸ¥
- ğŸ›¡ï¸ **å®Œæ•´æ¢é’ˆ**: æä¾›å¯åŠ¨ã€å­˜æ´»å’Œå°±ç»ªä¸‰ç§æ¢é’ˆ

## å®‰è£…

### ä»PyPIå®‰è£…

```bash
pip install fs-k8s-fastapi-helper
```

### ä»æºç å®‰è£…

```bash
git clone https://git.firstshare.cn/devops/fs-k8s-fastapi-helper.git
cd fs-k8s-fastapi-helper
pip install -e .
```

### ä¾èµ–è¦æ±‚

- Python 3.7+
- FastAPI >= 0.100.0

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨

```python
from fastapi import FastAPI
from fs_k8s_fastapi_helper import install_k8s_health_probes

app = FastAPI()

# å®‰è£…åŸºæœ¬çš„å¥åº·æ£€æŸ¥æ¢é’ˆ
install_k8s_health_probes(app)

# ä½ çš„åº”ç”¨è·¯ç”±
@app.get("/")
def index():
    return {"message": "Welcome to FS K8s Python Helper Demo"}

@app.get("/health")
def ping():
    return {"status": "healthy", "service": "demo-app"}
```

> ğŸ’¡ **æ›´å¤šç¤ºä¾‹**: æŸ¥çœ‹ [examples/demo_app.py](examples/demo_app.py) è·å–å®Œæ•´çš„ç¤ºä¾‹åº”ç”¨ã€‚

### è‡ªå®šä¹‰é…ç½®

```python
from fastapi import FastAPI
from fs_k8s_fastapi_helper import install_k8s_health_probes

app = FastAPI()

# è‡ªå®šä¹‰å°±ç»ªæ£€æŸ¥ç›®æ ‡è·¯å¾„
install_k8s_health_probes(
    app,
    custom_readiness_path="/health"  # å°±ç»ªæ£€æŸ¥çš„ç›®æ ‡è·¯å¾„
)
```

## API æ–‡æ¡£

### æ¢é’ˆç«¯ç‚¹

#### å¯åŠ¨æ¢é’ˆ (Startup Probe)
- **è·¯å¾„**: `/k8s-helper/startup`
- **æ–¹æ³•**: GET
- **å“åº”**: 
  ```json
  {
    "status": "ok"
  }
  ```

#### å­˜æ´»æ¢é’ˆ (Liveness Probe)
- **è·¯å¾„**: `/k8s-helper/liveness`
- **æ–¹æ³•**: GET
- **å“åº”**: 
  ```json
  {
    "status": "ok"
  }
  ```

#### å°±ç»ªæ¢é’ˆ (Readiness Probe)
- **è·¯å¾„**: `/k8s-helper/readiness`
- **æ–¹æ³•**: GET
- **å“åº”**:
  ```json
  {
    "status": "ok"
  }
  ```
  æˆ–å½“ç›®æ ‡è·¯å¾„æ£€æŸ¥å¤±è´¥æ—¶:
  ```json
  {
    "status": "degraded",
    "target_status": 503
  }
  ```

### å‡½æ•°å‚æ•°

#### `install_k8s_health_probes()`

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|------|------|--------|------|
| `app` | FastAPI | å¿…éœ€ | FastAPIåº”ç”¨å®ä¾‹ |
| `custom_readiness_path` | Optional[str] | None | å°±ç»ªæ£€æŸ¥çš„ç›®æ ‡è·¯å¾„ï¼Œå¦‚æœæœ‰è‡ªå®šä¹‰çš„çŠ¶æ€æ£€æµ‹å¯ä¼ é€’è·¯å¾„ |

### å¸¸é‡å®šä¹‰

```python
STARTUP_PATH = "/k8s-helper/startup"
LIVENESS_PATH = "/k8s-helper/liveness"
READINESS_PATH = "/k8s-helper/readiness"
```

## Kubernetes é…ç½®ç¤ºä¾‹


## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: åŸºæœ¬å¥åº·æ£€æŸ¥
```python
# ä»…éªŒè¯åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
install_k8s_health_probes(app)
```

### åœºæ™¯2: ä¾èµ–æœåŠ¡æ£€æŸ¥
```python
# æ£€æŸ¥åº”ç”¨æ˜¯å¦èƒ½æ­£å¸¸è®¿é—®æ•°æ®åº“æˆ–å…¶ä»–ä¾èµ–æœåŠ¡
install_k8s_health_probes(app, custom_readiness_path="/health")
```

### åœºæ™¯3: è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
```python
# æ£€æŸ¥ç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘ç«¯ç‚¹
install_k8s_health_probes(app, custom_readiness_path="/health")
```

## å¼€å‘

### é¡¹ç›®ç»“æ„

```
fs-k8s-fastapi-helper/
â”œâ”€â”€ fs_k8s_fastapi_helper/     # ğŸ“¦ åŒ…æºç ç›®å½•
â”‚   â”œâ”€â”€ __init__.py          # åŒ…åˆå§‹åŒ–æ–‡ä»¶
â”‚   â””â”€â”€ service.py           # æ ¸å¿ƒæœåŠ¡æ¨¡å—
â”œâ”€â”€ tests/                   # ğŸ§ª æµ‹è¯•ç›®å½•
â”œâ”€â”€ docs/                    # ğŸ“š æ–‡æ¡£ç›®å½•
â”œâ”€â”€ examples/                # ğŸ¯ ç¤ºä¾‹åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ demo_app.py         # ğŸš€ å®Œæ•´ç¤ºä¾‹åº”ç”¨
â”‚   â””â”€â”€ README.md           # ğŸ“– ç¤ºä¾‹è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ pyproject.toml           # âš™ï¸ é¡¹ç›®é…ç½®ï¼ˆç°ä»£åŒ–ï¼‰
â”œâ”€â”€ MANIFEST.in              # ğŸ“‹ æ–‡ä»¶æ¸…å•
â”œâ”€â”€ LICENSE                  # ğŸ“„ è®¸å¯è¯
â””â”€â”€ README.md                # ğŸ“– é¡¹ç›®æ–‡æ¡£
```

### å¼€å‘ç¯å¢ƒè®¾ç½®

```bash
# å…‹éš†é¡¹ç›®
git clone https://git.firstshare.cn/devops/fs-k8s-fastapi-helper.git
cd fs-k8s-fastapi-helper

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ– venv\Scripts\activate  # Windows

# å®‰è£…å¼€å‘ä¾èµ–
pip install -e .[dev]

# è¿è¡Œä»£ç æ ¼å¼åŒ–
black .

# è¿è¡Œå¯¼å…¥æ’åº
isort .

# è¿è¡Œæµ‹è¯•
pytest

# è¿è¡Œç¤ºä¾‹åº”ç”¨
python examples/demo_app.py
```

### æ„å»ºå’Œå‘å¸ƒ

```bash
# æ„å»ºåŒ…
python -m build --no-isolation --sdist

# æ£€æŸ¥åŒ…
twine check dist/*

# ä¸Šä¼ åˆ°TestPyPIï¼ˆæµ‹è¯•ï¼‰
twine upload --repository testpypi dist/*

# ä¸Šä¼ åˆ°æ­£å¼PyPI
twine upload dist/*
```

### æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
# å¯åŠ¨ç¤ºä¾‹åº”ç”¨
python examples/demo_app.py

# æˆ–è€…ä½¿ç”¨uvicorn
uvicorn examples.demo_app:app --host 0.0.0.0 --port 8000

# æµ‹è¯•å¯åŠ¨æ¢é’ˆ
curl http://localhost:8000/k8s-helper/startup

# æµ‹è¯•å­˜æ´»æ¢é’ˆ
curl http://localhost:8000/k8s-helper/liveness

# æµ‹è¯•å°±ç»ªæ¢é’ˆ
curl http://localhost:8000/k8s-helper/readiness

# æµ‹è¯•è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

```

## å·¥ä½œåŸç†

1. **å¯åŠ¨æ¢é’ˆ**: ç®€å•çš„çŠ¶æ€æ£€æŸ¥ï¼Œç¡®è®¤åº”ç”¨æ˜¯å¦å·²å¯åŠ¨å®Œæˆ
2. **å­˜æ´»æ¢é’ˆ**: ç®€å•çš„çŠ¶æ€æ£€æŸ¥ï¼Œç¡®è®¤åº”ç”¨è¿›ç¨‹æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. **å°±ç»ªæ¢é’ˆ**: 
   - å¦‚æœæ²¡æœ‰è®¾ç½® `custom_readiness_path`ï¼Œä»…éªŒè¯åº”ç”¨è·¯ç”±æ˜¯å¦æ³¨å†Œ
- å¦‚æœè®¾ç½®äº† `custom_readiness_path`ï¼Œä¼šä½¿ç”¨ `TestClient` åœ¨å†…éƒ¨å‘èµ·è¯·æ±‚åˆ°æŒ‡å®šè·¯å¾„
   - å¦‚æœç›®æ ‡è·¯å¾„è¿”å› 4xx æˆ– 5xx çŠ¶æ€ç ï¼Œå°±ç»ªæ¢é’ˆä¼šè¿”å› 503 çŠ¶æ€ç 
   - å¦‚æœè¯·æ±‚è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œä¼šæ•è·å¼‚å¸¸å¹¶è¿”å›é”™è¯¯ä¿¡æ¯

## é”™è¯¯å¤„ç†

- **ç›®æ ‡è·¯å¾„ä¸å¯è¾¾**: è¿”å› 503 çŠ¶æ€ç å’Œ `degraded` çŠ¶æ€
- **ç½‘ç»œå¼‚å¸¸**: æ•è·å¼‚å¸¸å¹¶è¿”å›å¼‚å¸¸ç±»å‹ä¿¡æ¯
- **åº”ç”¨å¼‚å¸¸**: é€šè¿‡ HTTP çŠ¶æ€ç åˆ¤æ–­æœåŠ¡å¥åº·çŠ¶æ€

