AccessibilitySVG = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="var(--pst-color-text-muted)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M7 9L12 10M17 9L12 10M12 10V13M12 13L10 18M12 13L14 18" stroke="var(--pst-color-text-muted)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M12 7C11.7239 7 11.5 6.77614 11.5 6.5C11.5 6.22386 11.7239 6 12 6C12.2761 6 12.5 6.22386 12.5 6.5C12.5 6.77614 12.2761 7 12 7Z" fill="var(--pst-color-text-muted)" stroke="var(--pst-color-text-muted)" stroke-width="2.0" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`
FontSVG = `<svg fill="var(--pst-color-text-muted)" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 392.619 392.619" xml:space="preserve">
<g>
	<path d="M310.724,0.929H81.896C36.738,0.929,0,37.667,0,82.825v226.97c0,45.158,36.738,81.896,81.896,81.896h228.828
		c45.157,0,81.896-36.738,81.896-81.896V82.825C392.619,37.667,355.881,0.929,310.724,0.929z M362.619,309.794
		c0,28.616-23.28,51.896-51.896,51.896H81.896C53.28,361.69,30,338.41,30,309.794V82.825c0-28.616,23.28-51.896,51.896-51.896
		h228.828c28.615,0,51.896,23.28,51.896,51.896V309.794z"/>
	<path d="M291.608,286.594h-12.36c-1.954,0-3.704-1.209-4.396-3.036L205.179,99.565c-0.692-1.827-2.442-3.036-4.396-3.036h-2.045
		c-1.911,0-3.631,1.157-4.353,2.926l-67.527,165.629c-3.81,9.258-7.028,15.159-9.658,17.7s-7.695,3.81-15.193,3.81h-0.997
		c-2.596,0-4.701,2.104-4.701,4.701v0.095c0,2.596,2.104,4.701,4.701,4.701h53.71c2.596,0,4.701-2.104,4.701-4.701v-0.095
		c0-2.596-2.104-4.701-4.701-4.701h-6.117c-9.747,0-14.621-2.591-14.621-7.773c0-3.616,1.639-9.418,4.921-17.405l7.066-17.196
		c0.724-1.763,2.442-2.914,4.348-2.914h55.296c1.952,0,3.701,1.206,4.394,3.031l13.635,35.887c1.169,3.076-1.104,6.37-4.394,6.37
		h-14.66c-2.596,0-4.701,2.104-4.701,4.701v0.095c0,2.596,2.104,4.701,4.701,4.701h87.019c2.596,0,4.7-2.104,4.7-4.701v-0.095
		C296.309,288.698,294.204,286.594,291.608,286.594z M198.213,231.225h-39.891c-3.344,0-5.619-3.393-4.348-6.487l20.724-50.447
		c1.619-3.942,7.228-3.867,8.742,0.117l19.166,50.447C203.775,227.931,201.503,231.225,198.213,231.225z"/>
	<path d="M96.31,179.311c0-5.466-6.609-8.204-10.474-4.338l-18.933,18.933c-2.396,2.396-2.396,6.281,0,8.677l18.933,18.933
		c3.865,3.865,10.474,1.128,10.474-4.338V179.311z"/>
	<path d="M306.783,174.973c-3.865-3.865-10.474-1.128-10.474,4.338v37.866c0,5.466,6.609,8.203,10.474,4.338l18.933-18.933
		c2.396-2.396,2.396-6.281,0-8.677L306.783,174.973z"/>
</g>
</svg>`
ContrastSVG = `<svg fill="var(--pst-color-text-muted)" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 211 211" xml:space="preserve">
<g>
	<path d="M121,24.35V0H91v24.298c5-0.888,9.782-1.377,14.857-1.377C111.032,22.922,117,23.426,121,24.35z"/>
	<path d="M91,185.5V211h30v-25.449c-5,0.888-9.782,1.377-14.857,1.377C100.968,186.928,96,186.423,91,185.5z"/>
	<path d="M60.381,37.336L42.84,19.794L21.627,41.007l17.56,17.56C44.889,50.257,52.084,43.053,60.381,37.336z"/>
	<path d="M24.862,105.25c0-4.862,0.451-10.25,1.268-14.25H0v30h26.399C25.4,115,24.862,110.638,24.862,105.25z"/>
	<path d="M174.313,58.733l17.726-17.726l-21.213-21.213l-17.66,17.66C161.449,43.192,168.63,50.409,174.313,58.733z"/>
	<path d="M152.874,172.254l17.952,17.952l21.213-21.213l-17.934-17.934C168.387,159.357,161.183,166.551,152.874,172.254z"/>
	<path d="M187.251,91c0.817,4,1.268,9.388,1.268,14.25c0,5.388-0.538,9.75-1.536,15.75H211V91H187.251z"/>
	<path d="M39.395,151.226l-17.768,17.768l21.213,21.213l17.834-17.834C52.35,166.69,45.133,159.508,39.395,151.226z"/>
	<path d="M106.69,41.922c-34.644,0-62.828,28.185-62.828,62.828s28.185,62.828,62.828,62.828s62.828-28.185,62.828-62.828
		S141.334,41.922,106.69,41.922z M105.923,149.003c-0.052,0,0.077-0.004-0.923-0.004V60.501c1,0,0.85,0.499,0.822-0.501
		c24.379,1,44.654,20.116,44.654,44.501C150.476,128.902,130.324,149.003,105.923,149.003z"/>
</g>
</svg>`;

document.addEventListener("DOMContentLoaded", () => {
    // Create the menu
    const headerEnd = document.querySelector(".article-header-buttons");
    if (headerEnd) {
        const button = document.createElement("div");
        button.id = "AcccessibilityMenu";
        button.className = "dropdown";
        button.innerHTML = `<button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        ${AccessibilitySVG}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a href="#" class="btn btn-sm dropdown-item" data-action="toggleFont">
                            <span class="btn__icon-container">
                                ${FontSVG}
                            </span>
                            <span id="fontText" class="btn__text-container">${enableFont} <span style="font-family: OpenDyslexic">OpenDyslexic</span></span>
                        </a></li>
                        <li><a href="#" class="btn btn-sm dropdown-item" data-action="toggleContrast">
                            <span class="btn__icon-container">
                                ${ContrastSVG}
                            </span>
                            <span id="contrastText" class="btn__text-container">${enableContrast}</span>
                        </a></li>
                    </ul>`;

        headerEnd.prepend(button);
    }
    // Load saved font and contrast preference next
    loadFontPreference();
    loadContrastPreference();

    // Add event listeners
    document.getElementById("AcccessibilityMenu")?.addEventListener("click", (event) => {
        // Handle dropdown menu clicks
        if (event.target.closest('[data-action]')) {
            const action = event.target.closest('[data-action]').getAttribute('data-action');
            if (action === 'toggleFont') {
                toggleFont();
            } else if (action === 'toggleContrast') {
                toggleContrast();
            }
            event.preventDefault();
            return;
        }
    });
});

function toggleFont() {
    const body = document.body;
    body.classList.toggle("dyslexic");
    const fontText = document.getElementById("fontText");
    
    // Save font preference to localStorage
    const isDyslexicEnabled = body.classList.contains("dyslexic");
    localStorage.setItem("accessibility-font", isDyslexicEnabled ? "dyslexic" : "default");
    
    // Update button text
    if (isDyslexicEnabled) {
        fontText.innerHTML = `${disableFont} <span style="font-family: OpenDyslexic">OpenDyslexic</span>`;
    } else {
        fontText.innerHTML = `${enableFont} <span style="font-family: OpenDyslexic">OpenDyslexic</span>`;
    }
}

function toggleContrast() {
    const body = document.body;
    body.classList.toggle("high-contrast");
    const contrastText = document.getElementById("contrastText");

    // Save contrast preference to localStorage
    const isHighContrastEnabled = body.classList.contains("high-contrast");
    localStorage.setItem("accessibility-contrast", isHighContrastEnabled ? "enabled" : "disabled");

    // Update button text
    if (isHighContrastEnabled) {
        contrastText.innerHTML = disableContrast;
    } else {
        contrastText.innerHTML = enableContrast;
    }
}

// Load saved font preference on page load
function loadFontPreference() {
    const savedFont = localStorage.getItem("accessibility-font");
    const body = document.body;
    const fontText = document.getElementById("fontText");
    
    if (savedFont === "dyslexic") {
        body.classList.add("dyslexic");
        // Update button text if it exists
        if (fontText) {
            fontText.innerHTML = `${disableFont} <span style="font-family: OpenDyslexic">OpenDyslexic</span>`;
        }
    } else {
        // Handle default case (either "default" or null/undefined)
        body.classList.remove("dyslexic");
        // Update button text if it exists
        if (fontText) {
            fontText.innerHTML = `${enableFont} <span style="font-family: OpenDyslexic">OpenDyslexic</span>`;
        }
    }
}

// Load saved contrast preference on page load
function loadContrastPreference() {
    const savedContrast = localStorage.getItem("accessibility-contrast");
    const body = document.body;
    const contrastText = document.getElementById("contrastText");

    if (savedContrast === "enabled") {
        body.classList.add("high-contrast");
        // Update button text if it exists
        if (contrastText) {
            contrastText.innerHTML = disableContrast;
        }
    } else {
        // Handle default case (either "default" or null/undefined)
        body.classList.remove("high-contrast");
        // Update button text if it exists
        if (contrastText) {
            contrastText.innerHTML = enableContrast;
        }
    }
}