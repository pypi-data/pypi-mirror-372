class t{constructor(){this.container=null,this.svg=null,this.treeData=null,this.root=null,this.treeLayout=null,this.treeGroup=null,this.nodes=new Map,this.stats={files:0,classes:0,functions:0,methods:0,lines:0},this.margin={top:20,right:150,bottom:20,left:150},this.width=960-this.margin.left-this.margin.right,this.height=600-this.margin.top-this.margin.bottom,this.nodeId=0,this.duration=750,this.languageFilter="all",this.searchTerm="",this.tooltip=null,this.initialized=!1,this.analyzing=!1,this.selectedNode=null,this.socket=null}initialize(){if(console.log("CodeTree.initialize() called"),this.initialized)return void console.log("Code tree already initialized");if(this.container=document.getElementById("code-tree-container"),!this.container)return void console.error("Code tree container not found");console.log("Code tree container found:",this.container);const t=document.getElementById("code-tab");t?(console.log("Code tab panel found, active:",t.classList.contains("active")),this.setupControls(),this.initializeTreeData(),this.subscribeToEvents(),t.classList.contains("active")?(console.log("Tab is active, creating visualization"),this.createVisualization(),this.root&&this.svg&&this.update(this.root)):console.log("Tab is not active, deferring visualization"),this.initialized=!0,console.log("Code tree initialization complete")):console.error("Code tab panel not found")}renderWhenVisible(){if(console.log("CodeTree.renderWhenVisible() called"),console.log("Current state - initialized:",this.initialized,"svg:",!!this.svg),!this.initialized)return console.log("Not initialized, calling initialize()"),void this.initialize();this.svg?(console.log("SVG exists, forcing update"),this.root&&this.svg&&this.update(this.root)):(console.log("No SVG found, creating visualization"),this.createVisualization(),this.svg&&this.treeGroup?(console.log("SVG created, updating tree"),this.update(this.root)):console.log("Failed to create SVG or treeGroup"))}setupControls(){const t=document.getElementById("analyze-code");t&&t.addEventListener("click",()=>this.startAnalysis());const e=document.getElementById("cancel-analysis");e&&e.addEventListener("click",()=>this.cancelAnalysis());const s=document.getElementById("code-expand-all");s&&s.addEventListener("click",()=>this.expandAll());const i=document.getElementById("code-collapse-all");i&&i.addEventListener("click",()=>this.collapseAll());const o=document.getElementById("code-reset-zoom");o&&o.addEventListener("click",()=>this.resetZoom());const n=document.getElementById("code-toggle-legend");n&&n.addEventListener("click",()=>this.toggleLegend());const a=document.getElementById("language-filter");a&&a.addEventListener("change",t=>{this.languageFilter=t.target.value,this.filterByLanguage()});const l=document.getElementById("code-search");l&&l.addEventListener("input",t=>{this.searchTerm=t.target.value.toLowerCase(),this.highlightSearchResults()})}createVisualization(){if(console.log("Creating code tree visualization"),"undefined"==typeof d3)return void console.error("D3.js is not loaded! Cannot create code tree visualization.");console.log("D3 is available:",typeof d3);const t=document.getElementById("code-tree");if(!t)return void console.error("Code tree div not found");console.log("Code tree div found:",t),!this.root&&this.treeData&&(console.log("Creating D3 hierarchy from tree data"),this.root=d3.hierarchy(this.treeData),this.root.x0=this.height/2,this.root.y0=0),d3.select(t).selectAll("*").remove();const e=t.getBoundingClientRect();this.width=e.width-this.margin.left-this.margin.right,this.height=Math.max(500,e.height)-this.margin.top-this.margin.bottom,this.svg=d3.select(t).append("svg").attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${e.width} ${e.height}`).call(d3.zoom().scaleExtent([.1,3]).on("zoom",t=>{this.treeGroup.attr("transform",t.transform)})),this.treeGroup=this.svg.append("g").attr("transform",`translate(${this.margin.left},${this.margin.top})`),this.treeLayout=d3.tree().size([this.height,this.width]),this.tooltip=d3.select("body").append("div").attr("class","code-tooltip").style("opacity",0)}initializeTreeData(){console.log("Initializing tree data..."),this.treeData={name:"Project Root",type:"module",path:"/",complexity:0,children:[]},"undefined"!=typeof d3?(this.root=d3.hierarchy(this.treeData),this.root.x0=this.height/2,this.root.y0=0,console.log("Tree root created:",this.root)):(console.warn("D3 not available yet, deferring hierarchy creation"),this.root=null)}subscribeToEvents(){this.getSocket(),this.socket?(console.log("CodeTree: Socket available, subscribing to events"),this.socket.on("code:analysis:start",t=>this.handleAnalysisStart(t)),this.socket.on("code:analysis:accepted",t=>this.handleAnalysisAccepted(t)),this.socket.on("code:analysis:queued",t=>this.handleAnalysisQueued(t)),this.socket.on("code:analysis:cancelled",t=>this.handleAnalysisCancelled(t)),this.socket.on("code:analysis:progress",t=>this.handleProgress(t)),this.socket.on("code:analysis:complete",t=>this.handleAnalysisComplete(t)),this.socket.on("code:analysis:error",t=>this.handleAnalysisError(t)),this.socket.on("code:file:start",t=>this.handleFileStart(t)),this.socket.on("code:file:complete",t=>this.handleFileComplete(t)),this.socket.on("code:node:found",t=>this.handleNodeFound(t))):console.warn("CodeTree: Socket not available yet, will retry on analysis")}getSocket(){return this.socket||(window.socket?(this.socket=window.socket,console.log("CodeTree: Using window.socket")):window.dashboard?.socketClient?.socket?(this.socket=window.dashboard.socketClient.socket,console.log("CodeTree: Using dashboard.socketClient.socket")):window.socketClient?.socket&&(this.socket=window.socketClient.socket,console.log("CodeTree: Using socketClient.socket"))),this.socket}startAnalysis(){if(this.analyzing)return void console.log("Analysis already in progress");if(console.log("Starting code analysis..."),this.getSocket(),!this.socket)return console.error("Socket not available"),void this.showNotification("Cannot connect to server. Please check connection.","error");this.socket._callbacks&&this.socket._callbacks["code:analysis:start"]||(console.log("Re-subscribing to code analysis events"),this.subscribeToEvents()),this.analyzing=!0;const t=document.getElementById("analyze-code"),e=document.getElementById("cancel-analysis");t&&(t.textContent="Analyzing...",t.classList.add("analyzing")),e&&(e.style.display="inline-block"),this.showFooterAnalysisStatus("Starting analysis..."),this.initializeTreeData(),this.nodes.clear(),this.stats={files:0,classes:0,functions:0,methods:0,lines:0},this.updateStats(),this.svg||this.createVisualization(),this.root&&this.svg&&this.update(this.root);const s=document.getElementById("analysis-path");let i=s?.value?.trim();i&&""!==i||(i=window.workingDirectory||window.dashboard?.workingDirectory||window.socketClient?.sessions?.values()?.next()?.value?.working_directory||".",s&&"."!==i&&(s.value=i));const o=this.getSelectedLanguages(),n=parseInt(document.getElementById("max-depth")?.value)||null,a=this.getIgnorePatterns(),l=this.generateRequestId();this.currentRequestId=l;const r={request_id:l,path:i,languages:o.length>0?o:null,max_depth:n,ignore_patterns:a.length>0?a:null};console.log("Emitting code:analyze:request with payload:",r),this.socket.emit("code:analyze:request",r),this.requestTimeout=setTimeout(()=>{this.analyzing&&this.currentRequestId===l&&(console.warn("Analysis appears stuck after 60 seconds"),this.showNotification("Analysis is taking longer than expected. You can cancel if needed.","warning"))},6e4)}cancelAnalysis(){this.analyzing&&(console.log("Cancelling analysis..."),this.socket&&this.currentRequestId&&this.socket.emit("code:analyze:cancel",{request_id:this.currentRequestId}),this.resetAnalysisState())}resetAnalysisState(){this.analyzing=!1,this.currentRequestId=null,this.requestTimeout&&(clearTimeout(this.requestTimeout),this.requestTimeout=null);const t=document.getElementById("analyze-code"),e=document.getElementById("cancel-analysis");t&&(t.disabled=!1,t.textContent="Analyze",t.classList.remove("analyzing")),e&&(e.style.display="none"),this.hideFooterAnalysisStatus()}generateRequestId(){return`analysis-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getSelectedLanguages(){const t=[];return document.querySelectorAll(".language-checkbox:checked").forEach(e=>{t.push(e.value)}),t}getIgnorePatterns(){const t=[],e=document.getElementById("ignore-patterns");return e&&e.value&&t.push(...e.value.split(",").map(t=>t.trim()).filter(t=>t)),t}handleAnalysisStart(t){if(console.log("Code analysis started:",t),t.request_id&&t.request_id!==this.currentRequestId)return;this.requestTimeout&&(clearTimeout(this.requestTimeout),this.requestTimeout=null);const e=`Analyzing ${t.total_files||0} files...`;this.updateProgress(0,e),this.updateTicker(e,"progress"),this.showNotification("Analysis started - building tree in real-time...","info")}handleFileStart(t){console.log("Analyzing file:",t.path);const e=`Analyzing: ${t.path}`;this.updateProgress(t.progress||0,e),this.updateTicker(`📄 ${t.path}`,"file");const s={name:t.name||t.path.split("/").pop(),type:"file",path:t.path,language:t.language,children:[]};this.addNodeToTree(s,t.path),this.stats.files++,this.updateStats(),this.svg&&this.root&&(this.updateThrottleTimer||(this.updateThrottleTimer=setTimeout(()=>{this.update(this.root),this.updateThrottleTimer=null},100)))}handleFileComplete(t){if(console.log("File analysis complete:",t.path),t.stats){const e=this.nodes.get(t.path);e&&(e.stats=t.stats,t.stats.lines&&(this.stats.lines+=t.stats.lines,this.updateStats()))}}handleNodeFound(t){console.log("Node found:",t);const e={function:"⚡",class:"🏛️",method:"🔧",module:"📦"}[t.type]||"📌",s=t.name||"unnamed";this.updateTicker(`${e} ${s}`,"node");const i={name:t.name,type:t.type,path:t.path,line:t.line,complexity:t.complexity||0,docstring:t.docstring,params:t.params,returns:t.returns,children:[]};switch(this.addNodeToTree(i,t.parent_path||t.path),t.type){case"class":this.stats.classes++;break;case"function":this.stats.functions++;break;case"method":this.stats.methods++}t.lines&&(this.stats.lines+=t.lines),this.updateStats(),this.svg&&this.root&&(this.updateThrottleTimer&&clearTimeout(this.updateThrottleTimer),this.updateThrottleTimer=setTimeout(()=>{this.update(this.root),this.updateThrottleTimer=null},200))}handleProgress(t){this.updateProgress(t.percentage,t.message)}handleAnalysisComplete(t){if(console.log("Code analysis complete:",t),t.request_id&&t.request_id!==this.currentRequestId)return;this.resetAnalysisState(),this.svg&&this.update(this.root),t.stats&&(this.stats={...this.stats,...t.stats},this.updateStats());const e=`✅ Complete: ${this.stats.files} files, ${this.stats.functions} functions, ${this.stats.classes} classes`;this.updateTicker(e,"progress"),this.showNotification("Analysis complete","success")}handleAnalysisError(t){if(console.error("Code analysis error:",t),t.request_id&&t.request_id!==this.currentRequestId)return;this.resetAnalysisState();const e=t.message||"Unknown error";this.updateTicker(`❌ ${e}`,"error"),this.showNotification(`Analysis failed: ${e}`,"error")}handleAnalysisAccepted(t){console.log("Analysis request accepted:",t),t.request_id===this.currentRequestId&&(this.requestTimeout&&(clearTimeout(this.requestTimeout),this.requestTimeout=null),this.showNotification("Analysis request accepted by server","info"))}handleAnalysisQueued(t){console.log("Analysis queued:",t),t.request_id===this.currentRequestId&&this.showNotification(`Analysis queued (position: ${t.queue_size||1})`,"info")}handleAnalysisCancelled(t){console.log("Analysis cancelled:",t),t.request_id&&t.request_id!==this.currentRequestId||(this.resetAnalysisState(),this.showNotification("Analysis cancelled","warning"))}showNotification(t,e="info"){console.log(`CodeTree notification: ${t} (${e})`);let s=document.querySelector("#code-tab .notification-area");if(!s){const t=document.getElementById("code-tab");if(!t)return void console.error("Code tab not found for notification");s=document.createElement("div"),s.className="notification-area",s.style.cssText="\n                position: absolute;\n                top: 10px;\n                right: 10px;\n                max-width: 400px;\n                z-index: 1000;\n                padding: 12px 16px;\n                border-radius: 4px;\n                font-size: 14px;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                transition: opacity 0.3s ease;\n            ",t.insertBefore(s,t.firstChild)}const i={info:{bg:"#e3f2fd",text:"#1976d2",border:"#90caf9"},success:{bg:"#e8f5e9",text:"#388e3c",border:"#81c784"},warning:{bg:"#fff3e0",text:"#f57c00",border:"#ffb74d"},error:{bg:"#ffebee",text:"#d32f2f",border:"#ef5350"}},o=i[e]||i.info;s.style.backgroundColor=o.bg,s.style.color=o.text,s.style.border=`1px solid ${o.border}`,s.textContent=t,s.style.display="block",s.style.opacity="1",this.notificationTimeout&&clearTimeout(this.notificationTimeout),this.notificationTimeout=setTimeout(()=>{s.style.opacity="0",setTimeout(()=>{s.style.display="none"},300)},5e3)}addNodeToTree(t,e){let s=this.findNodeByPath(e);if(s||(s=this.treeData),this.nodes.has(t.path))console.log("Node already exists:",t.path);else if(s.children||(s.children=[]),s.children.push(t),this.nodes.set(t.path,t),"undefined"!=typeof d3){const t=new Set;this.root&&this.root.descendants().forEach(e=>{e.children&&t.add(e.data.path)}),this.root=d3.hierarchy(this.treeData),this.root.x0=this.height/2,this.root.y0=0,this.root.descendants().forEach(e=>{t.has(e.data.path)&&e._children&&(e.children=e._children,e._children=null)})}}findNodeByPath(t){return this.nodes.get(t)}updateProgress(t,e){const s=document.getElementById("footer-analysis-progress");if(s){let i=e||"Analyzing...";t>0&&(i=`[${Math.round(t)}%] ${i}`),s.textContent=i}}showFooterAnalysisStatus(t){const e=document.getElementById("footer-analysis-container"),s=document.getElementById("footer-analysis-progress");e&&(e.style.display="flex"),s&&(s.textContent=t||"Analyzing...",s.style.animation="pulse 1.5s ease-in-out infinite")}hideFooterAnalysisStatus(){const t=document.getElementById("footer-analysis-container"),e=document.getElementById("footer-analysis-progress");t&&setTimeout(()=>{t.style.display="none"},2e3),e&&(e.style.animation="none")}updateStats(){const t=document.getElementById("file-count"),e=document.getElementById("class-count"),s=document.getElementById("function-count"),i=document.getElementById("line-count");t&&(t.textContent=this.stats.files),e&&(e.textContent=this.stats.classes),s&&(s.textContent=this.stats.functions),i&&(i.textContent=this.stats.lines)}update(t){if(!this.svg||!this.treeGroup)return;const e=this.treeLayout(this.root),s=e.descendants(),i=e.links();s.forEach(t=>{t.y=180*t.depth});const o=this.treeGroup.selectAll("g.code-node").data(s,t=>t.id||(t.id=++this.nodeId)),n=o.enter().append("g").attr("class",t=>`code-node ${t.data.type} complexity-${this.getComplexityLevel(t.data.complexity)}`).attr("transform",e=>`translate(${t.y0},${t.x0})`).on("click",(t,e)=>this.toggleNode(t,e)).on("mouseover",(t,e)=>this.showTooltip(t,e)).on("mouseout",()=>this.hideTooltip());n.append("circle").attr("r",1e-6).style("fill",t=>t._children?"#e2e8f0":this.getNodeColor(t.data.type)),n.append("text").attr("dy",".35em").attr("x",t=>t.children||t._children?-13:13).attr("text-anchor",t=>t.children||t._children?"end":"start").text(t=>t.data.name).style("fill-opacity",1e-6),n.append("text").attr("class","node-icon").attr("dy",".35em").attr("x",0).attr("text-anchor","middle").text(t=>this.getNodeIcon(t.data.type)).style("font-size","16px");const a=n.merge(o);a.transition().duration(this.duration).attr("transform",t=>`translate(${t.y},${t.x})`),a.select("circle").attr("r",8).style("fill",t=>t._children?"#e2e8f0":this.getNodeColor(t.data.type)),a.select("text").style("fill-opacity",1);const l=o.exit().transition().duration(this.duration).attr("transform",e=>`translate(${t.y},${t.x})`).remove();l.select("circle").attr("r",1e-6),l.select("text").style("fill-opacity",1e-6);const r=this.treeGroup.selectAll("path.code-link").data(i,t=>t.target.id);r.enter().insert("path","g").attr("class","code-link").attr("d",e=>{const s={x:t.x0,y:t.y0};return this.diagonal(s,s)}).merge(r).transition().duration(this.duration).attr("d",t=>this.diagonal(t.source,t.target)),r.exit().transition().duration(this.duration).attr("d",e=>{const s={x:t.x,y:t.y};return this.diagonal(s,s)}).remove(),s.forEach(t=>{t.x0=t.x,t.y0=t.y})}diagonal(t,e){return`M ${t.y} ${t.x}\n                C ${(t.y+e.y)/2} ${t.x},\n                  ${(t.y+e.y)/2} ${e.x},\n                  ${e.y} ${e.x}`}toggleNode(t,e){e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null),this.update(e),this.updateBreadcrumb(e),this.selectNode(e),"module"!==e.data.type&&"file"!==e.data.type&&this.showCodeViewer(e.data)}selectNode(t){this.selectedNode&&d3.select(this.selectedNode).classed("selected",!1),this.selectedNode=t,t&&d3.select(t).classed("selected",!0)}updateBreadcrumb(t){const e=[];let s=t;for(;s;)e.unshift(s.data.name),s=s.parent;const i=document.getElementById("breadcrumb-content");i&&(i.textContent=e.join(" > "),i.className="ticker-file")}updateTicker(t,e="info"){const s=document.getElementById("breadcrumb-content");if(s){let i="";switch(e){case"file":i="ticker-file";break;case"node":i="ticker-node";break;case"progress":i="ticker-progress";break;case"error":i="ticker-error";break;default:i=""}s.textContent=t,s.className=i+" ticker-event",s.style.animation="none",setTimeout(()=>{s.style.animation=""},10)}}showCodeViewer(t){window.CodeViewer&&window.CodeViewer.show(t)}showTooltip(t,e){if(!this.tooltip)return;let s=`<strong>${e.data.name}</strong><br/>`;s+=`Type: ${e.data.type}<br/>`,e.data.complexity&&(s+=`Complexity: ${e.data.complexity}<br/>`),e.data.line&&(s+=`Line: ${e.data.line}<br/>`),e.data.docstring&&(s+=`<em>${e.data.docstring.substring(0,100)}...</em>`),this.tooltip.transition().duration(200).style("opacity",.9),this.tooltip.html(s).style("left",t.pageX+10+"px").style("top",t.pageY-28+"px")}hideTooltip(){this.tooltip&&this.tooltip.transition().duration(500).style("opacity",0)}getNodeColor(t){return{module:"#8b5cf6",file:"#6366f1",class:"#3b82f6",function:"#f59e0b",method:"#10b981"}[t]||"#718096"}getNodeIcon(t){return{module:"📦",file:"📄",class:"🏛️",function:"⚡",method:"🔧"}[t]||"📌"}getComplexityLevel(t){return t<=5?"low":t<=10?"medium":"high"}expandAll(){this.expand(this.root),this.update(this.root)}expand(t){t._children&&(t.children=t._children,t._children=null),t.children&&t.children.forEach(t=>this.expand(t))}collapseAll(){this.collapse(this.root),this.update(this.root)}collapse(t){t.children&&(t._children=t.children,t.children.forEach(t=>this.collapse(t)),t.children=null)}resetZoom(){this.svg&&this.svg.transition().duration(750).call(d3.zoom().transform,d3.zoomIdentity)}toggleLegend(){const t=document.getElementById("tree-legend");t&&("none"===t.style.display?t.style.display="block":t.style.display="none")}filterByLanguage(){console.log("Filtering by language:",this.languageFilter),this.update(this.root)}highlightSearchResults(){this.treeGroup&&(this.treeGroup.selectAll(".code-node").classed("highlighted",!1),this.searchTerm&&this.treeGroup.selectAll(".code-node").each((t,e,s)=>{t.data.name.toLowerCase().includes(this.searchTerm)&&d3.select(s[e]).classed("highlighted",!0)}))}}"undefined"!=typeof window&&(window.CodeTree=t,document.addEventListener("DOMContentLoaded",()=>{const e=new t;window.codeTree=e,document.querySelectorAll(".tab-button").forEach(t=>{t.addEventListener("click",()=>{"code"===t.getAttribute("data-tab")&&(console.log("Code tab activated, initializing tree..."),e.renderWhenVisible())})})}));
//# sourceMappingURL=code-tree.js.map
