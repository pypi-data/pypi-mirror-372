!function(){var a,t,m,s;(PowerPack=window.PowerPack?PowerPack:{}).Admin={},PowerPack.Admin.LicenseType={UNLICENSED:0,TRIAL:1,PURCHASED:2},PowerPack.Admin.LicenseUpdateState={CHECKING:"checking",HAS_LATEST:"has-latest",APPLYING:"applying",APPLIED:"applied",ERROR_CHECKING:"error",ERROR_APPLYING:"error"},a=PowerPack.Admin.LicenseType,t=PowerPack.Admin.LicenseUpdateState,PowerPack.Admin.License=Backbone.Model.extend({defaults:{applyLicenseURL:null,company:null,expirationDate:null,expired:!1,features:null,hardExpired:!1,hardExpirationDate:null,hasUserCap:!1,inPerpetualUserMode:!1,installKey:null,licenseType:a.UNLICENSED,updateRequestPayload:null,updateState:null,userCap:0,userCount:0},getSummary:function(){var e=this.get("licenseType"),t=e===a.UNLICENSED?gettext("Power Pack needs a license"):(t=this.get("expired"),t=e===a.TRIAL?t?gettext("Expired trial license for %s"):gettext("Active trial license for %s"):t?gettext("Expired license for %s"):gettext("Active license for %s"),interpolate(t,[this.get("company")]));return t},expiresSoon:function(){var e=this.get("licenseType");return e===a.UNLICENSED||(e=e===a.TRIAL?10:30,moment(this.get("expirationDate")).diff(moment(),"days")<=e)},getManageURL:function(){return"https://www.reviewboard.org/licenses/powerpack/"+this.get("installKey")+"/"},getRenewURL:function(){return this.getManageURL()+"renewals/"},checkForUpdates:function(){this.set("updateState",t.CHECKING),$.ajax({method:"POST",url:"https://www.reviewboard.org/licenses/powerpack/"+this.get("installKey")+"/download/",data:{license_request:this.get("updateRequestPayload")},success:_.bind(function(e){e&&void 0!==e.has_latest&&(e.has_latest?this.set("updateState",t.HAS_LATEST):this._applyLicenseUpdate(e.license_data))},this),error:_.bind(function(e){console.error("Error checking for Power Pack license: payload=%o",e),this.set("updateState",t.ERROR_CHECKING)},this)})},parse:function(e){return e.expirationDate&&(e.expirationDate=new Date(e.expirationDate+"+00:00")),e.hardExpirationDate&&(e.hardExpirationDate=new Date(e.hardExpirationDate+"+00:00")),e.licenseType=PowerPack.Admin.LicenseType[e.licenseType],e},_applyLicenseUpdate:function(e){this.set("updateState",t.APPLYING),$.ajax({method:"POST",url:this.get("applyLicenseURL"),data:{"license-data":e},dataType:"json",success:_.bind(function(e){this.set(e,this.parse(e)),this.set("updateState",t.APPLIED)},this),error:_.bind(function(e){console.error("Error applying Power Pack license: payload=%o",e),this.set("updateState",t.ERROR_APPLYING)},this)})}}),PowerPack.Admin.AutoAddLicensedUsersView=Backbone.View.extend({events:{"change .powerpack-auto-add-mode input[type=radio]":"_updateState"},render:function(){return this._$modes=this.$(".powerpack-auto-add-mode input[type=radio]"),this._$groupFields=this.$(".powerpack-auto-add-groups").find("select, input"),this._updateState(),this},_updateState:function(){var e=this._$modes.filter(":checked");this._$groupFields.prop("disabled","groups"!==e.val())}}),m=PowerPack.Admin.LicenseType,s=PowerPack.Admin.LicenseUpdateState,PowerPack.Admin.ConfigurePowerPackView=Backbone.View.extend({events:{"change #field-license-file":"_onLicenseUploaded"},GET_TRIAL_LICENSE_TEXT:gettext("Try it free for 60 days"),MANAGE_LICENSE_TEXT:gettext("Manage your license"),PURCHASE_LICENSE_TEXT:gettext("Purchase a license"),UPLOAD_LICENSE_TEXT:gettext("Upload a new license file"),RENEW_PURCHASED_TEXT:gettext("Renew your license"),RENEW_TRIAL_TEXT:gettext("Request a new trial"),licenseInfoTemplate:_.template(["<div>",' <div id="powerpack-license-info-header">','  <h3 class="powerpack-license-info-summary"><%- summaryText %></h3>',"  <% if (noticeHTML) { %>",'   <div class="powerpack-license-info-notice"><%= noticeHTML %></div>',"  <% } %>",'  <div id="powerpack-license-update-state"></div>'," </div>",' <div class="powerpack-license-buttons">',"  <% _.each(buttons, function(buttonInfo) { %>",'   <a class="btn primary" role="button" href="<%- buttonInfo.url %>">',"    <%- buttonInfo.text %>","   </a>","  <% }) %>",'  <label class="btn primary" id="powerpack-upload-license-button"','         role="button"','         for="field-license-file">',"   <%- uploadLicenseText %>","  </label>"," </div>"," <ul>","  <% if (isLicensed) { %>",'   <li id="powerpack-license-info-expiration">',"    <div>","     <p><%= expirationHTML %></p>","     <% if (perpetualUserModeText) { %>","      <p><%= perpetualUserModeText %></p>","     <% } %>","    </div>","   </li>","  <% } %>","  <% if (userCap) { %>",'   <li id="powerpack-license-info-users">',"    <div>","     <%- assignedUsersText %>","     <% if (usersWarningText) { %>",'      <div class="powerpack-users-warning">','       <span class="rb-icon rb-icon-warning"></span>',"       <%= usersWarningText %>","      </div>","     <% } %>",'     <a href="users/" class="powerpack-manage-licensed-users">',"      <%- manageUsersText %>","     </a>","    </div>","   </li>","  <% } %>"," </ul>","</div>"].join("")),featureTemplate:_.template(['<div class="powerpack-c-features__feature form-row field-<%- id %>"','     id="row-<%- id %>">',' <input type="checkbox" id="id_<%- id %>" name="<%- id %>"','        class="powerpack-c-features__feature-check"',"        <% if (disabled) { %>disabled<% } %>","        <% if (enabled) { %>checked<% } %>","        >",' <label for="id_<%- id %>"','        class="powerpack-c-features__feature-info">','  <span class="powerpack-c-features__feature-name"><%- name %></span>',"  <% if (summary) { %>",'   <p class="powerpack-c-features__feature-summary"><%- summary %></p>',"  <% } %>","  <% if (!available) { %>",'   <p class="powerpack-c-features__feature-unavailable">',"    <%- unavailableReason %>","   </p>","  <% } %>"," </label>","</div>"].join("")),uploadLicenseForm:_.template(['<form action="." method="post" enctype="multipart/form-data"','      style="display: none">',' <input type="hidden" name="csrfmiddlewaretoken"','        value="<%- csrfToken %>">',' <input id="field-license-file" name="license_file" type="file">',"</form>"].join("")),initialize:function(e){this.csrfToken=e.csrfToken,this.features=e.features,this.license=e.license,this.purchaseLicenseURL=e.purchaseLicenseURL,this.trialLicenseURL=e.trialLicenseURL,this._$features=null,this._$licenseInfoDetails=null,this._$saveButton=null,this._$updateState=null,this._$uploadForm=null,this._$uploadLicenseButton=null},render:function(){return this._$uploadForm=$(this.uploadLicenseForm({csrfToken:this.csrfToken})),this.$el.append(this._$uploadForm),this._$featuresContainer=$("#powerpack-features-info-container"),this._$features=this._$featuresContainer.children(".powerpack-c-features"),this._$licenseInfoDetails=$("#powerpack-license-info"),this._$saveButton=$("#powerpack-save-button"),this._showLicenseDetails(),this.listenTo(this.license,"change:updateState",this._onUpdateStateChanged),this.license.checkForUpdates(),this},_showLicenseDetails:function(){var e,t,a,s,i,n,r,o=this.license,c=o.get("features"),l=o.get("licenseType"),u=o.get("expired"),p=o.get("userCap"),d=o.get("userCount"),h=o.get("numPerpetualUsers"),f=l!==m.UNLICENSED;for(f?(u?(s=gettext('Expired <time class="timesince" datetime="%(timestamp)s"></time> on %(date)s'),o.get("hardExpired")||(i=interpolate(gettext('Your grace period is now active. Unless renewed, Power Pack will be disabled <time class="timesince" datetime="%s"></time>.'),[moment(o.get("hardExpirationDate")).format()]))):(e=o.expiresSoon(),s=gettext('Expires <time class="timesince" datetime="%(timestamp)s"></time> on %(date)s'),e&&(i=l===m.TRIAL?interpolate(gettext('Your license expires soon! Make sure to <a href="%s">purchase a license</a> before the expiration date.'),[this.purchaseLicenseURL]):interpolate(gettext('Your license expires soon! Make sure to <a href="%s">renew your license</a> before the expiration date.'),[o.getRenewURL()]))),e=moment(o.get("expirationDate")),s=interpolate(s,{date:e.format("MMM. DD, YYYY, h:m A"),timestamp:e.format()},!0),o.get("inPerpetualUserMode")&&(i=interpolate(gettext("Your license has expired, but you can still use Power Pack for free for up to %s users!"),[h]))):i=interpolate(gettext("Some features can be used for free for up to %s users. Purchase a license to gain full access to Power Pack."),[h]),0===p?t=gettext("Unlimited seats available"):(t=interpolate(gettext("%(userCount)s out of %(userCap)s users assigned"),{userCap:p,userCount:d},!0),0===d?a=gettext("Power Pack is enabled, but there are no assigned users."):d===p&&(a=f&&l===m.PURCHASED?interpolate(gettext('You\'ve hit the maximum number of assigned users. You can <a href="%s">upgrade your license</a> to add more.'),[o.getManageURL()]):interpolate(gettext('You\'ve hit the maximum number of assigned users. You can <a href="%s">purchase a license</a> to add more.'),[this.purchaseLicenseURL]))),e=!f||u?"bad":a||o.expiresSoon()?"warning":"good",this._$licenseInfoDetails.html(this.licenseInfoTemplate({assignedUsersText:t,buttons:this._buildLicenseButtons(),expirationHTML:s,isLicensed:f,manageUsersText:gettext("Manage users"),noticeHTML:i,perpetualUserModeText:void 0,summaryText:o.getSummary(),uploadLicenseText:this.UPLOAD_LICENSE_TEXT,userCap:p,userCount:d,usersWarningText:a})).attr("class","powerpack-license-status-"+e).find(".timesince").timesince(),this._$features.empty(),r=0;r<this.features.length;r++)n=this.features[r],this._$features.append(this.featureTemplate({available:n.available,disabled:!n.available||n.always_enabled,enabled:!!c[n.id],id:n.id,name:n.name,summary:n.summary,unavailableReason:n.unavailable_reason}));this._$featuresContainer.show(),this._$saveButton.show(),this._$updateState=$("#powerpack-license-update-state"),this._$uploadLicenseButton=$("#powerpack-upload-license-button")},_buildLicenseButtons:function(){var e=this.license,t=e.get("licenseType"),a=e.get("expired"),t=t===m.UNLICENSED?[{text:this.GET_TRIAL_LICENSE_TEXT,url:this.trialLicenseURL},{text:this.PURCHASE_LICENSE_TEXT,url:this.purchaseLicenseURL}]:t===m.TRIAL?a?[{text:this.RENEW_TRIAL_TEXT,url:e.getRenewURL()},{text:this.PURCHASE_LICENSE_TEXT,url:this.purchaseLicenseURL}]:[{text:this.PURCHASE_LICENSE_TEXT,url:this.purchaseLicenseURL}]:a?[{text:this.RENEW_PURCHASED_TEXT,url:e.getRenewURL()}]:[{text:this.MANAGE_LICENSE_TEXT,url:e.getManageURL()}];return t},_onLicenseUploaded:function(){this._$uploadLicenseButton.empty().text(gettext("Uploading license file...")).prepend($('<span class="fa fa-spinner fa-spin">')),this._$uploadForm.submit()},_onUpdateStateChanged:function(){var e,t=this.license.get("updateState");t===s.CHECKING?e=gettext("Checking for updates..."):t===s.HAS_LATEST?e=gettext("Your license is up-to-date."):t===s.APPLYING?e=gettext("Applying license update..."):t===s.APPLIED?(e=gettext("Your license has been automatically updated."),this._showLicenseDetails()):t===s.ERROR_CHECKING?e=gettext("An error occurred when trying to check for license updates. Please contact support."):t===s.ERROR_APPLYING&&(e=gettext("An error occurred when trying to update to a new license. Please contact support.")),e&&this._$updateState.text(e)}}),PowerPack.Admin.ImportLicensedUsersView=Backbone.View.extend({events:{"change #id_source input[type=radio]":"_updateState"},render:function(){return this._$radios=this.$("#id_source input[type=radio]"),this._$groups=this.$("#id_group"),this._$importButton=this.$("#powerpack_import_users"),this._updateState(),this},_updateState:function(){var e=this._$radios.filter(":checked");this._$importButton.prop("disabled",0===e.length),this._$groups.prop("disabled","group"!==e.val())}}),PowerPack.Admin.ManageLicensedUsersView=Backbone.View.extend({events:{"change #powerpack_users input[type=checkbox]":"_onCheckboxesChanged","click #powerpack_users input[type=checkbox]":"_onCheckboxesClicked"},initialize:function(){this._$checkboxes=null,this._$removeButton=null,this._lastChecked=null},render:function(){return this._$checkboxes=this.$("#powerpack_users input[type=checkbox]"),this._$removeButton=this.$("#powerpack_remove_users"),this.$("#id_users").rbautocomplete({url:SITE_ROOT+"api/users/",matchCase:!1,multiple:!0,width:350,extraParams:{fullname:1},parse:function(e){for(var t,a=e.users,s=[],i=0;i<a.length;i++)t=a[i],s.push({data:t,value:t.username,result:t.username});return s},formatItem:function(e){var t=e.username;return e.fullname&&(t+=" <span>("+_.escape(e.fullname)+")</span>"),t},cmp:function(e,t,a){var s=t.data.username,a=a.data.username,i=t.data.fullname,t=t.data.fullname;return 0===s.indexOf(e)?0===a.indexOf(e)?s.localeCompare(a):-1:0===a.indexOf(e)?1:i.localeCompare(t)},error:function(t){var a;try{a=$.parseJSON(t.responseText).err.msg}catch(e){a="HTTP "+t.status+" "+t.statusText}alert(a)}}).on("autocompleteshow",function(){var e=$(".ui-autocomplete-results:not(:has(.ui-autocomplete-footer))");0<e.length&&$("<div/>").addClass("ui-autocomplete-footer").text(gettext("Press Tab to auto-complete.")).appendTo(e)}),this},_onCheckboxesChanged:function(){var e=this._$checkboxes.filter(":checked").length;this._$removeButton.prop("disabled",0===e)},_onCheckboxesClicked:function(e){var t,a;this._lastChecked&&e.shiftKey&&(t=this._$checkboxes.index(e.target),a=this._$checkboxes.index(this._lastChecked),this._$checkboxes.slice(Math.min(t,a),Math.max(t,a)+1).prop("checked",this._lastChecked.checked)),this._lastChecked=e.target}})}.call(this);
