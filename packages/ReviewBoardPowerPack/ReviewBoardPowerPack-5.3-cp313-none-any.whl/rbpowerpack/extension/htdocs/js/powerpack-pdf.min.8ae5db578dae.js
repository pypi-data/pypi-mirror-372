!function(){var t,i,n,o;window.PowerPack=window.PowerPack||{},PowerPack.Utils={spaceless:function(e){for(var t=0;t<e.length;t++)e[t]=e[t].trim();return e.join("")}},PowerPack.PDF={},PowerPack.PDF.PDF=Backbone.Model.extend({defaults:{currentPage:null,numPages:null,outlineMap:null,pdfURL:"",pdfDocument:null},initialize:function(){var t=this,e={isEvalSupported:!1,url:this.get("pdfURL")};pdfjsLib.getDocument(e).promise.then(function(e){t.set({currentPage:1,numPages:e.numPages,pdfDocument:e}),t._initializeNavigationMap(e)})},getDocument:function(){var n=this;return new Promise(function(i,e){var t=n.get("pdfDocument");null!==t?i(t):n.once("change:pdfDocument",function(e,t){return i(t)})})},getPage:function(t){return this.getDocument().then(function(e){return e.getPage(t)})},_initializeNavigationMap:function(e){for(var l=this,o=e.numPages,t=[],i=1;i<=o;i++)t.push(e.getPage(i));var n=Promise.all(t),s=(n.then(function(e){console.assert(e.length===o);for(var t={},i=0;i<o;i++){var n=e[i].ref;t["".concat(n.gen,"@").concat(n.num)]=i+1}l._pageMap=t}),e.getOutline()),a=e.getDestinations();Promise.all([n,a,s]).then(function(e){var a=e[1],e=e[2];l.set("outlineMap",e&&function e(t){for(var i=[],n=0;n<t.length;n++){var o=t[n].dest,s=void 0;void 0===o?console.warn("Could not find destination for outline item "+t[n].title):(void 0!==a[o]?s=a[o]:o instanceof Object&&(s=o),void 0===s?console.warn("Could not find destination for outline item "+t[n].title):(o=s[0],s="".concat(o.gen,"@").concat(o.num),i.push({title:t[n].title,page:l._pageMap[s],children:e(t[n].items)})))}return i}(e)||[])})}}),PowerPack.PDF.RegionCommentBlock=RB.RegionCommentBlock.extend({defaults:_.defaults({onDiffOrigFile:!1,page:null,scale:null,thumbnailData:null},RB.RegionCommentBlock.prototype.defaults),serializedFields:RB.RegionCommentBlock.prototype.serializedFields.concat(["onDiffOrigFile","page","thumbnailData"]),parse:function(e){return _.extend(RB.RegionCommentBlock.prototype.parse.call(this,e),{onDiffOrigFile:e.onDiffOrigFile,page:parseInt(e.page,10)||void 0})},saveDraftCommentBounds:function(){var o=this;return new Promise(function(t,i){var n=o.get("draftComment");n.ready({ready:function(){var e=n.get("extraData");e.x=o.get("x"),e.y=o.get("y"),e.width=o.get("width"),e.height=o.get("height"),e.thumbnailData=o.get("thumbnailData"),n.save({attrs:["extra_data.x","extra_data.y","extra_data.width","extra_data.height","extra_data.thumbnailData"],boundsUpdated:!0,error:function(){i(new Error("Failed to save draft PDF comment."))},success:function(){t()}})},error:function(){i(new Error("Failed to save draft PDF comment."))}})})}}),PowerPack.PDF.Reviewable=RB.FileAttachmentReviewable.extend({defaults:_.defaults({commentBlockViews:[],diffAgainstPDF:null,diffAgainstPDFURL:"",diffData:[],diffURL:"",navDiffIcon:"",navMenuIcon:"",navOutlineIcon:"",navThumbnailIcon:"",pageDownIcon:"",pageUpIcon:"",pageZoomInIcon:"",pageZoomOutIcon:"",pdf:null,pdfURL:null,scale:1,scrollLock:!0,workerURL:null},RB.FileAttachmentReviewable.prototype.defaults),commentBlockModel:PowerPack.PDF.RegionCommentBlock,initialize:function(e,t){RB.FileAttachmentReviewable.prototype.initialize.call(this,e,t),console.assert(void 0!==pdfjsLib.GlobalWorkerOptions.workerSrc,"Unable to find the pdf.js workerSrc attribute."),pdfjsLib.GlobalWorkerOptions.workerSrc=e.workerURL,this.set("pdf",new PowerPack.PDF.PDF({pdfURL:e.pdfURL})),e.diffAgainstPDFURL&&this.set("diffAgainstPDF",new PowerPack.PDF.PDF({pdfURL:e.diffAgainstPDFURL}))}}),PowerPack.PDF.Sidebar=Backbone.Model.extend({defaults:function(){return{availableModes:[PowerPack.PDF.Sidebar.MODE_THUMBNAILS],mode:PowerPack.PDF.Sidebar.MODE_THUMBNAILS,reviewable:null,visible:!1}},initialize:function(){var e=this.get("reviewable").get("pdf");this._modeIsDefault=!0,this.on("change:mode",function(e,t){this._modeIsDefault=!1},this),this.listenTo(e,"change:outlineMap",this._onOutlineChanged),this._onOutlineChanged()},_onOutlineChanged:function(){var e=[PowerPack.PDF.Sidebar.MODE_THUMBNAILS],t=this.get("reviewable").get("pdf").get("outlineMap");t&&0<t.length&&(e.push(PowerPack.PDF.Sidebar.MODE_OUTLINE),this._modeIsDefault)&&this.set("mode",PowerPack.PDF.Sidebar.MODE_OUTLINE),this.get("reviewable").get("diffAgainstPDF")&&e.push(PowerPack.PDF.Sidebar.MODE_DIFFS),this.set("availableModes",e)}},{MODE_COMMENTS:"comments",MODE_DIFFS:"diffs",MODE_OUTLINE:"outline",MODE_THUMBNAILS:"thumbnails"}),PowerPack.PDF.PageControlsView=Backbone.View.extend({className:"page-controls",events:{"change .pdf-page-curr":"_onChangePage","click #powerpack-pdf-page-prev":"_onPrevPageClicked","click #powerpack-pdf-page-next":"_onNextPageClicked"},template:_.template('<div class="pdf-page-info">\n <%- pageText %>:\n <input type="number" class="pdf-page-curr" min="1" />\n <%- ofText %>\n <span class="pdf-page-total"></span>\n</div>\n<button type="button"\n        class="powerpack-c-pdf-controls-button"\n        id="powerpack-pdf-page-prev"\n        tabindex="0"\n        aria-label="<%- prevPageText %>"\n        aria-pressed="false"\n        title="<%- prevPageText %>">\n <span class="rb-c-button__icon" aria-hidden="true"/>\n</button>\n<button type="button"\n        class="powerpack-c-pdf-controls-button"\n        id="powerpack-pdf-page-next"\n        tabindex="0"\n        aria-label="<%- nextPageText %>"\n        aria-pressed="false"\n        title="<%- nextPageText %>">\n <span class="rb-c-button__icon" aria-hidden="true"/>\n</button>'),initialize:function(e){this._pageDownIcon=e.pageDownIcon,this._pageUpIcon=e.pageUpIcon,this._$currentPage=null,this._$totalPages=null},render:function(){var t,e=this.$el,i=this.model,n=(e.html(this.template({pageText:gettext("Page"),ofText:gettext("of"),prevPageText:gettext("Previous page"),nextPageText:gettext("Next page")})),this.$("#powerpack-pdf-page-next").children(".rb-c-button__icon").css({"mask-image":"url(".concat(this._pageDownIcon,")")}),this.$("#powerpack-pdf-page-prev").children(".rb-c-button__icon").css({"mask-image":"url(".concat(this._pageUpIcon,")")}),i.get("pdf")),o=i.get("diffAgainstPDF");return this._$currentPage=this.$(".pdf-page-curr").bindProperty("value",n,"currentPage").bindProperty("max",n,"numPages"),this._$totalPages=this.$(".pdf-page-total").bindProperty("text",n,"numPages"),o&&(t=$('<input type="checkbox" id="pdf-scroll-lock">').appendTo(e),$('<label for="pdf-scroll-lock" id="pdf-scroll-lock-label">').text(gettext("Lock scroll")).appendTo(e),t.on("change",function(e){i.set("scrollLock",t.is(":checked"))}),t.prop("checked",!0)),this},_onChangePage:function(){var e=this.model.get("pdf"),t=this._$currentPage.val();0<t&&t<=e.get("numPages")?e.set("currentPage",t):this._$currentPage.val(this.model.get("currentPage"))},_onPrevPageClicked:function(){var e=this.model.get("pdf"),t=e.get("currentPage");1<t&&e.set("currentPage",t-1)},_onNextPageClicked:function(){var e=this.model.get("pdf"),t=e.get("currentPage");t<e.get("numPages")&&e.set("currentPage",t+1)}}),PowerPack.PDF.PageRendererView=Backbone.View.extend({initialize:function(e){this._renderBusy=!1,this._scheduledRenders=[],this.pdf=e.pdf},scheduleRender:function(e,t){t=_.defaults({page:e},t);if(t.highestPriority){if(e.inRenderQueue)for(var i=0;i<this._scheduledRenders.length;i++)if(this._scheduledRenders[i].page===e){this._scheduledRenders.splice(i,1);break}this._scheduledRenders.unshift(t)}else e.inRenderQueue||this._scheduledRenders.push(t);e.inRenderQueue=!0,this._processNextRender()},_processNextRender:_.throttle(function(){var t=this;this._renderBusy||_.defer(function(){var e;0===t._scheduledRenders.length?t.trigger("renderQueueEmpty"):(e=t._scheduledRenders.shift(),t._renderPage(e,{success:function(){e.page.inRenderQueue=!1,t._processNextRender()}}))})},10),_renderPage:function(n){var o=this,l=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=n.page;r.rendered?_.isFunction(l.success)&&l.success():(this._renderBusy=!0,this.pdf.getPage(r.pageNum).then(function(e){var t=window.devicePixelRatio,i=e.getViewport({scale:1}).width,i=(n.fitToWidth?r.$el.width()/i:o.model.get("scale"))*t,s=e.getViewport({scale:i}),i={width:s.width,height:s.height},t={width:Math.round(s.width/t)+"px",height:Math.round(s.height/t)+"px"},a=(r.resize(t,i),r.rendered=!0,r.$canvas[0].getContext("2d",{willReadFrequently:!0}));e.render({canvasContext:a,viewport:s}).promise.then(function(){r.diffRegions&&r.diffRegions.forEach(function(e){var t;if("insert"===e.op)t="#dfffd7";else{if("delete"!==e.op)return;t="#ffe0e5"}var i=e.bbox[0]*s.scale,n=(e.bbox[2]-e.bbox[0])*s.scale,o=(e.bbox[3]-e.bbox[1])*s.scale,e=s.height-e.bbox[1]*s.scale-o;a.save(),a.globalCompositeOperation="multiply",a.fillStyle=t,a.fillRect(i,e,n,o),a.restore()})}).then(function(){o._renderBusy=!1,_.isFunction(l.success)&&l.success()}).catch(function(e){console.warning("Error while rendering pdf: "+e),o._renderBusy=!1,r.rendered=!1,_.isFunction(l.error)&&l.error(e)})}))}}),PowerPack.PDF.PagesView=Backbone.View.extend({className:"pdf-offset",events:{"mousedown .selection-container":"_onMouseDown",mouseup:"_onMouseUp",mousemove:"_onMouseMove",scroll:"_onScroll"},initialize:function(e){this.origFile=e.origFile,this._pageRenderer=e.pageRenderer,this._reviewableView=e.reviewableView,this._pdf=e.pdf,this._defaultPageNum=this._pdf.get("currentPage"),this._docReady=!1,this._rendered=!1,this._scrolling=!1,this._diffRegions=[],this.pages=[],_.bindAll(this,"_resizeAllPages","_resizePagesBatch")},render:function(){return this.$el.empty(),this._$pages=$('<div class="pdf-pages"/>').appendTo(this.$el),this.listenTo(this._pdf,"change:pdfDocument",this._renderDocument),this._renderDocument(this._pdf,this._pdf.get("pdfDocument")),this.listenTo(this._pdf,"change:currentPage",this._onCurrentPageChanged),this._onCurrentPageChanged(),this.listenTo(this.model,"change:scale",this._onZoomChanged),this},addDiffRegions:function(e){this._diffRegions=e,this._rendered&&(this.pages.forEach(function(t){t.setDiffRegions(e.filter(function(e){return e.page===t.pageNum-1}))}),this._renderHighestPriorityPage())},isCommentDialogVisible:function(){var e=this._reviewableView.commentDlg;return e&&!e.$el.is(":hidden")},_renderDocument:function(n,e){var o=this;if(null!==e){for(var t=e.numPages,s=window.devicePixelRatio,a=this.model.get("scale"),i=0;i<t;i++)(t=>{var e=new PowerPack.PDF.PageView({diffRegions:o._diffRegions.filter(function(e){return e.page===t}),pageNum:t+1,pagesView:o});e.render().$el.appendTo(o._$pages),o.pages.push(e)})(i);return n.getPage(1).then(function(e){var e=e.getViewport({scale:a*s}),t={width:e.width,height:e.height},i={width:Math.round(e.width/s)+"px",height:Math.round(e.height/s)+"px"};o.pages.forEach(function(e){return e.resize(i,t)}),o._defaultPageNum&&n.set("currentPage",o._defaultPageNum)}),this.model.get("commentBlockViews").forEach(function(e){e.model.get("onDiffOrigFile")===o.origFile&&o.placeCommentBlockView(e.model.get("page"),e)}),this._renderHighestPriorityPage(),this._rendered=!0,this}},placeCommentBlockView:function(e,t){console.assert(e<=this.pages.length),this.pages[e-1].placeCommentBlockView(t)},_renderHighestPriorityPage:function(){var e=this._getVisiblePages(),t=_.find(e,function(e){return!e.page.rendered}),i=void 0;void 0!==(i=void 0===(i=void 0!==t?t.index:i)&&0<e.length&&(0<=(t=e[0].index-1)&&!this.pages[t].rendered&&(i=t),t=e[e.length-1].index+1,void 0===i)&&t<this.pages.length&&!this.pages[t].rendered?e[e.length-1].index+1:i)&&(this.listenToOnce(this._pageRenderer,"renderQueueEmpty",this._renderHighestPriorityPage),this._pageRenderer.scheduleRender(this.pages[i],{highestPriority:!0}))},_getVisiblePages:function(){for(var e=this.el.scrollTop,t=e+this.el.clientHeight,i=[],n=0;n<this.pages.length;n++){var o=this.pages[n],s=o.getBoundsVisibility(e,t);if(!s.aboveBounds){if(s.belowBounds)break;i.push({page:o,index:n})}}return i},_getFirstVisiblePage:function(){for(var e=this.el.scrollTop,t=0;t<this.pages.length;t++){var i=this.pages[t],n=i.el;if(n.offsetTop+n.offsetHeight>=e)return i}return null},_onMouseDown:function(e){var t=$(e.target),i=t.parents(".pdf-page");if(1===e.which&&!this.isCommentDialogVisible()&&!t.hasClass("selection-flag"))return t=this.pages[i.data("pageIx")],this._activeSelection=t.beginSelection(e),!1},_onMouseUp:function(e){if(!this._activeSelection)return!0;!this.isCommentDialogVisible()&&this._activeSelection.isValid()&&(e.stopPropagation(),e=this._activeSelection.finish(e),(this._activeSelection=null)!==e)&&this.trigger("commentRegionCreated",e)},_onMouseMove:function(e){return!this._activeSelection||(!this.isCommentDialogVisible()&&this._activeSelection.isValid()?(this._activeSelection.update(e),!1):void 0)},_onScroll:function(e){for(var t=this.el.scrollTop,i=t+this.el.clientHeight,n=-1,o=0,s=0;s<this.pages.length;s++){var a=this.pages[s].getBoundsVisibility(t,i);!a.aboveBounds&&!a.belowBounds&&a.overlapSize>o&&(o=a.overlapSize,n=s)}console.assert(0<=n),this._scrolling=!0,this._pdf.set("currentPage",n+1),this._scrolling=!1,this._renderHighestPriorityPage()},_onCurrentPageChanged:function(){var e=this._pdf.get("currentPage");0===this.pages.length||this._scrolling||(console.assert(1<=e),console.assert(e<=this.pages.length),this.$el.scrollTop(this.pages[e-1].$el.position().top))},_onZoomChanged:function(){for(var n,o,s,a=this,e=this.model.get("commentBlockViews"),i=this.model.get("scale"),l=this._getFirstVisiblePage(),t=0;t<e.length;t++)e[t].model.set("scale",i);this._pdf.getPage(l.pageNum).then(function(e){var t=a.model.previous("scale"),t=e.getViewport({scale:t}),i=l.$canvas.position();o=a.el.scrollTop-i.top,s=t.convertToPdfPoint(a.el.scrollLeft-i.left,o),s=[Math.round(s[0]),Math.round(s[1])],n=e}).then(this._resizeAllPages).then(function(){var e=l.$canvas.position(),t=n.getViewport({scale:i}).convertToViewportPoint(s[0],s[1]);a.el.scrollLeft=e.left+t[0],a.el.scrollTop=e.top+(o<0?o:t[1]),a._renderHighestPriorityPage()})},_resizeAllPages:function(){for(var e={},t=0;t<this.pages.length;t++){var i=this.pages[t],n=i.$el.width()+"x"+i.$el.height();i.rendered=!1,e[n]?e[n].push(i):e[n]=[i]}return Promise.all(_.map(e,this._resizePagesBatch))},_resizePagesBatch:function(n){var o=this.model.get("scale"),s=window.devicePixelRatio;return this._pdf.getPage(n[0].pageNum).then(function(e){for(var e=e.getViewport({scale:o*s}),t={width:Math.round(e.width/s)+"px",height:Math.round(e.height/s)+"px"},i=0;i<n.length;i++)n[i].resize(t)})}}),PowerPack.PDF.RenderablePageView=Backbone.View.extend({initialize:function(e){this.pageNum=e.pageNum,this.$canvas=null,this.inRenderQueue=!1,this.rendered=!1},render:function(){return this.$canvas=$("<canvas/>"),this},resize:function(e,t){t&&this.$canvas.attr(t),this.$canvas.css(e),this.$el.css(e)}}),PowerPack.PDF.PageView=PowerPack.PDF.RenderablePageView.extend({className:"pdf-page",events:{"mousedown .selection-container":"_onMouseDown",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave"},SELECTION_CLICK_EPSILON:5,initialize:function(e){PowerPack.PDF.RenderablePageView.prototype.initialize.call(this,e),this.diffRegions=e.diffRegions,this.pagesView=e.pagesView,this._$selectionContainer=null,this._$selectionRect=null},setDiffRegions:function(e){this.diffRegions=e,this.rendered=!1},render:function(){return PowerPack.PDF.RenderablePageView.prototype.render.call(this),this.$el.empty().data("pageIx",this.pageNum-1).attr("id","pdf-page-"+this.pageNum),this._$selectionRect=$("<div/>").addClass("selection-rect").proxyTouchEvents().hide(),this._$selectionContainer=$("<div/>").addClass("selection-container").proxyTouchEvents().hide().append(this._$selectionRect).appendTo(this.$el),this.$canvas.addClass("pdf-canvas").appendTo(this.$el),this},resize:function(e,t){PowerPack.PDF.RenderablePageView.prototype.resize.call(this,e,t),this._$selectionContainer.css(e)},getBoundsVisibility:function(e,t){var i=this.el.offsetTop,n=i+this.el.offsetHeight,o=Math.max(i,e);return{aboveBounds:n<e,belowBounds:t<i,overlapSize:Math.min(n,t)-o}},placeCommentBlockView:function(e){e&&(e._pageView=this),this._$selectionContainer.append(e.$el),e.setSelectionRegionSizeFunc&&e.setSelectionRegionSizeFunc(this._getSelectionRegionSize.bind(this))},beginSelection:function(e){var t=this,i=this.$el.offset(),n=e.pageX-Math.floor(i.left)-1,o=e.pageY-Math.floor(i.top)-1;return this._$selectionRect.move(n,o).width(1).height(1).show(),{isValid:function(){return t._$selectionRect.is(":visible")},update:function(e){return t._updateSelection(e,n,o)},finish:this._finishSelection.bind(this)}},_buildCommentThumbnail:function(e,t,i,n){var o=window.devicePixelRatio,s=this.$canvas[0].getContext("2d"),i=Math.floor(i*o),n=Math.floor(n*o),o=(e=Math.floor(e*o),t=Math.floor(t*o),s.getImageData(e,t,i,n)),s=$("<canvas>").attr({width:i,height:n})[0];return s.getContext("2d").putImageData(o,0,0),s.toDataURL()},_updateSelection:function(e,t,i){var n=this.$el,o=n.offset(),s=Math.floor(o.left)-1,o=Math.floor(o.top)-1,a=Math.floor(n.innerWidth()),n=Math.floor(n.innerHeight()),s=Math.min(Math.max(e.pageX-s,0),a-2),a=Math.min(Math.max(e.pageY-o,0),n-2);this._$selectionRect.css(t<=s?{left:t,width:s-t}:{left:s,width:t-s}).css(i<=a?{top:i,height:a-i}:{top:a,height:i-a})},_finishSelection:function(){var e,t,i=this._$selectionRect,n=i.width(),o=i.height(),s=i.position();return i.hide(),n<=this.SELECTION_CLICK_EPSILON||o<=this.SELECTION_CLICK_EPSILON?null:(i=s.left,s=s.top,e=this.pagesView.model.get("scale"),t=this._buildCommentThumbnail(i,s,n,o),{x:Math.floor(i/e),y:Math.floor(s/e),width:Math.round(n/e),height:Math.round(o/e),onDiffOrigFile:this.pagesView.origFile,page:this.pageNum,thumbnailData:t})},_getSelectionRegionSize:function(){var e=this._$selectionContainer,t=e.position();return t.left+=e.getExtents("m","l"),{left:t.left,top:t.top,width:e.width(),height:e.height()}},_onMouseEnter:function(){this._$selectionContainer.show()},_onMouseLeave:function(){this._$selectionRect.is(":hidden")&&!this.pagesView.isCommentDialogVisible()&&this._$selectionContainer.hide()}}),PowerPack.PDF.SidebarModeView=Backbone.View.extend({setVisible:function(e){this.$el.toggle(e)}}),t=Backbone.Model.extend({defaults:_.defaults({children:null,text:"",page:null}),parse:function(e){return{text:e.title,page:e.page,children:new i(e.children,{parse:!0})}}}),i=Backbone.Collection.extend({model:t,initialize:function(e){e=e.map(function(e){return new t(e,{parse:!0})}),Backbone.Collection.prototype.initialize.call(this,e)}}),n=Backbone.View.extend({tagName:"li",initialize:function(){this._childViews=this.model.get("children").map(function(e){return new n({model:e})})},render:function(){var t=this;return this._$disclosure=$("<div/>").addClass("disclosure").appendTo(this.el).click(this._toggleDisclosure.bind(this)),this._disclosed=!1,$("<div/>").addClass("page-link").text(this.model.get("text")).data("page",this.model.get("page")).appendTo(this.el),this._childViews.length&&(this._$ul=$("<ul/>").appendTo(this.el),this._childViews.forEach(function(e){return t._$ul.append(e.render().el)}),this._$disclosure.css("visibility","visible"),this._toggleDisclosure()),this},_toggleDisclosure:function(){void 0!==this._$disclosure&&(this._disclosed?(this._disclosed=!1,this._$disclosure.text("▶"),this._$ul.hide()):(this._disclosed=!0,this._$disclosure.text("▼"),this._$ul.show()))}}),PowerPack.PDF.SidebarModeOutlineView=PowerPack.PDF.SidebarModeView.extend({tagName:"ul",events:{"click .page-link":"_onItemClicked"},initialize:function(){this._collection=null,this._childViews=[]},render:function(){var e=this.model.get("reviewable").get("pdf");return this.stopListening(e),this.listenTo(e,"change:outlineMap",this._buildOutlineViews),this._buildOutlineViews(),this},_buildOutlineViews:function(){var t=this,e=this.model.get("reviewable").get("pdf");this._childViews.forEach(function(e){return e.remove()}),this._collection=new i(e.get("outlineMap")||[],{parse:!0}),this._childViews=[],this._collection.each(function(e){e=new n({model:e});t.$el.append(e.render().el),t._childViews.push(e)})},_onItemClicked:function(e){e=$(e.target).data("page");null!==e&&this.model.get("reviewable").get("pdf").set("currentPage",e)}}),PowerPack.PDF.SidebarControlsView=Backbone.View.extend({className:"pdf-controls-sidebar",events:{"click #powerpack-pdf-toggle-sidebar":"_onToggleSidebarClicked"},buttonTemplate:_.template('<button type="button"\n        class="powerpack-c-pdf-controls-button"\n        id="<%- id %>"\n        tabindex="0"\n        aria-label="<%- label %>"\n        aria-pressed="false"\n        title="<%- label %>">\n <span class="rb-c-button__icon" aria-hidden="true"/>\n</button>'),initialize:function(e){this._navMenuIcon=e.navMenuIcon,this._$modes=null,this._$toggleSidebar=null;var t={};t[PowerPack.PDF.Sidebar.MODE_DIFFS]=e.navDiffIcon,t[PowerPack.PDF.Sidebar.MODE_OUTLINE]=e.navOutlineIcon,t[PowerPack.PDF.Sidebar.MODE_THUMBNAILS]=e.navThumbnailIcon,this._modeIcons=t},render:function(){var e=this.model,t=(this.stopListening(e),this.$el.empty(),$(this.buttonTemplate({label:gettext("Toggle the page navigation sidebar"),id:"powerpack-pdf-toggle-sidebar"})).appendTo(this.$el));return t.children(".rb-c-button__icon").css({"mask-image":"url(".concat(this._navMenuIcon,")")}),this._$toggleSidebar=t,this._$modes=$('<div class="pdf-controls-sidebar-modes">').appendTo(this.$el),this.listenTo(e,"change:availableModes",this._onAvailableModesChanged),this._onAvailableModesChanged(),this.listenTo(e,"change:visible",this._onSidebarVisibleChanged),this.listenTo(e,"change:mode",this._onModeChanged),this},_addSidebarMode:function(e){var t=this,i=$(this.buttonTemplate({label:interpolate(gettext("Switch to %(mode)s navigation"),{mode:e},!0),id:"powerpack-pdf-sidebar-mode-".concat(e)})).on("click",function(){return t.model.set("mode",e)}).appendTo(this._$modes);i.children(".rb-c-button__icon").css({"mask-image":"url(".concat(this._modeIcons[e],")")}),e===this.model.get("mode")&&i.attr({"aria-pressed":"true"})},_onToggleSidebarClicked:function(){this.model.set("visible",!this.model.get("visible"))},_onAvailableModesChanged:function(){this._$modes.empty(),_.each(this.model.get("availableModes"),this._addSidebarMode,this)},_onSidebarVisibleChanged:function(){var e=this.model.get("visible");this._$toggleSidebar.toggleClass("active",e),this._$modes.toggleClass("sidebar-open",e)},_onModeChanged:function(){var e=this.model.previous("mode"),t=this.model.get("mode");e!==t&&(this.$("#powerpack-pdf-sidebar-mode-".concat(e)).attr({"aria-pressed":"false"}),this.$("#powerpack-pdf-sidebar-mode-".concat(t)).attr({"aria-pressed":"true"}))}}),PowerPack.PDF.SidebarDiffsView=PowerPack.PDF.SidebarModeView.extend({tagName:"ul",events:{"click .page-link":"_onItemClicked"},initialize:function(){this._rendered=!1},render:function(){var a=this,e=this.model.get("reviewable"),t=e.get("diffData")||[];return this.$el.empty(),t.forEach(function(e){var t,i,n,o,s=e.op;e.content&&(i="insert"===s,t=e.page+1,n=e.syncPage+1,i=$('<li class="page-link">').addClass("pdf-nav-diffs-".concat(s)).data({leftPage:i?n:t,rightPage:i?t:n}).appendTo(a.$el),n=$('<div class="pdf-nav-diffs-diff">'),void 0!==e.movedWithinPage?o=interpolate(gettext("Moved within page %s"),[e.movedWithinPage+1]):void 0!==e.movedToPage?o=interpolate(gettext("Moved to page %s"),[e.movedToPage+1]):void 0!==e.movedFromPage&&(o=interpolate(gettext("Moved from page %s"),[e.movedFromPage+1])),o&&($('<div class="pdf-nav-diffs-moved-marker">').text(o).addClass("-is-".concat(s)).appendTo(i),n.addClass("moved").addClass("-is-".concat(s))),$("<strong>").text("".concat(t," ")).appendTo(n),$("<span>").text(e.content).appendTo(n),n.appendTo(i))}),this._rendered||(this.listenTo(e,"change:diffData",this.render),this._rendered=!0),this},_onItemClicked:function(e){var e=$(e.currentTarget),t=e.data("leftPage"),e=e.data("rightPage"),i=this.model.get("reviewable");i.get("diffAgainstPDF").set("currentPage",t),i.get("pdf").set("currentPage",e)}}),PowerPack.PDF.SidebarView=Backbone.View.extend({initialize:function(e){this._pageRenderer=e.pageRenderer,this._currentView=null,this._outlineView=null,this._thumbnailsView=null},render:function(){this.model.get("reviewable").get("pdf").get("outlineMap");return this._outlineSidebarView=this._createSidebarModeView(PowerPack.PDF.SidebarModeOutlineView,this.$(".pdf-nav-outline")),this._thumbnailsSidebarView=this._createSidebarModeView(PowerPack.PDF.SidebarModeThumbnailsView,this.$(".pdf-nav-pages"),{pageRenderer:this._pageRenderer,scrollContainer:this.el}),this._sidebarDiffsView=this._createSidebarModeView(PowerPack.PDF.SidebarDiffsView,this.$(".pdf-nav-diffs")),this.listenTo(this.model,"change:mode",this._onModeChanged),this._onModeChanged(),this},_createSidebarModeView:function(e,t){e=new e(_.defaults({model:this.model},2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}));return e.render().$el.hide().appendTo(t),e},_onModeChanged:function(){var e=this.model.get("mode");this._currentSidebarView&&(this.stopListening(this._currentSidebarView,"sidebarItemSelected"),this._currentSidebarView.setVisible(!1)),e===PowerPack.PDF.Sidebar.MODE_OUTLINE?this._currentSidebarView=this._outlineSidebarView:e===PowerPack.PDF.Sidebar.MODE_THUMBNAILS?this._currentSidebarView=this._thumbnailsSidebarView:e===PowerPack.PDF.Sidebar.MODE_DIFFS&&(this._currentSidebarView=this._sidebarDiffsView),this.listenTo(this._currentSidebarView,"sidebarItemSelected",this._onSidebarItemSelected),this._currentSidebarView.setVisible(!0)}}),o=PowerPack.PDF.RenderablePageView.extend({className:"item page-thumb",events:{"click canvas":"_onCanvasClicked"},setSelected:function(e){this.$el.toggleClass("selected",e)},render:function(e){return PowerPack.PDF.RenderablePageView.prototype.render.call(this),this.$el.data("page",this.pageNum).append(this.$canvas),e.scheduleRender(this,{fitToWidth:!0}),this},_onCanvasClicked:function(e){e.preventDefault(),e.stopPropagation(),this.$el.trigger("click")}}),PowerPack.PDF.SidebarModeThumbnailsView=PowerPack.PDF.SidebarModeView.extend({className:"page-thumbs",events:{"click .item":"_onItemClicked"},initialize:function(e){this.pageRenderer=e.pageRenderer,this.scrollContainer=e.scrollContainer,this._thumbnailViews=[],this._selectedThumbnailView=null},setVisible:function(e){PowerPack.PDF.SidebarModeView.prototype.setVisible.call(this,e),e&&this._selectedThumbnailView&&this._scrollToSelectedThumbnail(!1)},render:function(){var e=this.model.get("reviewable").get("pdf");return this.listenTo(e,"change:currentPage",this._onPageNumChanged),this._onPageNumChanged(),this.listenTo(e,"change:numPages",this._renderThumbnails),this._renderThumbnails(),this},_renderThumbnails:function(){for(var e=this.model.get("reviewable").get("pdf"),t=0;t<this._thumbnailViews.length;t++)this._thumbnailViews[t].remove();this._thumbnailViews=[],this._selectedThumbnailView=null;for(var i=1;i<=e.get("numPages");i++){var n=new o({pageNum:i});n.render(this.pageRenderer).$el.appendTo(this.$el),this._thumbnailViews.push(n)}},_scrollToSelectedThumbnail:function(e){var t=this._selectedThumbnailView.$el,i=t.outerHeight(!0),t=t.position(),n=this.scrollContainer.scrollTop,o=this.scrollContainer.offsetHeight,s=null;t.top<0?s=n+t.top:t.top+i>=o&&(s=n+t.top-o+i),null!==s&&(!1!==e?$(this.scrollContainer).stop(!0).animate({scrollTop:s}):this.scrollContainer.scrollTop=s)},_onItemClicked:function(e){e=$(e.target).data("page");e&&this.model.get("reviewable").get("pdf").set("currentPage",e)},_onPageNumChanged:function(){var e=this.model.get("reviewable").get("pdf").get("currentPage");null!==e&&0!==this._thumbnailViews.length&&(e=this._thumbnailViews[e-1],this._selectedThumbnailView&&this._selectedThumbnailView.setSelected(!1),e.setSelected(!0),this._selectedThumbnailView=e,this._scrollToSelectedThumbnail())}}),PowerPack.PDF.RegionCommentBlockView=RB.RegionCommentBlockView.extend({initialize:function(){var i=this;RB.RegionCommentBlockView.prototype.initialize.call(this),this.model.on("change:scale",function(e,t){i.setScale(t)})},getMoveState:function(){return void 0===this.moveState?this._moveState:this.moveState},getScale:function(){return void 0===this.scale?this._scale:this.scale},_onWindowMouseUp:function(){var e,t,i,n=this,o=this.getMoveState();o.hasMoved&&(e=this.model,t=this.getScale(),i=this._pageView._buildCommentThumbnail(e.get("x")*t,e.get("y")*t,e.get("width")*t,e.get("height")*t),e.set({thumbnailData:i}),e.saveDraftCommentBounds().catch(function(){alert(gettext("Failed to update PDF comment.")),n.model.set({x:o.initialBounds.left/t,y:o.initialBounds.top/t,width:o.initialBounds.width/t,height:o.initialBounds.height/t})})),this._endDragging()}}),PowerPack.PDF.ReviewableView=RB.FileAttachmentReviewableView.extend({className:"pdf-review-ui",commentBlockView:PowerPack.PDF.RegionCommentBlockView,template:'<div class="pdf-controls review-ui-header">\n <div class="pdf-controls-sidebar"></div>\n <div class="pdf-controls-center-outer">\n  <div class="pdf-controls-center-inner">\n   <div class="pdf-controls-page"></div>\n  </div>\n </div>\n <div class="pdf-controls-zoom"></div>\n <div class="pdf-controls-revision"></div>\n</div>\n<div class="pdf-lower">\n <div class="pdf-nav">\n  <div class="pdf-nav-outline"></div>\n  <div class="pdf-nav-pages"></div>\n  <div class="pdf-nav-diffs"></div>\n </div>\n</div>',spinnerTemplate:_.template('<div class="pdf-controls-diff-loading">\n <span class="fa fa-spinner fa-pulse"></span>\n <%- spinnerText %>\n</div>'),initialize:function(e){var i=this,e=(RB.AbstractReviewableView.prototype.initialize.call(this,e),this._navDiffIcon=e.navDiffIcon,this._navMenuIcon=e.navMenuIcon,this._navOutlineIcon=e.navOutlineIcon,this._navThumbnailIcon=e.navThumbnailIcon,this._pageDownIcon=e.pageDownIcon,this._pageUpIcon=e.pageUpIcon,this._pageZoomInIcon=e.pageZoomInIcon,this._pageZoomOutIcon=e.pageZoomOutIcon,this.model.get("pdf")),t=this.model.get("diffAgainstPDF");this._activeSelection=null,this._bottomSpacing=null,this._sidebarView=null,this._pageControlsView=null,this._sidebarControlsView=null,this._zoomControlsView=null,this._pagesView=null,this._sidebar=new PowerPack.PDF.Sidebar({reviewable:this.model,navDiffIcon:this.model.get("navDiffIcon"),navMenuIcon:this.model.get("navMenuIcon"),navOutlineIcon:this.model.get("navOutlineIcon"),navThumbnailIcon:this.model.get("navThumbnailIcon")}),this._pageRenderer=new PowerPack.PDF.PageRendererView({model:this.model,pdf:e}),this._blockScrollHandler=!1,t&&(this._diffPageRenderer=new PowerPack.PDF.PageRendererView({model:this.model,pdf:t})),this._$lower=null,this._$window=$(window),this._$window.resize(_.bind(this._onWindowResize,this)),location.hash&&"#page-"===location.hash.slice(0,6)&&e.set("currentPage",parseInt(location.hash.slice(6),10)),this.on("commentBlockViewAdded",function(t){var e=t.model.get("onDiffOrigFile")?i._diffAgainstPagesView:i._pagesView;e&&0<e.pages.length&&e.placeCommentBlockView(t.model.get("page"),t),t.model.set("scale",i.model.get("scale")),i.model.get("commentBlockViews").push(t),t.on("remove",function(){var e=i.model.get("commentBlockViews"),e=_.without(e,t);i.model.set("commentBlockViews",e)})})},renderContent:function(){var e=this,t=(this.$el.html(this.template),this._$lower=this.$(".pdf-lower"),this._sidebarView=new PowerPack.PDF.SidebarView({el:this.$(".pdf-nav"),model:this._sidebar,pageRenderer:this._pageRenderer}),this._sidebarView.render(),this.listenTo(this._sidebarView,"selectPage",this._jumpToPage),this._sidebarControlsView=new PowerPack.PDF.SidebarControlsView({el:this.$(".pdf-controls-sidebar"),model:this._sidebar,navDiffIcon:this._navDiffIcon,navMenuIcon:this._navMenuIcon,navOutlineIcon:this._navOutlineIcon,navThumbnailIcon:this._navThumbnailIcon}),this._sidebarControlsView.render(),this._pageControlsView=new PowerPack.PDF.PageControlsView({el:this.$(".pdf-controls-page"),model:this.model,pageDownIcon:this._pageDownIcon,pageUpIcon:this._pageUpIcon}),this._pageControlsView.render(),this._zoomControlsView=new PowerPack.PDF.ZoomControlsView({el:this.$(".pdf-controls-zoom"),model:this.model,pageZoomInIcon:this._pageZoomInIcon,pageZoomOutIcon:this._pageZoomOutIcon}),this._zoomControlsView.render(),1<this.model.get("numRevisions")&&(t=this.$(".pdf-controls-revision"),i=$('<div id="revision_label">').appendTo(t),this._revisionLabelView=new RB.FileAttachmentRevisionLabelView({el:i,model:this.model}),this._revisionLabelView.render(),i=$('<div id="attachment_revision_selector">').appendTo(t),this._revisionSelectorView=new RB.FileAttachmentRevisionSelectorView({el:i,model:this.model}),this._revisionSelectorView.render(),this.listenTo(this._revisionLabelView,"revisionSelected",this._onRevisionSelected),this.listenTo(this._revisionSelectorView,"revisionSelected",this._onRevisionSelected)),void 0!==this._diffPageRenderer),i=(t&&(i=$('<div class="pdf-offset diff">').appendTo(this._$lower),this._diffAgainstPagesView=new PowerPack.PDF.PagesView({el:i,model:this.model,origFile:!0,pageRenderer:this._diffPageRenderer,pdf:this.model.get("diffAgainstPDF"),reviewableView:this}),this.listenTo(this._diffAgainstPagesView,"commentRegionCreated",this.createAndEditCommentBlock),this._diffAgainstPagesView.render()),$('<div class="pdf-offset">').toggleClass("diff",t).toggleClass("diff-right",t).appendTo(this._$lower));return this._pagesView=new PowerPack.PDF.PagesView({el:i,model:this.model,origFile:!1,pageRenderer:this._pageRenderer,pdf:this.model.get("pdf"),reviewableView:this}),this.listenTo(this._pagesView,"commentRegionCreated",this.createAndEditCommentBlock),this._pagesView.render(),t&&((i=this.model.get("diffData"))?this._applyDiffData(i):_.defer(this._loadDiffData.bind(this)),this._diffAgainstPagesView.$el.on("scroll",function(){e._lockScroll(e._diffAgainstPagesView,e._pagesView)}),this._pagesView.$el.on("scroll",function(){e._lockScroll(e._pagesView,e._diffAgainstPagesView)}),this.listenTo(this.model,"change:scrollLock",function(){e._lockScroll(e._pagesView,e._diffAgainstPagesView)})),this.listenTo(this._sidebar,"change:visible",this._onSidebarToggled),_.defer(this._onWindowResize.bind(this)),this},_loadDiffData:function(){var t=this,i=$('<div class="pdf-shimmer">').appendTo(this._$lower),n=$(this.spinnerTemplate({spinnerText:gettext("Loading diffs...")})).appendTo(this.$(".pdf-controls-revision"));function o(e){alert("Failed to generate PDF diffs: "+e),n.remove(),i.remove()}$.ajax(this.model.get("diffURL")).done(function(e){"success"===e.result?(i.remove(),n.remove(),t.model.set("diffData",e.data),t._applyDiffData(e.data)):o(e.error)}).fail(function(e,t){var e=e.responseText,i=null;try{i=JSON.parse(e)}catch(e){}o(e=i&&i.error?i.error:e)})},_applyDiffData:function(e){this._diffAgainstPagesView.addDiffRegions(e.filter(function(e){return"delete"===e.op})),this._pagesView.addDiffRegions(e.filter(function(e){return"insert"===e.op}))},_lockScroll:function(e,t){this.model.get("scrollLock")&&!this._blockScrollHandler&&(this._blockScrollHandler=!0,t.$el.scrollTop(e.el.scrollTop),this._blockScrollHandler=!1)},_onRevisionSelected:function(e){var t=this.model.get("attachmentRevisionIDs"),i=e[0],e=e[1];0!==e&&(e=t[e-1],i=(0===i?"../":(t=t[i-1],"../".concat(t,"-"))).concat(e,"/"),window.location.replace(i))},_onWindowResize:function(){this.el.parentElement&&this._$lower.height(this._$window.height()-this._$lower.offset().top-this._getBottomSpacing()-1)},_getBottomSpacing:function(){var t=this;return null===this._bottomSpacing&&(this._bottomSpacing=0,_.each(this.$el.parents(),function(e){t._bottomSpacing+=$(e).getExtents("bmp","b")})),this._bottomSpacing},_onSidebarToggled:function(){var e=this._sidebar.get("visible");this._sidebarView.$el.toggleClass("sidebar-open",e),this._pagesView.$el.toggleClass("sidebar-open",e),this._diffAgainstPagesView&&this._diffAgainstPagesView.$el.toggleClass("sidebar-open",e),this._onWindowResize()}}),PowerPack.PDF.ZoomControlsView=Backbone.View.extend({className:"pdf-controls-zoom",events:{"click #powerpack-pdf-zoom-out":"_onZoomOut","click #powerpack-pdf-zoom-in":"_onZoomIn"},template:_.template('<button type="button"\n        class="powerpack-c-pdf-controls-button"\n        id="powerpack-pdf-zoom-out"\n        tabindex="0"\n        aria-label="<%- zoomOutText %>"\n        aria-pressed="false"\n        title="<%- zoomOutText %>">\n <span class="rb-c-button__icon" aria-hidden="true"/>\n</button>\n<button type="button"\n        class="powerpack-c-pdf-controls-button"\n        id="powerpack-pdf-zoom-in"\n        tabindex="0"\n        aria-label="<%- zoomInText %>"\n        aria-pressed="false"\n        title="<%- zoomInText %>">\n <span class="rb-c-button__icon" aria-hidden="true"/>\n</button>'),initialize:function(e){this._pageZoomInIcon=e.pageZoomInIcon,this._pageZoomOutIcon=e.pageZoomOutIcon},render:function(){this.model;return this.$el.html(this.template({zoomOutText:gettext("Zoom out"),zoomInText:gettext("Zoom in")})),this.$("#powerpack-pdf-zoom-out").children(".rb-c-button__icon").css({"mask-image":"url(".concat(this._pageZoomOutIcon,")")}),this.$("#powerpack-pdf-zoom-in").children(".rb-c-button__icon").css({"mask-image":"url(".concat(this._pageZoomInIcon,")")}),this},_onZoomOut:function(){this.model.set("scale",Math.floor(.75*this.model.get("scale")*10)/10)},_onZoomIn:function(){this.model.set("scale",Math.ceil(this.model.get("scale")*(4/3)*10)/10)}})}.call(this);
