name: "Test Suite"
on:
  push:
    branches: [main, "release/*"]
  pull_request:
    branches: [main, "release/*"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  checks: write
  pull-requests: write

defaults:
  run:
    shell: bash -l {0}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !contains(github.ref, 'main/')}}

jobs:
  test_suite:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Install Conda environment from environment-dev.yml"
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-file: environment-dev.yml
          cache-environment: true

      - name: "Build vidur"
        id: build_vidur
        run: |
          echo "Building Vidur C++ extensions..."
          pip install -e .

      - name: "Run integration tests"
        id: run_integration_tests
        run: |
          echo "Running integration tests..."
          python -m pytest test/integration/ -v --tb=long -s --junit-xml=test_reports/integration-results.xml
        timeout-minutes: 200

      - name: "Publish Test Report"
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: "test_reports/*-results.xml"
          comment: true
          include_passed: true
          fail_on_failure: true

      - name: "Upload test outputs"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test_outputs_${{ github.run_id }}
          path: |
            test_reports/
            test_output/
          retention-days: 7