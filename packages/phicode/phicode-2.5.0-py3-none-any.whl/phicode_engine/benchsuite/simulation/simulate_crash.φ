# (Ï†) src/phicode_engine/benchsuite/simulation/simulate_crash.Ï†
# Copyright 2025 Baleine Jay
# Licensed under the PhiCode Non-Commercial License (https://banes-lab.com/licensing)
# Commercial use requires a paid license. See link for details.
â‡’ time
â‡’ threading
â† phicode_engine.core.transpilation.phicode_to_python â‡’ transpile_symbols
â† phicode_engine.core.cache.phicode_cache â‡’ _cache
â† phicode_engine.core.cache.phicode_bytecode â‡’ BytecodeManager, _flush_batch_writes
â† phicode_engine.config.config â‡’ MAIN_FILE_TYPE

crash_iterations = 1100 # sequential stress
cache_operations = 10000 # saturation test
worker_ops = 350
thread_count = 16 # * ops_multiplier = concurrent operations
ops_multiplier = 150
large_cache_ops = 10000 # cache growth test

Ï€("ðŸ”¥ Crash Test - Finding Breaking Points")

test_code = """
def complex_operation(data):
    results = []
    for item in data:
        if item is not None and len(str(item)) > 0:
            try:
                processed = str(item).strip().lower()
                if processed in ['valid', 'active', 'processed', 'ready']:
                    for i in range(10):
                        nested_result = f"item_{item}_iteration_{i}"
                        results.append(nested_result)
                        if i % 3 == 0:
                            results.extend([f"extra_{j}" for j in range(5)])
                    return results
            except Exception as e:
                continue
        else:
            continue
    return results or ['default']
"""

Ï€("  ðŸŽ¯ Transpiler overload test...")
start_time = time.perf_counter()

âˆ€ i âˆˆ range(crash_iterations):
    transpile_symbols(test_code)

transpiler_time = time.perf_counter() - start_time
Ï€(f"    {crash_iterations} transpilations: {transpiler_time*1000:.1f}ms")
Ï€(f"    Throughput: {len(test_code) * crash_iterations / transpiler_time:.0f} chars/sec")

Ï€("  ðŸŽ¯ Cache saturation test...")
start_time = time.perf_counter()

âˆ€ i âˆˆ range(cache_operations):
    cache_key = f"crash_test_{i}"
    _cache.get_python_source(cache_key, test_code)

cache_time = time.perf_counter() - start_time
Ï€(f"    {cache_operations} cache ops: {cache_time*1000:.1f}ms")
Ï€(f"    Ops/sec: {cache_operations / cache_time:.0f}")

Ï€("  ðŸŽ¯ Concurrent chaos test...")
results = []
errors = []

Æ’ chaos_worker(worker_id):
    âˆ´:
        start = time.perf_counter()
        âˆ€ op âˆˆ range(worker_ops):
            cache_key = f"chaos_{worker_id}_{op}"
            transpiled = transpile_symbols(test_code)
            _cache.get_python_source(cache_key, test_code)
            BytecodeManager.compile_and_cache(transpiled, f"{cache_key}{MAIN_FILE_TYPE}")

        end = time.perf_counter()
        results.append((worker_id, end - start))
    â›’ Exception â†¦ e:
        errors.append((worker_id, str(e)))

threads = []
chaos_start = time.perf_counter()

âˆ€ i âˆˆ range(thread_count):
    t = threading.Thread(target=chaos_worker, args=(i,))
    threads.append(t)
    t.start()

âˆ€ t âˆˆ threads:
    t.join()

chaos_time = time.perf_counter() - chaos_start
_flush_batch_writes()

total_ops = thread_count * ops_multiplier
successful_workers = len(results)
failed_workers = len(errors)

Ï€(f"    {thread_count} workers Ã— {ops_multiplier} ops = {total_ops} total operations")
Ï€(f"    Total time: {chaos_time*1000:.1f}ms")
Ï€(f"    Successful workers: {successful_workers}")
Ï€(f"    Failed workers: {failed_workers}")
Ï€(f"    Ops/sec: {total_ops / chaos_time:.0f}")

Â¿ errors:
    Ï€(f"    First 3 errors: {[f'Worker {w}: {str(e)[:50]}...' for w, e in errors[:3]]}")

Ï€("  ðŸŽ¯ Memory pressure test...")
memory_start = time.perf_counter()

âˆ€ i âˆˆ range(large_cache_ops):
    large_key = f"memory_pressure_{i}_{i*123}"
    large_code = test_code * (i % 5 + 1)
    _cache.get_python_source(large_key, large_code)

memory_time = time.perf_counter() - memory_start
Ï€(f"    {large_cache_ops} large cache entries: {memory_time*1000:.1f}ms")
Ï€(f"    Cache size: {len(_cache.python_cache)} entries")

Ï€("ðŸ”¥ Crash test completed - system stress tested")