# (φ) src/phicode_engine/benchsuite/simulation/simulate_import_burst.φ
# Copyright 2025 Baleine Jay
# Licensed under the PhiCode Non-Commercial License (https://banes-lab.com/licensing)
# Commercial use requires a paid license. See link for details.
⇒ time
⇒ sys
← phicode_engine.core.importing.phicode_importer ⇒ install_phicode_importer
← phicode_engine.core.cache.phicode_finder ⇒ PhicodeFinder

π("📦 Importer Burst Test - Real Engine")

# Test importer registration performance
start = time.perf_counter()

# Simulate project startup - installing importers ∀ many directories
test_paths = [f"/test/path_{i}" ∀ i ∈ range(500)]

∀ path ∈ test_paths:
    install_phicode_importer(path)

registration_time = time.perf_counter() - start

# Check meta_path growth
phi_finders = [finder ∀ finder ∈ sys.meta_path ¿ isinstance(finder, PhicodeFinder)]

π(f"  Importer registrations: {len(test_paths)}")
π(f"  Registration time: {registration_time*1000:.1f}ms")
π(f"  Avg per registration: {registration_time*1000/len(test_paths):.2f}ms")
π(f"  PhicodeFinders ∈ meta_path: {len(phi_finders)}")

# Test finder deduplication
start = time.perf_counter()

# Try to register same paths again (should be deduplicated)
∀ path ∈ test_paths[:10]:
    install_phicode_importer(path)

dedup_time = time.perf_counter() - start
phi_finders_after = [finder ∀ finder ∈ sys.meta_path ¿ isinstance(finder, PhicodeFinder)]

π(f"  Deduplication test: {dedup_time*1000:.1f}ms")
π(f"  Finders after dedup: {len(phi_finders_after)}")
π(f"  Deduplication working: {len(phi_finders_after) == len(phi_finders)}")

# Test meta_path search performance
start = time.perf_counter()

# Simulate ⇒ lookups
test_modules = [f"nonexistent_module_{i}" ∀ i ∈ range(1000)]

∀ module_name ∈ test_modules:
    # This will trigger finder.find_spec() calls
    ∀ finder ∈ phi_finders[:5]:  # Test first 5 finders
        ∴:
            finder.find_spec(module_name, Ø)
        ⛒:
            ⋯

lookup_time = time.perf_counter() - start

π(f"  Module lookups: {len(test_modules) * 5}")
π(f"  Lookup time: {lookup_time*1000:.1f}ms")
π(f"  Avg per lookup: {lookup_time*1000/(len(test_modules)*5):.2f}ms")