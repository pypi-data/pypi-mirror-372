# (Ï†) src/phicode_engine/benchsuite/simulation/simulate_import_burst.Ï†
# Copyright 2025 Baleine Jay
# Licensed under the PhiCode Non-Commercial License (https://banes-lab.com/licensing)
# Commercial use requires a paid license. See link for details.
â‡’ time
â‡’ sys
â† phicode_engine.core.importing.phicode_importer â‡’ install_phicode_importer
â† phicode_engine.core.cache.phicode_finder â‡’ PhicodeFinder

Ï€("ğŸ“¦ Importer Burst Test - Real Engine")

# Test importer registration performance
start = time.perf_counter()

# Simulate project startup - installing importers âˆ€ many directories
test_paths = [f"/test/path_{i}" âˆ€ i âˆˆ range(500)]

âˆ€ path âˆˆ test_paths:
    install_phicode_importer(path)

registration_time = time.perf_counter() - start

# Check meta_path growth
phi_finders = [finder âˆ€ finder âˆˆ sys.meta_path Â¿ isinstance(finder, PhicodeFinder)]

Ï€(f"  Importer registrations: {len(test_paths)}")
Ï€(f"  Registration time: {registration_time*1000:.1f}ms")
Ï€(f"  Avg per registration: {registration_time*1000/len(test_paths):.2f}ms")
Ï€(f"  PhicodeFinders âˆˆ meta_path: {len(phi_finders)}")

# Test finder deduplication
start = time.perf_counter()

# Try to register same paths again (should be deduplicated)
âˆ€ path âˆˆ test_paths[:10]:
    install_phicode_importer(path)

dedup_time = time.perf_counter() - start
phi_finders_after = [finder âˆ€ finder âˆˆ sys.meta_path Â¿ isinstance(finder, PhicodeFinder)]

Ï€(f"  Deduplication test: {dedup_time*1000:.1f}ms")
Ï€(f"  Finders after dedup: {len(phi_finders_after)}")
Ï€(f"  Deduplication working: {len(phi_finders_after) == len(phi_finders)}")

# Test meta_path search performance
start = time.perf_counter()

# Simulate â‡’ lookups
test_modules = [f"nonexistent_module_{i}" âˆ€ i âˆˆ range(1000)]

âˆ€ module_name âˆˆ test_modules:
    # This will trigger finder.find_spec() calls
    âˆ€ finder âˆˆ phi_finders[:5]:  # Test first 5 finders
        âˆ´:
            finder.find_spec(module_name, Ã˜)
        â›’:
            â‹¯

lookup_time = time.perf_counter() - start

Ï€(f"  Module lookups: {len(test_modules) * 5}")
Ï€(f"  Lookup time: {lookup_time*1000:.1f}ms")
Ï€(f"  Avg per lookup: {lookup_time*1000/(len(test_modules)*5):.2f}ms")