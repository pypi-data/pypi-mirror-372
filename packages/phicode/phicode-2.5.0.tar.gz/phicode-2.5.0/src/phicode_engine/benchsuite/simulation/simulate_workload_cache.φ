# (Ï†) src/phicode_engine/benchsuite/simulation/simulate_workload_cache.Ï†
# Copyright 2025 Baleine Jay
# Licensed under the PhiCode Non-Commercial License (https://banes-lab.com/licensing)
# Commercial use requires a paid license. See link for details.
â‡’ time
â† phicode_engine.core.cache.phicode_cache â‡’ _cache
â† phicode_engine.core.cache.phicode_bytecode â‡’ BytecodeManager, _flush_batch_writes
â† phicode_engine.config.config â‡’ PYTHON_TO_PHICODE, MAIN_FILE_TYPE

Ï€("ðŸ’¾ Cache Load Test - Real Engine")

symbols = list(PYTHON_TO_PHICODE.values())

# Realistic Ï† code patterns (your style - small, focused)
patterns = [
    "def process_data(items):\n    return [x*2 for x in items]",
    "if condition:\n    print('executed')\nelse:\n    print('skipped')",
    "for i in range(10):\n    if i % 2:\n        print(i)",
    "def validate(data):\n    return data is not None and len(data) > 0"
]

start_time = time.perf_counter()
cache_hits = 0
cache_misses = 0

# Simulate realistic project load - 100 small files
âˆ€ file_id âˆˆ range(100):
    âˆ€ pattern_id, pattern âˆˆ enumerate(patterns):
        cache_key = f"file_{file_id}_pattern_{pattern_id}"

        # Check Â¿ already cached
        initial_size = len(_cache.python_cache)

        # Use real cache
        result = _cache.get_python_source(cache_key, pattern)

        # Use real bytecode manager
        BytecodeManager.compile_and_cache(result, f"{cache_key}{MAIN_FILE_TYPE}")

        # Track hit/miss
        Â¿ len(_cache.python_cache) > initial_size:
            cache_misses += 1
        â‹„:
            cache_hits += 1

# Flush real batch writes
_flush_batch_writes()

total_time = time.perf_counter() - start_time
total_ops = cache_hits + cache_misses
hit_rate = cache_hits / total_ops Â¿ total_ops > 0 â‹„ 0

Ï€(f"  Operations: {total_ops}")
Ï€(f"  Cache hits: {cache_hits}")
Ï€(f"  Hit rate: {hit_rate:.2f}")
Ï€(f"  Total time: {total_time*1000:.1f}ms")
Ï€(f"  Avg per op: {total_time*1000/total_ops:.1f}ms")