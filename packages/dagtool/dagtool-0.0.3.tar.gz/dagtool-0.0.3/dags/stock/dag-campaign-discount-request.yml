name: campaign_discount_request
type: dag
schedule_interval: "40 0,12 * * *"
start_date: "2024-05-01 00:00:00 Asia/Bangkok"
catchup: false
tags:
  - "campaign-discount-request"
  - "pos-admin"
max_active_runs: 1
tasks:
  - task: start
    op: empty

  - group: copy_latest_blob
    upstream: start
    tasks:
      - task: start
        op: empty

      - task: copy_latest_blobs_bucket_to_bucket
        upstream: start
        op: empty

      - task: end
        upstream: copy_latest_blobs_bucket_to_bucket
        op: empty

  - task: check_blob_exist
    upstream: copy_latest_blob
    op: operator
    from: gcs_object_with_prefix_existence_sensor
    params:
      bucket: "{{ var('bucket_name') }}"
      prefix: some-prefix
      deferrable: true

  - task: concat_file_into_landing
    upstream: check_blob_exist
    op: empty

  - group: spark_trans_and_validate_group
    upstream: concat_file_into_landing
    tasks:
      - task: transform
        op: empty

      - task: validate
        upstream: transform
        op: empty

      - task: sync_biglake
        upstream: validate
        op: empty

  - task: end
    upstream: spark_trans_and_validate_group
    op: empty
