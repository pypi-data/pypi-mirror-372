"use strict";var co=Object.create;var Kn=Object.defineProperty;var uo=Object.getOwnPropertyDescriptor;var lo=Object.getOwnPropertyNames;var fo=Object.getPrototypeOf,ho=Object.prototype.hasOwnProperty;var N=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var po=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of lo(e))!ho.call(r,s)&&s!==t&&Kn(r,s,{get:()=>e[s],enumerable:!(n=uo(e,s))||n.enumerable});return r};var ae=(r,e,t)=>(t=r!=null?co(fo(r)):{},po(e||!r||!r.__esModule?Kn(t,"default",{value:r,enumerable:!0}):t,r));var es=N((xc,Zn)=>{"use strict";function mo(r,e){var t=r;e.slice(0,-1).forEach(function(s){t=t[s]||{}});var n=e[e.length-1];return n in t}function Xn(r){return typeof r=="number"||/^0x[0-9a-f]+$/i.test(r)?!0:/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(r)}function Qn(r,e){return e==="constructor"&&typeof r[e]=="function"||e==="__proto__"}Zn.exports=function(r,e){e||(e={});var t={bools:{},strings:{},unknownFn:null};typeof e.unknown=="function"&&(t.unknownFn=e.unknown),typeof e.boolean=="boolean"&&e.boolean?t.allBools=!0:[].concat(e.boolean).filter(Boolean).forEach(function(b){t.bools[b]=!0});var n={};function s(b){return n[b].some(function(E){return t.bools[E]})}Object.keys(e.alias||{}).forEach(function(b){n[b]=[].concat(e.alias[b]),n[b].forEach(function(E){n[E]=[b].concat(n[b].filter(function(F){return E!==F}))})}),[].concat(e.string).filter(Boolean).forEach(function(b){t.strings[b]=!0,n[b]&&[].concat(n[b]).forEach(function(E){t.strings[E]=!0})});var i=e.default||{},a={_:[]};function f(b,E){return t.allBools&&/^--[^=]+$/.test(E)||t.strings[b]||t.bools[b]||n[b]}function h(b,E,F){for(var O=b,oe=0;oe<E.length-1;oe++){var J=E[oe];if(Qn(O,J))return;O[J]===void 0&&(O[J]={}),(O[J]===Object.prototype||O[J]===Number.prototype||O[J]===String.prototype)&&(O[J]={}),O[J]===Array.prototype&&(O[J]=[]),O=O[J]}var Z=E[E.length-1];Qn(O,Z)||((O===Object.prototype||O===Number.prototype||O===String.prototype)&&(O={}),O===Array.prototype&&(O=[]),O[Z]===void 0||t.bools[Z]||typeof O[Z]=="boolean"?O[Z]=F:Array.isArray(O[Z])?O[Z].push(F):O[Z]=[O[Z],F])}function l(b,E,F){if(!(F&&t.unknownFn&&!f(b,F)&&t.unknownFn(F)===!1)){var O=!t.strings[b]&&Xn(E)?Number(E):E;h(a,b.split("."),O),(n[b]||[]).forEach(function(oe){h(a,oe.split("."),O)})}}Object.keys(t.bools).forEach(function(b){l(b,i[b]===void 0?!1:i[b])});var g=[];r.indexOf("--")!==-1&&(g=r.slice(r.indexOf("--")+1),r=r.slice(0,r.indexOf("--")));for(var p=0;p<r.length;p++){var m=r[p],S,C;if(/^--.+=/.test(m)){var w=m.match(/^--([^=]+)=([\s\S]*)$/);S=w[1];var L=w[2];t.bools[S]&&(L=L!=="false"),l(S,L,m)}else if(/^--no-.+/.test(m))S=m.match(/^--no-(.+)/)[1],l(S,!1,m);else if(/^--.+/.test(m))S=m.match(/^--(.+)/)[1],C=r[p+1],C!==void 0&&!/^(-|--)[^-]/.test(C)&&!t.bools[S]&&!t.allBools&&(!n[S]||!s(S))?(l(S,C,m),p+=1):/^(true|false)$/.test(C)?(l(S,C==="true",m),p+=1):l(S,t.strings[S]?"":!0,m);else if(/^-[^-]+/.test(m)){for(var $=m.slice(1,-1).split(""),G=!1,x=0;x<$.length;x++){if(C=m.slice(x+2),C==="-"){l($[x],C,m);continue}if(/[A-Za-z]/.test($[x])&&C[0]==="="){l($[x],C.slice(1),m),G=!0;break}if(/[A-Za-z]/.test($[x])&&/-?\d+(\.\d*)?(e-?\d+)?$/.test(C)){l($[x],C,m),G=!0;break}if($[x+1]&&$[x+1].match(/\W/)){l($[x],m.slice(x+2),m),G=!0;break}else l($[x],t.strings[$[x]]?"":!0,m)}S=m.slice(-1)[0],!G&&S!=="-"&&(r[p+1]&&!/^(-|--)[^-]/.test(r[p+1])&&!t.bools[S]&&(!n[S]||!s(S))?(l(S,r[p+1],m),p+=1):r[p+1]&&/^(true|false)$/.test(r[p+1])?(l(S,r[p+1]==="true",m),p+=1):l(S,t.strings[S]?"":!0,m))}else if((!t.unknownFn||t.unknownFn(m)!==!1)&&a._.push(t.strings._||!Xn(m)?m:Number(m)),e.stopEarly){a._.push.apply(a._,r.slice(p+1));break}}return Object.keys(i).forEach(function(b){mo(a,b.split("."))||(h(a,b.split("."),i[b]),(n[b]||[]).forEach(function(E){h(a,E.split("."),i[b])}))}),e["--"]?a["--"]=g.slice():g.forEach(function(b){a._.push(b)}),a}});var De=N(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.stringArray=K.array=K.func=K.error=K.number=K.string=K.boolean=void 0;function _o(r){return r===!0||r===!1}K.boolean=_o;function ts(r){return typeof r=="string"||r instanceof String}K.string=ts;function go(r){return typeof r=="number"||r instanceof Number}K.number=go;function yo(r){return r instanceof Error}K.error=yo;function bo(r){return typeof r=="function"}K.func=bo;function rs(r){return Array.isArray(r)}K.array=rs;function So(r){return rs(r)&&r.every(e=>ts(e))}K.stringArray=So});var Tr=N(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.Message=y.NotificationType9=y.NotificationType8=y.NotificationType7=y.NotificationType6=y.NotificationType5=y.NotificationType4=y.NotificationType3=y.NotificationType2=y.NotificationType1=y.NotificationType0=y.NotificationType=y.RequestType9=y.RequestType8=y.RequestType7=y.RequestType6=y.RequestType5=y.RequestType4=y.RequestType3=y.RequestType2=y.RequestType1=y.RequestType=y.RequestType0=y.AbstractMessageSignature=y.ParameterStructures=y.ResponseError=y.ErrorCodes=void 0;var Te=De(),tr;(function(r){r.ParseError=-32700,r.InvalidRequest=-32600,r.MethodNotFound=-32601,r.InvalidParams=-32602,r.InternalError=-32603,r.jsonrpcReservedErrorRangeStart=-32099,r.serverErrorStart=-32099,r.MessageWriteError=-32099,r.MessageReadError=-32098,r.PendingResponseRejected=-32097,r.ConnectionInactive=-32096,r.ServerNotInitialized=-32002,r.UnknownErrorCode=-32001,r.jsonrpcReservedErrorRangeEnd=-32e3,r.serverErrorEnd=-32e3})(tr||(y.ErrorCodes=tr={}));var rr=class r extends Error{constructor(e,t,n){super(t),this.code=Te.number(e)?e:tr.UnknownErrorCode,this.data=n,Object.setPrototypeOf(this,r.prototype)}toJson(){let e={code:this.code,message:this.message};return this.data!==void 0&&(e.data=this.data),e}};y.ResponseError=rr;var ee=class r{constructor(e){this.kind=e}static is(e){return e===r.auto||e===r.byName||e===r.byPosition}toString(){return this.kind}};y.ParameterStructures=ee;ee.auto=new ee("auto");ee.byPosition=new ee("byPosition");ee.byName=new ee("byName");var B=class{constructor(e,t){this.method=e,this.numberOfParams=t}get parameterStructures(){return ee.auto}};y.AbstractMessageSignature=B;var nr=class extends B{constructor(e){super(e,0)}};y.RequestType0=nr;var sr=class extends B{constructor(e,t=ee.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.RequestType=sr;var ir=class extends B{constructor(e,t=ee.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.RequestType1=ir;var or=class extends B{constructor(e){super(e,2)}};y.RequestType2=or;var ar=class extends B{constructor(e){super(e,3)}};y.RequestType3=ar;var cr=class extends B{constructor(e){super(e,4)}};y.RequestType4=cr;var ur=class extends B{constructor(e){super(e,5)}};y.RequestType5=ur;var lr=class extends B{constructor(e){super(e,6)}};y.RequestType6=lr;var fr=class extends B{constructor(e){super(e,7)}};y.RequestType7=fr;var dr=class extends B{constructor(e){super(e,8)}};y.RequestType8=dr;var hr=class extends B{constructor(e){super(e,9)}};y.RequestType9=hr;var pr=class extends B{constructor(e,t=ee.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.NotificationType=pr;var mr=class extends B{constructor(e){super(e,0)}};y.NotificationType0=mr;var _r=class extends B{constructor(e,t=ee.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.NotificationType1=_r;var gr=class extends B{constructor(e){super(e,2)}};y.NotificationType2=gr;var yr=class extends B{constructor(e){super(e,3)}};y.NotificationType3=yr;var br=class extends B{constructor(e){super(e,4)}};y.NotificationType4=br;var Sr=class extends B{constructor(e){super(e,5)}};y.NotificationType5=Sr;var vr=class extends B{constructor(e){super(e,6)}};y.NotificationType6=vr;var Er=class extends B{constructor(e){super(e,7)}};y.NotificationType7=Er;var wr=class extends B{constructor(e){super(e,8)}};y.NotificationType8=wr;var xr=class extends B{constructor(e){super(e,9)}};y.NotificationType9=xr;var ns;(function(r){function e(s){let i=s;return i&&Te.string(i.method)&&(Te.string(i.id)||Te.number(i.id))}r.isRequest=e;function t(s){let i=s;return i&&Te.string(i.method)&&s.id===void 0}r.isNotification=t;function n(s){let i=s;return i&&(i.result!==void 0||!!i.error)&&(Te.string(i.id)||Te.number(i.id)||i.id===null)}r.isResponse=n})(ns||(y.Message=ns={}))});var Or=N(be=>{"use strict";var ss;Object.defineProperty(be,"__esModule",{value:!0});be.LRUCache=be.LinkedMap=be.Touch=void 0;var X;(function(r){r.None=0,r.First=1,r.AsOld=r.First,r.Last=2,r.AsNew=r.Last})(X||(be.Touch=X={}));var _t=class{constructor(){this[ss]="LinkedMap",this._map=new Map,this._head=void 0,this._tail=void 0,this._size=0,this._state=0}clear(){this._map.clear(),this._head=void 0,this._tail=void 0,this._size=0,this._state++}isEmpty(){return!this._head&&!this._tail}get size(){return this._size}get first(){var e;return(e=this._head)==null?void 0:e.value}get last(){var e;return(e=this._tail)==null?void 0:e.value}has(e){return this._map.has(e)}get(e,t=X.None){let n=this._map.get(e);if(n)return t!==X.None&&this.touch(n,t),n.value}set(e,t,n=X.None){let s=this._map.get(e);if(s)s.value=t,n!==X.None&&this.touch(s,n);else{switch(s={key:e,value:t,next:void 0,previous:void 0},n){case X.None:this.addItemLast(s);break;case X.First:this.addItemFirst(s);break;case X.Last:this.addItemLast(s);break;default:this.addItemLast(s);break}this._map.set(e,s),this._size++}return this}delete(e){return!!this.remove(e)}remove(e){let t=this._map.get(e);if(t)return this._map.delete(e),this.removeItem(t),this._size--,t.value}shift(){if(!this._head&&!this._tail)return;if(!this._head||!this._tail)throw new Error("Invalid list");let e=this._head;return this._map.delete(e.key),this.removeItem(e),this._size--,e.value}forEach(e,t){let n=this._state,s=this._head;for(;s;){if(t?e.bind(t)(s.value,s.key,this):e(s.value,s.key,this),this._state!==n)throw new Error("LinkedMap got modified during iteration.");s=s.next}}keys(){let e=this._state,t=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(t){let s={value:t.key,done:!1};return t=t.next,s}else return{value:void 0,done:!0}}};return n}values(){let e=this._state,t=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(t){let s={value:t.value,done:!1};return t=t.next,s}else return{value:void 0,done:!0}}};return n}entries(){let e=this._state,t=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(t){let s={value:[t.key,t.value],done:!1};return t=t.next,s}else return{value:void 0,done:!0}}};return n}[(ss=Symbol.toStringTag,Symbol.iterator)](){return this.entries()}trimOld(e){if(e>=this.size)return;if(e===0){this.clear();return}let t=this._head,n=this.size;for(;t&&n>e;)this._map.delete(t.key),t=t.next,n--;this._head=t,this._size=n,t&&(t.previous=void 0),this._state++}addItemFirst(e){if(!this._head&&!this._tail)this._tail=e;else if(this._head)e.next=this._head,this._head.previous=e;else throw new Error("Invalid list");this._head=e,this._state++}addItemLast(e){if(!this._head&&!this._tail)this._head=e;else if(this._tail)e.previous=this._tail,this._tail.next=e;else throw new Error("Invalid list");this._tail=e,this._state++}removeItem(e){if(e===this._head&&e===this._tail)this._head=void 0,this._tail=void 0;else if(e===this._head){if(!e.next)throw new Error("Invalid list");e.next.previous=void 0,this._head=e.next}else if(e===this._tail){if(!e.previous)throw new Error("Invalid list");e.previous.next=void 0,this._tail=e.previous}else{let t=e.next,n=e.previous;if(!t||!n)throw new Error("Invalid list");t.previous=n,n.next=t}e.next=void 0,e.previous=void 0,this._state++}touch(e,t){if(!this._head||!this._tail)throw new Error("Invalid list");if(!(t!==X.First&&t!==X.Last)){if(t===X.First){if(e===this._head)return;let n=e.next,s=e.previous;e===this._tail?(s.next=void 0,this._tail=s):(n.previous=s,s.next=n),e.previous=void 0,e.next=this._head,this._head.previous=e,this._head=e,this._state++}else if(t===X.Last){if(e===this._tail)return;let n=e.next,s=e.previous;e===this._head?(n.previous=void 0,this._head=n):(n.previous=s,s.next=n),e.next=void 0,e.previous=this._tail,this._tail.next=e,this._tail=e,this._state++}}}toJSON(){let e=[];return this.forEach((t,n)=>{e.push([n,t])}),e}fromJSON(e){this.clear();for(let[t,n]of e)this.set(t,n)}};be.LinkedMap=_t;var Cr=class extends _t{constructor(e,t=1){super(),this._limit=e,this._ratio=Math.min(Math.max(0,t),1)}get limit(){return this._limit}set limit(e){this._limit=e,this.checkTrim()}get ratio(){return this._ratio}set ratio(e){this._ratio=Math.min(Math.max(0,e),1),this.checkTrim()}get(e,t=X.AsNew){return super.get(e,t)}peek(e){return super.get(e,X.None)}set(e,t){return super.set(e,t,X.Last),this.checkTrim(),this}checkTrim(){this.size>this._limit&&this.trimOld(Math.round(this._limit*this._ratio))}};be.LRUCache=Cr});var os=N(gt=>{"use strict";Object.defineProperty(gt,"__esModule",{value:!0});gt.Disposable=void 0;var is;(function(r){function e(t){return{dispose:t}}r.create=e})(is||(gt.Disposable=is={}))});var Se=N(Nr=>{"use strict";Object.defineProperty(Nr,"__esModule",{value:!0});var Pr;function kr(){if(Pr===void 0)throw new Error("No runtime abstraction layer installed");return Pr}(function(r){function e(t){if(t===void 0)throw new Error("No runtime abstraction layer provided");Pr=t}r.install=e})(kr||(kr={}));Nr.default=kr});var Be=N(qe=>{"use strict";Object.defineProperty(qe,"__esModule",{value:!0});qe.Emitter=qe.Event=void 0;var vo=Se(),as;(function(r){let e={dispose(){}};r.None=function(){return e}})(as||(qe.Event=as={}));var Rr=class{add(e,t=null,n){this._callbacks||(this._callbacks=[],this._contexts=[]),this._callbacks.push(e),this._contexts.push(t),Array.isArray(n)&&n.push({dispose:()=>this.remove(e,t)})}remove(e,t=null){if(!this._callbacks)return;let n=!1;for(let s=0,i=this._callbacks.length;s<i;s++)if(this._callbacks[s]===e)if(this._contexts[s]===t){this._callbacks.splice(s,1),this._contexts.splice(s,1);return}else n=!0;if(n)throw new Error("When adding a listener with a context, you should remove it with the same context")}invoke(...e){if(!this._callbacks)return[];let t=[],n=this._callbacks.slice(0),s=this._contexts.slice(0);for(let i=0,a=n.length;i<a;i++)try{t.push(n[i].apply(s[i],e))}catch(f){(0,vo.default)().console.error(f)}return t}isEmpty(){return!this._callbacks||this._callbacks.length===0}dispose(){this._callbacks=void 0,this._contexts=void 0}},yt=class r{constructor(e){this._options=e}get event(){return this._event||(this._event=(e,t,n)=>{this._callbacks||(this._callbacks=new Rr),this._options&&this._options.onFirstListenerAdd&&this._callbacks.isEmpty()&&this._options.onFirstListenerAdd(this),this._callbacks.add(e,t);let s={dispose:()=>{this._callbacks&&(this._callbacks.remove(e,t),s.dispose=r._noop,this._options&&this._options.onLastListenerRemove&&this._callbacks.isEmpty()&&this._options.onLastListenerRemove(this))}};return Array.isArray(n)&&n.push(s),s}),this._event}fire(e){this._callbacks&&this._callbacks.invoke.call(this._callbacks,e)}dispose(){this._callbacks&&(this._callbacks.dispose(),this._callbacks=void 0)}};qe.Emitter=yt;yt._noop=function(){}});var vt=N(Ae=>{"use strict";Object.defineProperty(Ae,"__esModule",{value:!0});Ae.CancellationTokenSource=Ae.CancellationToken=void 0;var Eo=Se(),wo=De(),Lr=Be(),bt;(function(r){r.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:Lr.Event.None}),r.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:Lr.Event.None});function e(t){let n=t;return n&&(n===r.None||n===r.Cancelled||wo.boolean(n.isCancellationRequested)&&!!n.onCancellationRequested)}r.is=e})(bt||(Ae.CancellationToken=bt={}));var xo=Object.freeze(function(r,e){let t=(0,Eo.default)().timer.setTimeout(r.bind(e),0);return{dispose(){t.dispose()}}}),St=class{constructor(){this._isCancelled=!1}cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?xo:(this._emitter||(this._emitter=new Lr.Emitter),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=void 0)}},Mr=class{get token(){return this._token||(this._token=new St),this._token}cancel(){this._token?this._token.cancel():this._token=bt.Cancelled}dispose(){this._token?this._token instanceof St&&this._token.dispose():this._token=bt.None}};Ae.CancellationTokenSource=Mr});var cs=N($e=>{"use strict";Object.defineProperty($e,"__esModule",{value:!0});$e.SharedArrayReceiverStrategy=$e.SharedArraySenderStrategy=void 0;var To=vt(),tt;(function(r){r.Continue=0,r.Cancelled=1})(tt||(tt={}));var jr=class{constructor(){this.buffers=new Map}enableCancellation(e){if(e.id===null)return;let t=new SharedArrayBuffer(4),n=new Int32Array(t,0,1);n[0]=tt.Continue,this.buffers.set(e.id,t),e.$cancellationData=t}async sendCancellation(e,t){let n=this.buffers.get(t);if(n===void 0)return;let s=new Int32Array(n,0,1);Atomics.store(s,0,tt.Cancelled)}cleanup(e){this.buffers.delete(e)}dispose(){this.buffers.clear()}};$e.SharedArraySenderStrategy=jr;var Ir=class{constructor(e){this.data=new Int32Array(e,0,1)}get isCancellationRequested(){return Atomics.load(this.data,0)===tt.Cancelled}get onCancellationRequested(){throw new Error("Cancellation over SharedArrayBuffer doesn't support cancellation events")}},Dr=class{constructor(e){this.token=new Ir(e)}cancel(){}dispose(){}},qr=class{constructor(){this.kind="request"}createCancellationTokenSource(e){let t=e.$cancellationData;return t===void 0?new To.CancellationTokenSource:new Dr(t)}};$e.SharedArrayReceiverStrategy=qr});var Ar=N(Et=>{"use strict";Object.defineProperty(Et,"__esModule",{value:!0});Et.Semaphore=void 0;var Co=Se(),Br=class{constructor(e=1){if(e<=0)throw new Error("Capacity must be greater than 0");this._capacity=e,this._active=0,this._waiting=[]}lock(e){return new Promise((t,n)=>{this._waiting.push({thunk:e,resolve:t,reject:n}),this.runNext()})}get active(){return this._active}runNext(){this._waiting.length===0||this._active===this._capacity||(0,Co.default)().timer.setImmediate(()=>this.doRunNext())}doRunNext(){if(this._waiting.length===0||this._active===this._capacity)return;let e=this._waiting.shift();if(this._active++,this._active>this._capacity)throw new Error("To many thunks active");try{let t=e.thunk();t instanceof Promise?t.then(n=>{this._active--,e.resolve(n),this.runNext()},n=>{this._active--,e.reject(n),this.runNext()}):(this._active--,e.resolve(t),this.runNext())}catch(t){this._active--,e.reject(t),this.runNext()}}};Et.Semaphore=Br});var Vr=N(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.ReadableStreamMessageReader=ve.AbstractMessageReader=ve.MessageReader=void 0;var Ur=Se(),Ue=De(),$r=Be(),Oo=Ar(),us;(function(r){function e(t){let n=t;return n&&Ue.func(n.listen)&&Ue.func(n.dispose)&&Ue.func(n.onError)&&Ue.func(n.onClose)&&Ue.func(n.onPartialMessage)}r.is=e})(us||(ve.MessageReader=us={}));var wt=class{constructor(){this.errorEmitter=new $r.Emitter,this.closeEmitter=new $r.Emitter,this.partialMessageEmitter=new $r.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e){this.errorEmitter.fire(this.asError(e))}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}get onPartialMessage(){return this.partialMessageEmitter.event}firePartialMessage(e){this.partialMessageEmitter.fire(e)}asError(e){return e instanceof Error?e:new Error(`Reader received error. Reason: ${Ue.string(e.message)?e.message:"unknown"}`)}};ve.AbstractMessageReader=wt;var Wr;(function(r){function e(t){let n,s,i,a=new Map,f,h=new Map;if(t===void 0||typeof t=="string")n=t??"utf-8";else{if(n=t.charset??"utf-8",t.contentDecoder!==void 0&&(i=t.contentDecoder,a.set(i.name,i)),t.contentDecoders!==void 0)for(let l of t.contentDecoders)a.set(l.name,l);if(t.contentTypeDecoder!==void 0&&(f=t.contentTypeDecoder,h.set(f.name,f)),t.contentTypeDecoders!==void 0)for(let l of t.contentTypeDecoders)h.set(l.name,l)}return f===void 0&&(f=(0,Ur.default)().applicationJson.decoder,h.set(f.name,f)),{charset:n,contentDecoder:i,contentDecoders:a,contentTypeDecoder:f,contentTypeDecoders:h}}r.fromOptions=e})(Wr||(Wr={}));var Fr=class extends wt{constructor(e,t){super(),this.readable=e,this.options=Wr.fromOptions(t),this.buffer=(0,Ur.default)().messageBuffer.create(this.options.charset),this._partialMessageTimeout=1e4,this.nextMessageLength=-1,this.messageToken=0,this.readSemaphore=new Oo.Semaphore(1)}set partialMessageTimeout(e){this._partialMessageTimeout=e}get partialMessageTimeout(){return this._partialMessageTimeout}listen(e){this.nextMessageLength=-1,this.messageToken=0,this.partialMessageTimer=void 0,this.callback=e;let t=this.readable.onData(n=>{this.onData(n)});return this.readable.onError(n=>this.fireError(n)),this.readable.onClose(()=>this.fireClose()),t}onData(e){try{for(this.buffer.append(e);;){if(this.nextMessageLength===-1){let n=this.buffer.tryReadHeaders(!0);if(!n)return;let s=n.get("content-length");if(!s){this.fireError(new Error(`Header must provide a Content-Length property.
${JSON.stringify(Object.fromEntries(n))}`));return}let i=parseInt(s);if(isNaN(i)){this.fireError(new Error(`Content-Length value must be a number. Got ${s}`));return}this.nextMessageLength=i}let t=this.buffer.tryReadBody(this.nextMessageLength);if(t===void 0){this.setPartialMessageTimer();return}this.clearPartialMessageTimer(),this.nextMessageLength=-1,this.readSemaphore.lock(async()=>{let n=this.options.contentDecoder!==void 0?await this.options.contentDecoder.decode(t):t,s=await this.options.contentTypeDecoder.decode(n,this.options);this.callback(s)}).catch(n=>{this.fireError(n)})}}catch(t){this.fireError(t)}}clearPartialMessageTimer(){this.partialMessageTimer&&(this.partialMessageTimer.dispose(),this.partialMessageTimer=void 0)}setPartialMessageTimer(){this.clearPartialMessageTimer(),!(this._partialMessageTimeout<=0)&&(this.partialMessageTimer=(0,Ur.default)().timer.setTimeout((e,t)=>{this.partialMessageTimer=void 0,e===this.messageToken&&(this.firePartialMessage({messageToken:e,waitingTime:t}),this.setPartialMessageTimer())},this._partialMessageTimeout,this.messageToken,this._partialMessageTimeout))}};ve.ReadableStreamMessageReader=Fr});var Hr=N(Ee=>{"use strict";Object.defineProperty(Ee,"__esModule",{value:!0});Ee.WriteableStreamMessageWriter=Ee.AbstractMessageWriter=Ee.MessageWriter=void 0;var ls=Se(),rt=De(),Po=Ar(),fs=Be(),ko="Content-Length: ",ds=`\r
`,hs;(function(r){function e(t){let n=t;return n&&rt.func(n.dispose)&&rt.func(n.onClose)&&rt.func(n.onError)&&rt.func(n.write)}r.is=e})(hs||(Ee.MessageWriter=hs={}));var xt=class{constructor(){this.errorEmitter=new fs.Emitter,this.closeEmitter=new fs.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e,t,n){this.errorEmitter.fire([this.asError(e),t,n])}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}asError(e){return e instanceof Error?e:new Error(`Writer received error. Reason: ${rt.string(e.message)?e.message:"unknown"}`)}};Ee.AbstractMessageWriter=xt;var Gr;(function(r){function e(t){return t===void 0||typeof t=="string"?{charset:t??"utf-8",contentTypeEncoder:(0,ls.default)().applicationJson.encoder}:{charset:t.charset??"utf-8",contentEncoder:t.contentEncoder,contentTypeEncoder:t.contentTypeEncoder??(0,ls.default)().applicationJson.encoder}}r.fromOptions=e})(Gr||(Gr={}));var zr=class extends xt{constructor(e,t){super(),this.writable=e,this.options=Gr.fromOptions(t),this.errorCount=0,this.writeSemaphore=new Po.Semaphore(1),this.writable.onError(n=>this.fireError(n)),this.writable.onClose(()=>this.fireClose())}async write(e){return this.writeSemaphore.lock(async()=>this.options.contentTypeEncoder.encode(e,this.options).then(n=>this.options.contentEncoder!==void 0?this.options.contentEncoder.encode(n):n).then(n=>{let s=[];return s.push(ko,n.byteLength.toString(),ds),s.push(ds),this.doWrite(e,s,n)},n=>{throw this.fireError(n),n}))}async doWrite(e,t,n){try{return await this.writable.write(t.join(""),"ascii"),this.writable.write(n)}catch(s){return this.handleError(s,e),Promise.reject(s)}}handleError(e,t){this.errorCount++,this.fireError(e,t,this.errorCount)}end(){this.writable.end()}};Ee.WriteableStreamMessageWriter=zr});var ps=N(Tt=>{"use strict";Object.defineProperty(Tt,"__esModule",{value:!0});Tt.AbstractMessageBuffer=void 0;var No=13,Ro=10,Lo=`\r
`,Jr=class{constructor(e="utf-8"){this._encoding=e,this._chunks=[],this._totalLength=0}get encoding(){return this._encoding}append(e){let t=typeof e=="string"?this.fromString(e,this._encoding):e;this._chunks.push(t),this._totalLength+=t.byteLength}tryReadHeaders(e=!1){if(this._chunks.length===0)return;let t=0,n=0,s=0,i=0;e:for(;n<this._chunks.length;){let l=this._chunks[n];for(s=0;s<l.length;){switch(l[s]){case No:switch(t){case 0:t=1;break;case 2:t=3;break;default:t=0}break;case Ro:switch(t){case 1:t=2;break;case 3:t=4,s++;break e;default:t=0}break;default:t=0}s++}i+=l.byteLength,n++}if(t!==4)return;let a=this._read(i+s),f=new Map,h=this.toString(a,"ascii").split(Lo);if(h.length<2)return f;for(let l=0;l<h.length-2;l++){let g=h[l],p=g.indexOf(":");if(p===-1)throw new Error(`Message header must separate key and value using ':'
${g}`);let m=g.substr(0,p),S=g.substr(p+1).trim();f.set(e?m.toLowerCase():m,S)}return f}tryReadBody(e){if(!(this._totalLength<e))return this._read(e)}get numberOfBytes(){return this._totalLength}_read(e){if(e===0)return this.emptyBuffer();if(e>this._totalLength)throw new Error("Cannot read so many bytes!");if(this._chunks[0].byteLength===e){let i=this._chunks[0];return this._chunks.shift(),this._totalLength-=e,this.asNative(i)}if(this._chunks[0].byteLength>e){let i=this._chunks[0],a=this.asNative(i,e);return this._chunks[0]=i.slice(e),this._totalLength-=e,a}let t=this.allocNative(e),n=0,s=0;for(;e>0;){let i=this._chunks[s];if(i.byteLength>e){let a=i.slice(0,e);t.set(a,n),n+=e,this._chunks[s]=i.slice(e),this._totalLength-=e,e-=e}else t.set(i,n),n+=i.byteLength,this._chunks.shift(),this._totalLength-=i.byteLength,e-=i.byteLength}return t}};Tt.AbstractMessageBuffer=Jr});var bs=N(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.createMessageConnection=T.ConnectionOptions=T.MessageStrategy=T.CancellationStrategy=T.CancellationSenderStrategy=T.CancellationReceiverStrategy=T.RequestCancellationReceiverStrategy=T.IdCancellationReceiverStrategy=T.ConnectionStrategy=T.ConnectionError=T.ConnectionErrors=T.LogTraceNotification=T.SetTraceNotification=T.TraceFormat=T.TraceValues=T.Trace=T.NullLogger=T.ProgressType=T.ProgressToken=void 0;var ms=Se(),W=De(),v=Tr(),_s=Or(),nt=Be(),Yr=vt(),ot;(function(r){r.type=new v.NotificationType("$/cancelRequest")})(ot||(ot={}));var Kr;(function(r){function e(t){return typeof t=="string"||typeof t=="number"}r.is=e})(Kr||(T.ProgressToken=Kr={}));var st;(function(r){r.type=new v.NotificationType("$/progress")})(st||(st={}));var Xr=class{constructor(){}};T.ProgressType=Xr;var Qr;(function(r){function e(t){return W.func(t)}r.is=e})(Qr||(Qr={}));T.NullLogger=Object.freeze({error:()=>{},warn:()=>{},info:()=>{},log:()=>{}});var R;(function(r){r[r.Off=0]="Off",r[r.Messages=1]="Messages",r[r.Compact=2]="Compact",r[r.Verbose=3]="Verbose"})(R||(T.Trace=R={}));var gs;(function(r){r.Off="off",r.Messages="messages",r.Compact="compact",r.Verbose="verbose"})(gs||(T.TraceValues=gs={}));(function(r){function e(n){if(!W.string(n))return r.Off;switch(n=n.toLowerCase(),n){case"off":return r.Off;case"messages":return r.Messages;case"compact":return r.Compact;case"verbose":return r.Verbose;default:return r.Off}}r.fromString=e;function t(n){switch(n){case r.Off:return"off";case r.Messages:return"messages";case r.Compact:return"compact";case r.Verbose:return"verbose";default:return"off"}}r.toString=t})(R||(T.Trace=R={}));var te;(function(r){r.Text="text",r.JSON="json"})(te||(T.TraceFormat=te={}));(function(r){function e(t){return W.string(t)?(t=t.toLowerCase(),t==="json"?r.JSON:r.Text):r.Text}r.fromString=e})(te||(T.TraceFormat=te={}));var Zr;(function(r){r.type=new v.NotificationType("$/setTrace")})(Zr||(T.SetTraceNotification=Zr={}));var Ct;(function(r){r.type=new v.NotificationType("$/logTrace")})(Ct||(T.LogTraceNotification=Ct={}));var it;(function(r){r[r.Closed=1]="Closed",r[r.Disposed=2]="Disposed",r[r.AlreadyListening=3]="AlreadyListening"})(it||(T.ConnectionErrors=it={}));var We=class r extends Error{constructor(e,t){super(t),this.code=e,Object.setPrototypeOf(this,r.prototype)}};T.ConnectionError=We;var en;(function(r){function e(t){let n=t;return n&&W.func(n.cancelUndispatched)}r.is=e})(en||(T.ConnectionStrategy=en={}));var Ot;(function(r){function e(t){let n=t;return n&&(n.kind===void 0||n.kind==="id")&&W.func(n.createCancellationTokenSource)&&(n.dispose===void 0||W.func(n.dispose))}r.is=e})(Ot||(T.IdCancellationReceiverStrategy=Ot={}));var tn;(function(r){function e(t){let n=t;return n&&n.kind==="request"&&W.func(n.createCancellationTokenSource)&&(n.dispose===void 0||W.func(n.dispose))}r.is=e})(tn||(T.RequestCancellationReceiverStrategy=tn={}));var Pt;(function(r){r.Message=Object.freeze({createCancellationTokenSource(t){return new Yr.CancellationTokenSource}});function e(t){return Ot.is(t)||tn.is(t)}r.is=e})(Pt||(T.CancellationReceiverStrategy=Pt={}));var kt;(function(r){r.Message=Object.freeze({sendCancellation(t,n){return t.sendNotification(ot.type,{id:n})},cleanup(t){}});function e(t){let n=t;return n&&W.func(n.sendCancellation)&&W.func(n.cleanup)}r.is=e})(kt||(T.CancellationSenderStrategy=kt={}));var Nt;(function(r){r.Message=Object.freeze({receiver:Pt.Message,sender:kt.Message});function e(t){let n=t;return n&&Pt.is(n.receiver)&&kt.is(n.sender)}r.is=e})(Nt||(T.CancellationStrategy=Nt={}));var Rt;(function(r){function e(t){let n=t;return n&&W.func(n.handleMessage)}r.is=e})(Rt||(T.MessageStrategy=Rt={}));var ys;(function(r){function e(t){let n=t;return n&&(Nt.is(n.cancellationStrategy)||en.is(n.connectionStrategy)||Rt.is(n.messageStrategy))}r.is=e})(ys||(T.ConnectionOptions=ys={}));var ce;(function(r){r[r.New=1]="New",r[r.Listening=2]="Listening",r[r.Closed=3]="Closed",r[r.Disposed=4]="Disposed"})(ce||(ce={}));function Mo(r,e,t,n){let s=t!==void 0?t:T.NullLogger,i=0,a=0,f=0,h="2.0",l,g=new Map,p,m=new Map,S=new Map,C,w=new _s.LinkedMap,L=new Map,$=new Set,G=new Map,x=R.Off,b=te.Text,E,F=ce.New,O=new nt.Emitter,oe=new nt.Emitter,J=new nt.Emitter,Z=new nt.Emitter,$n=new nt.Emitter,ge=n&&n.cancellationStrategy?n.cancellationStrategy:Nt.Message;function Un(o){if(o===null)throw new Error("Can't send requests with id null since the response can't be correlated.");return"req-"+o.toString()}function Fi(o){return o===null?"res-unknown-"+(++f).toString():"res-"+o.toString()}function Vi(){return"not-"+(++a).toString()}function Gi(o,u){v.Message.isRequest(u)?o.set(Un(u.id),u):v.Message.isResponse(u)?o.set(Fi(u.id),u):o.set(Vi(),u)}function zi(o){}function Wn(){return F===ce.Listening}function Fn(){return F===ce.Closed}function Me(){return F===ce.Disposed}function Vn(){(F===ce.New||F===ce.Listening)&&(F=ce.Closed,oe.fire(void 0))}function Hi(o){O.fire([o,void 0,void 0])}function Ji(o){O.fire(o)}r.onClose(Vn),r.onError(Hi),e.onClose(Vn),e.onError(Ji);function Gn(){C||w.size===0||(C=(0,ms.default)().timer.setImmediate(()=>{C=void 0,Yi()}))}function zn(o){v.Message.isRequest(o)?Xi(o):v.Message.isNotification(o)?Zi(o):v.Message.isResponse(o)?Qi(o):eo(o)}function Yi(){if(w.size===0)return;let o=w.shift();try{let u=n==null?void 0:n.messageStrategy;Rt.is(u)?u.handleMessage(o,zn):zn(o)}finally{Gn()}}let Ki=o=>{try{if(v.Message.isNotification(o)&&o.method===ot.type.method){let u=o.params.id,d=Un(u),_=w.get(d);if(v.Message.isRequest(_)){let j=n==null?void 0:n.connectionStrategy,I=j&&j.cancelUndispatched?j.cancelUndispatched(_,zi):void 0;if(I&&(I.error!==void 0||I.result!==void 0)){w.delete(d),G.delete(u),I.id=_.id,mt(I,o.method,Date.now()),e.write(I).catch(()=>s.error("Sending response for canceled message failed."));return}}let q=G.get(u);if(q!==void 0){q.cancel(),Zt(o);return}else $.add(u)}Gi(w,o)}finally{Gn()}};function Xi(o){if(Me())return;function u(k,U,M){let z={jsonrpc:h,id:o.id};k instanceof v.ResponseError?z.error=k.toJson():z.result=k===void 0?null:k,mt(z,U,M),e.write(z).catch(()=>s.error("Sending response failed."))}function d(k,U,M){let z={jsonrpc:h,id:o.id,error:k.toJson()};mt(z,U,M),e.write(z).catch(()=>s.error("Sending response failed."))}function _(k,U,M){k===void 0&&(k=null);let z={jsonrpc:h,id:o.id,result:k};mt(z,U,M),e.write(z).catch(()=>s.error("Sending response failed."))}no(o);let q=g.get(o.method),j,I;q&&(j=q.type,I=q.handler);let V=Date.now();if(I||l){let k=o.id??String(Date.now()),U=Ot.is(ge.receiver)?ge.receiver.createCancellationTokenSource(k):ge.receiver.createCancellationTokenSource(o);o.id!==null&&$.has(o.id)&&U.cancel(),o.id!==null&&G.set(k,U);try{let M;if(I)if(o.params===void 0){if(j!==void 0&&j.numberOfParams!==0){d(new v.ResponseError(v.ErrorCodes.InvalidParams,`Request ${o.method} defines ${j.numberOfParams} params but received none.`),o.method,V);return}M=I(U.token)}else if(Array.isArray(o.params)){if(j!==void 0&&j.parameterStructures===v.ParameterStructures.byName){d(new v.ResponseError(v.ErrorCodes.InvalidParams,`Request ${o.method} defines parameters by name but received parameters by position`),o.method,V);return}M=I(...o.params,U.token)}else{if(j!==void 0&&j.parameterStructures===v.ParameterStructures.byPosition){d(new v.ResponseError(v.ErrorCodes.InvalidParams,`Request ${o.method} defines parameters by position but received parameters by name`),o.method,V);return}M=I(o.params,U.token)}else l&&(M=l(o.method,o.params,U.token));let z=M;M?z.then?z.then(Q=>{G.delete(k),u(Q,o.method,V)},Q=>{G.delete(k),Q instanceof v.ResponseError?d(Q,o.method,V):Q&&W.string(Q.message)?d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed with message: ${Q.message}`),o.method,V):d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed unexpectedly without providing any details.`),o.method,V)}):(G.delete(k),u(M,o.method,V)):(G.delete(k),_(M,o.method,V))}catch(M){G.delete(k),M instanceof v.ResponseError?u(M,o.method,V):M&&W.string(M.message)?d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed with message: ${M.message}`),o.method,V):d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed unexpectedly without providing any details.`),o.method,V)}}else d(new v.ResponseError(v.ErrorCodes.MethodNotFound,`Unhandled method ${o.method}`),o.method,V)}function Qi(o){if(!Me())if(o.id===null)o.error?s.error(`Received response message without id: Error is: 
${JSON.stringify(o.error,void 0,4)}`):s.error("Received response message without id. No further error information provided.");else{let u=o.id,d=L.get(u);if(so(o,d),d!==void 0){L.delete(u);try{if(o.error){let _=o.error;d.reject(new v.ResponseError(_.code,_.message,_.data))}else if(o.result!==void 0)d.resolve(o.result);else throw new Error("Should never happen.")}catch(_){_.message?s.error(`Response handler '${d.method}' failed with message: ${_.message}`):s.error(`Response handler '${d.method}' failed unexpectedly.`)}}}}function Zi(o){if(Me())return;let u,d;if(o.method===ot.type.method){let _=o.params.id;$.delete(_),Zt(o);return}else{let _=m.get(o.method);_&&(d=_.handler,u=_.type)}if(d||p)try{if(Zt(o),d)if(o.params===void 0)u!==void 0&&u.numberOfParams!==0&&u.parameterStructures!==v.ParameterStructures.byName&&s.error(`Notification ${o.method} defines ${u.numberOfParams} params but received none.`),d();else if(Array.isArray(o.params)){let _=o.params;o.method===st.type.method&&_.length===2&&Kr.is(_[0])?d({token:_[0],value:_[1]}):(u!==void 0&&(u.parameterStructures===v.ParameterStructures.byName&&s.error(`Notification ${o.method} defines parameters by name but received parameters by position`),u.numberOfParams!==o.params.length&&s.error(`Notification ${o.method} defines ${u.numberOfParams} params but received ${_.length} arguments`)),d(..._))}else u!==void 0&&u.parameterStructures===v.ParameterStructures.byPosition&&s.error(`Notification ${o.method} defines parameters by position but received parameters by name`),d(o.params);else p&&p(o.method,o.params)}catch(_){_.message?s.error(`Notification handler '${o.method}' failed with message: ${_.message}`):s.error(`Notification handler '${o.method}' failed unexpectedly.`)}else J.fire(o)}function eo(o){if(!o){s.error("Received empty message.");return}s.error(`Received message which is neither a response nor a notification message:
${JSON.stringify(o,null,4)}`);let u=o;if(W.string(u.id)||W.number(u.id)){let d=u.id,_=L.get(d);_&&_.reject(new Error("The received response has neither a result nor an error property."))}}function ye(o){if(o!=null)switch(x){case R.Verbose:return JSON.stringify(o,null,4);case R.Compact:return JSON.stringify(o);default:return}}function to(o){if(!(x===R.Off||!E))if(b===te.Text){let u;(x===R.Verbose||x===R.Compact)&&o.params&&(u=`Params: ${ye(o.params)}

`),E.log(`Sending request '${o.method} - (${o.id})'.`,u)}else je("send-request",o)}function ro(o){if(!(x===R.Off||!E))if(b===te.Text){let u;(x===R.Verbose||x===R.Compact)&&(o.params?u=`Params: ${ye(o.params)}

`:u=`No parameters provided.

`),E.log(`Sending notification '${o.method}'.`,u)}else je("send-notification",o)}function mt(o,u,d){if(!(x===R.Off||!E))if(b===te.Text){let _;(x===R.Verbose||x===R.Compact)&&(o.error&&o.error.data?_=`Error data: ${ye(o.error.data)}

`:o.result?_=`Result: ${ye(o.result)}

`:o.error===void 0&&(_=`No result returned.

`)),E.log(`Sending response '${u} - (${o.id})'. Processing request took ${Date.now()-d}ms`,_)}else je("send-response",o)}function no(o){if(!(x===R.Off||!E))if(b===te.Text){let u;(x===R.Verbose||x===R.Compact)&&o.params&&(u=`Params: ${ye(o.params)}

`),E.log(`Received request '${o.method} - (${o.id})'.`,u)}else je("receive-request",o)}function Zt(o){if(!(x===R.Off||!E||o.method===Ct.type.method))if(b===te.Text){let u;(x===R.Verbose||x===R.Compact)&&(o.params?u=`Params: ${ye(o.params)}

`:u=`No parameters provided.

`),E.log(`Received notification '${o.method}'.`,u)}else je("receive-notification",o)}function so(o,u){if(!(x===R.Off||!E))if(b===te.Text){let d;if((x===R.Verbose||x===R.Compact)&&(o.error&&o.error.data?d=`Error data: ${ye(o.error.data)}

`:o.result?d=`Result: ${ye(o.result)}

`:o.error===void 0&&(d=`No result returned.

`)),u){let _=o.error?` Request failed: ${o.error.message} (${o.error.code}).`:"";E.log(`Received response '${u.method} - (${o.id})' in ${Date.now()-u.timerStart}ms.${_}`,d)}else E.log(`Received response ${o.id} without active response promise.`,d)}else je("receive-response",o)}function je(o,u){if(!E||x===R.Off)return;let d={isLSPMessage:!0,type:o,message:u,timestamp:Date.now()};E.log(d)}function Ze(){if(Fn())throw new We(it.Closed,"Connection is closed.");if(Me())throw new We(it.Disposed,"Connection is disposed.")}function io(){if(Wn())throw new We(it.AlreadyListening,"Connection is already listening")}function oo(){if(!Wn())throw new Error("Call listen() first.")}function et(o){return o===void 0?null:o}function Hn(o){if(o!==null)return o}function Jn(o){return o!=null&&!Array.isArray(o)&&typeof o=="object"}function er(o,u){switch(o){case v.ParameterStructures.auto:return Jn(u)?Hn(u):[et(u)];case v.ParameterStructures.byName:if(!Jn(u))throw new Error("Received parameters by name but param is not an object literal.");return Hn(u);case v.ParameterStructures.byPosition:return[et(u)];default:throw new Error(`Unknown parameter structure ${o.toString()}`)}}function Yn(o,u){let d,_=o.numberOfParams;switch(_){case 0:d=void 0;break;case 1:d=er(o.parameterStructures,u[0]);break;default:d=[];for(let q=0;q<u.length&&q<_;q++)d.push(et(u[q]));if(u.length<_)for(let q=u.length;q<_;q++)d.push(null);break}return d}let Ie={sendNotification:(o,...u)=>{Ze();let d,_;if(W.string(o)){d=o;let j=u[0],I=0,V=v.ParameterStructures.auto;v.ParameterStructures.is(j)&&(I=1,V=j);let k=u.length,U=k-I;switch(U){case 0:_=void 0;break;case 1:_=er(V,u[I]);break;default:if(V===v.ParameterStructures.byName)throw new Error(`Received ${U} parameters for 'by Name' notification parameter structure.`);_=u.slice(I,k).map(M=>et(M));break}}else{let j=u;d=o.method,_=Yn(o,j)}let q={jsonrpc:h,method:d,params:_};return ro(q),e.write(q).catch(j=>{throw s.error("Sending notification failed."),j})},onNotification:(o,u)=>{Ze();let d;return W.func(o)?p=o:u&&(W.string(o)?(d=o,m.set(o,{type:void 0,handler:u})):(d=o.method,m.set(o.method,{type:o,handler:u}))),{dispose:()=>{d!==void 0?m.delete(d):p=void 0}}},onProgress:(o,u,d)=>{if(S.has(u))throw new Error(`Progress handler for token ${u} already registered`);return S.set(u,d),{dispose:()=>{S.delete(u)}}},sendProgress:(o,u,d)=>Ie.sendNotification(st.type,{token:u,value:d}),onUnhandledProgress:Z.event,sendRequest:(o,...u)=>{Ze(),oo();let d,_,q;if(W.string(o)){d=o;let k=u[0],U=u[u.length-1],M=0,z=v.ParameterStructures.auto;v.ParameterStructures.is(k)&&(M=1,z=k);let Q=u.length;Yr.CancellationToken.is(U)&&(Q=Q-1,q=U);let le=Q-M;switch(le){case 0:_=void 0;break;case 1:_=er(z,u[M]);break;default:if(z===v.ParameterStructures.byName)throw new Error(`Received ${le} parameters for 'by Name' request parameter structure.`);_=u.slice(M,Q).map(ao=>et(ao));break}}else{let k=u;d=o.method,_=Yn(o,k);let U=o.numberOfParams;q=Yr.CancellationToken.is(k[U])?k[U]:void 0}let j=i++,I;q&&(I=q.onCancellationRequested(()=>{let k=ge.sender.sendCancellation(Ie,j);return k===void 0?(s.log(`Received no promise from cancellation strategy when cancelling id ${j}`),Promise.resolve()):k.catch(()=>{s.log(`Sending cancellation messages for id ${j} failed`)})}));let V={jsonrpc:h,id:j,method:d,params:_};return to(V),typeof ge.sender.enableCancellation=="function"&&ge.sender.enableCancellation(V),new Promise(async(k,U)=>{let M=le=>{k(le),ge.sender.cleanup(j),I==null||I.dispose()},z=le=>{U(le),ge.sender.cleanup(j),I==null||I.dispose()},Q={method:d,timerStart:Date.now(),resolve:M,reject:z};try{L.set(j,Q),await e.write(V)}catch(le){throw L.delete(j),Q.reject(new v.ResponseError(v.ErrorCodes.MessageWriteError,le.message?le.message:"Unknown reason")),s.error("Sending request failed."),le}})},onRequest:(o,u)=>{Ze();let d=null;return Qr.is(o)?(d=void 0,l=o):W.string(o)?(d=null,u!==void 0&&(d=o,g.set(o,{handler:u,type:void 0}))):u!==void 0&&(d=o.method,g.set(o.method,{type:o,handler:u})),{dispose:()=>{d!==null&&(d!==void 0?g.delete(d):l=void 0)}}},hasPendingResponse:()=>L.size>0,trace:async(o,u,d)=>{let _=!1,q=te.Text;d!==void 0&&(W.boolean(d)?_=d:(_=d.sendNotification||!1,q=d.traceFormat||te.Text)),x=o,b=q,x===R.Off?E=void 0:E=u,_&&!Fn()&&!Me()&&await Ie.sendNotification(Zr.type,{value:R.toString(o)})},onError:O.event,onClose:oe.event,onUnhandledNotification:J.event,onDispose:$n.event,end:()=>{e.end()},dispose:()=>{if(Me())return;F=ce.Disposed,$n.fire(void 0);let o=new v.ResponseError(v.ErrorCodes.PendingResponseRejected,"Pending response rejected since connection got disposed");for(let u of L.values())u.reject(o);L=new Map,G=new Map,$=new Set,w=new _s.LinkedMap,W.func(e.dispose)&&e.dispose(),W.func(r.dispose)&&r.dispose()},listen:()=>{Ze(),io(),F=ce.Listening,r.listen(Ki)},inspect:()=>{(0,ms.default)().console.log("inspect")}};return Ie.onNotification(Ct.type,o=>{if(x===R.Off||!E)return;let u=x===R.Verbose||x===R.Compact;E.log(o.message,u?o.verbose:void 0)}),Ie.onNotification(st.type,o=>{let u=S.get(o.token);u?u(o.value):Z.fire(o)}),Ie}T.createMessageConnection=Mo});var Lt=N(c=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});c.ProgressType=c.ProgressToken=c.createMessageConnection=c.NullLogger=c.ConnectionOptions=c.ConnectionStrategy=c.AbstractMessageBuffer=c.WriteableStreamMessageWriter=c.AbstractMessageWriter=c.MessageWriter=c.ReadableStreamMessageReader=c.AbstractMessageReader=c.MessageReader=c.SharedArrayReceiverStrategy=c.SharedArraySenderStrategy=c.CancellationToken=c.CancellationTokenSource=c.Emitter=c.Event=c.Disposable=c.LRUCache=c.Touch=c.LinkedMap=c.ParameterStructures=c.NotificationType9=c.NotificationType8=c.NotificationType7=c.NotificationType6=c.NotificationType5=c.NotificationType4=c.NotificationType3=c.NotificationType2=c.NotificationType1=c.NotificationType0=c.NotificationType=c.ErrorCodes=c.ResponseError=c.RequestType9=c.RequestType8=c.RequestType7=c.RequestType6=c.RequestType5=c.RequestType4=c.RequestType3=c.RequestType2=c.RequestType1=c.RequestType0=c.RequestType=c.Message=c.RAL=void 0;c.MessageStrategy=c.CancellationStrategy=c.CancellationSenderStrategy=c.CancellationReceiverStrategy=c.ConnectionError=c.ConnectionErrors=c.LogTraceNotification=c.SetTraceNotification=c.TraceFormat=c.TraceValues=c.Trace=void 0;var D=Tr();Object.defineProperty(c,"Message",{enumerable:!0,get:function(){return D.Message}});Object.defineProperty(c,"RequestType",{enumerable:!0,get:function(){return D.RequestType}});Object.defineProperty(c,"RequestType0",{enumerable:!0,get:function(){return D.RequestType0}});Object.defineProperty(c,"RequestType1",{enumerable:!0,get:function(){return D.RequestType1}});Object.defineProperty(c,"RequestType2",{enumerable:!0,get:function(){return D.RequestType2}});Object.defineProperty(c,"RequestType3",{enumerable:!0,get:function(){return D.RequestType3}});Object.defineProperty(c,"RequestType4",{enumerable:!0,get:function(){return D.RequestType4}});Object.defineProperty(c,"RequestType5",{enumerable:!0,get:function(){return D.RequestType5}});Object.defineProperty(c,"RequestType6",{enumerable:!0,get:function(){return D.RequestType6}});Object.defineProperty(c,"RequestType7",{enumerable:!0,get:function(){return D.RequestType7}});Object.defineProperty(c,"RequestType8",{enumerable:!0,get:function(){return D.RequestType8}});Object.defineProperty(c,"RequestType9",{enumerable:!0,get:function(){return D.RequestType9}});Object.defineProperty(c,"ResponseError",{enumerable:!0,get:function(){return D.ResponseError}});Object.defineProperty(c,"ErrorCodes",{enumerable:!0,get:function(){return D.ErrorCodes}});Object.defineProperty(c,"NotificationType",{enumerable:!0,get:function(){return D.NotificationType}});Object.defineProperty(c,"NotificationType0",{enumerable:!0,get:function(){return D.NotificationType0}});Object.defineProperty(c,"NotificationType1",{enumerable:!0,get:function(){return D.NotificationType1}});Object.defineProperty(c,"NotificationType2",{enumerable:!0,get:function(){return D.NotificationType2}});Object.defineProperty(c,"NotificationType3",{enumerable:!0,get:function(){return D.NotificationType3}});Object.defineProperty(c,"NotificationType4",{enumerable:!0,get:function(){return D.NotificationType4}});Object.defineProperty(c,"NotificationType5",{enumerable:!0,get:function(){return D.NotificationType5}});Object.defineProperty(c,"NotificationType6",{enumerable:!0,get:function(){return D.NotificationType6}});Object.defineProperty(c,"NotificationType7",{enumerable:!0,get:function(){return D.NotificationType7}});Object.defineProperty(c,"NotificationType8",{enumerable:!0,get:function(){return D.NotificationType8}});Object.defineProperty(c,"NotificationType9",{enumerable:!0,get:function(){return D.NotificationType9}});Object.defineProperty(c,"ParameterStructures",{enumerable:!0,get:function(){return D.ParameterStructures}});var rn=Or();Object.defineProperty(c,"LinkedMap",{enumerable:!0,get:function(){return rn.LinkedMap}});Object.defineProperty(c,"LRUCache",{enumerable:!0,get:function(){return rn.LRUCache}});Object.defineProperty(c,"Touch",{enumerable:!0,get:function(){return rn.Touch}});var jo=os();Object.defineProperty(c,"Disposable",{enumerable:!0,get:function(){return jo.Disposable}});var Ss=Be();Object.defineProperty(c,"Event",{enumerable:!0,get:function(){return Ss.Event}});Object.defineProperty(c,"Emitter",{enumerable:!0,get:function(){return Ss.Emitter}});var vs=vt();Object.defineProperty(c,"CancellationTokenSource",{enumerable:!0,get:function(){return vs.CancellationTokenSource}});Object.defineProperty(c,"CancellationToken",{enumerable:!0,get:function(){return vs.CancellationToken}});var Es=cs();Object.defineProperty(c,"SharedArraySenderStrategy",{enumerable:!0,get:function(){return Es.SharedArraySenderStrategy}});Object.defineProperty(c,"SharedArrayReceiverStrategy",{enumerable:!0,get:function(){return Es.SharedArrayReceiverStrategy}});var nn=Vr();Object.defineProperty(c,"MessageReader",{enumerable:!0,get:function(){return nn.MessageReader}});Object.defineProperty(c,"AbstractMessageReader",{enumerable:!0,get:function(){return nn.AbstractMessageReader}});Object.defineProperty(c,"ReadableStreamMessageReader",{enumerable:!0,get:function(){return nn.ReadableStreamMessageReader}});var sn=Hr();Object.defineProperty(c,"MessageWriter",{enumerable:!0,get:function(){return sn.MessageWriter}});Object.defineProperty(c,"AbstractMessageWriter",{enumerable:!0,get:function(){return sn.AbstractMessageWriter}});Object.defineProperty(c,"WriteableStreamMessageWriter",{enumerable:!0,get:function(){return sn.WriteableStreamMessageWriter}});var Io=ps();Object.defineProperty(c,"AbstractMessageBuffer",{enumerable:!0,get:function(){return Io.AbstractMessageBuffer}});var Y=bs();Object.defineProperty(c,"ConnectionStrategy",{enumerable:!0,get:function(){return Y.ConnectionStrategy}});Object.defineProperty(c,"ConnectionOptions",{enumerable:!0,get:function(){return Y.ConnectionOptions}});Object.defineProperty(c,"NullLogger",{enumerable:!0,get:function(){return Y.NullLogger}});Object.defineProperty(c,"createMessageConnection",{enumerable:!0,get:function(){return Y.createMessageConnection}});Object.defineProperty(c,"ProgressToken",{enumerable:!0,get:function(){return Y.ProgressToken}});Object.defineProperty(c,"ProgressType",{enumerable:!0,get:function(){return Y.ProgressType}});Object.defineProperty(c,"Trace",{enumerable:!0,get:function(){return Y.Trace}});Object.defineProperty(c,"TraceValues",{enumerable:!0,get:function(){return Y.TraceValues}});Object.defineProperty(c,"TraceFormat",{enumerable:!0,get:function(){return Y.TraceFormat}});Object.defineProperty(c,"SetTraceNotification",{enumerable:!0,get:function(){return Y.SetTraceNotification}});Object.defineProperty(c,"LogTraceNotification",{enumerable:!0,get:function(){return Y.LogTraceNotification}});Object.defineProperty(c,"ConnectionErrors",{enumerable:!0,get:function(){return Y.ConnectionErrors}});Object.defineProperty(c,"ConnectionError",{enumerable:!0,get:function(){return Y.ConnectionError}});Object.defineProperty(c,"CancellationReceiverStrategy",{enumerable:!0,get:function(){return Y.CancellationReceiverStrategy}});Object.defineProperty(c,"CancellationSenderStrategy",{enumerable:!0,get:function(){return Y.CancellationSenderStrategy}});Object.defineProperty(c,"CancellationStrategy",{enumerable:!0,get:function(){return Y.CancellationStrategy}});Object.defineProperty(c,"MessageStrategy",{enumerable:!0,get:function(){return Y.MessageStrategy}});var Do=Se();c.RAL=Do.default});var Ts=N(un=>{"use strict";Object.defineProperty(un,"__esModule",{value:!0});var ws=require("util"),de=Lt(),Mt=class r extends de.AbstractMessageBuffer{constructor(e="utf-8"){super(e)}emptyBuffer(){return r.emptyBuffer}fromString(e,t){return Buffer.from(e,t)}toString(e,t){return e instanceof Buffer?e.toString(t):new ws.TextDecoder(t).decode(e)}asNative(e,t){return t===void 0?e instanceof Buffer?e:Buffer.from(e):e instanceof Buffer?e.slice(0,t):Buffer.from(e,0,t)}allocNative(e){return Buffer.allocUnsafe(e)}};Mt.emptyBuffer=Buffer.allocUnsafe(0);var on=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),de.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),de.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),de.Disposable.create(()=>this.stream.off("end",e))}onData(e){return this.stream.on("data",e),de.Disposable.create(()=>this.stream.off("data",e))}},an=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),de.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),de.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),de.Disposable.create(()=>this.stream.off("end",e))}write(e,t){return new Promise((n,s)=>{let i=a=>{a==null?n():s(a)};typeof e=="string"?this.stream.write(e,t,i):this.stream.write(e,i)})}end(){this.stream.end()}},xs=Object.freeze({messageBuffer:Object.freeze({create:r=>new Mt(r)}),applicationJson:Object.freeze({encoder:Object.freeze({name:"application/json",encode:(r,e)=>{try{return Promise.resolve(Buffer.from(JSON.stringify(r,void 0,0),e.charset))}catch(t){return Promise.reject(t)}}}),decoder:Object.freeze({name:"application/json",decode:(r,e)=>{try{return r instanceof Buffer?Promise.resolve(JSON.parse(r.toString(e.charset))):Promise.resolve(JSON.parse(new ws.TextDecoder(e.charset).decode(r)))}catch(t){return Promise.reject(t)}}})}),stream:Object.freeze({asReadableStream:r=>new on(r),asWritableStream:r=>new an(r)}),console,timer:Object.freeze({setTimeout(r,e,...t){let n=setTimeout(r,e,...t);return{dispose:()=>clearTimeout(n)}},setImmediate(r,...e){let t=setImmediate(r,...e);return{dispose:()=>clearImmediate(t)}},setInterval(r,e,...t){let n=setInterval(r,e,...t);return{dispose:()=>clearInterval(n)}}})});function cn(){return xs}(function(r){function e(){de.RAL.install(xs)}r.install=e})(cn||(cn={}));un.default=cn});var pn=N(P=>{"use strict";var qo=P&&P.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,n,s)}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),Bo=P&&P.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&qo(e,r,t)};Object.defineProperty(P,"__esModule",{value:!0});P.createMessageConnection=P.createServerSocketTransport=P.createClientSocketTransport=P.createServerPipeTransport=P.createClientPipeTransport=P.generateRandomPipeName=P.StreamMessageWriter=P.StreamMessageReader=P.SocketMessageWriter=P.SocketMessageReader=P.PortMessageWriter=P.PortMessageReader=P.IPCMessageWriter=P.IPCMessageReader=void 0;var Fe=Ts();Fe.default.install();var Cs=require("path"),Ao=require("os"),$o=require("crypto"),Dt=require("net"),re=Lt();Bo(Lt(),P);var ln=class extends re.AbstractMessageReader{constructor(e){super(),this.process=e;let t=this.process;t.on("error",n=>this.fireError(n)),t.on("close",()=>this.fireClose())}listen(e){return this.process.on("message",e),re.Disposable.create(()=>this.process.off("message",e))}};P.IPCMessageReader=ln;var fn=class extends re.AbstractMessageWriter{constructor(e){super(),this.process=e,this.errorCount=0;let t=this.process;t.on("error",n=>this.fireError(n)),t.on("close",()=>this.fireClose)}write(e){try{return typeof this.process.send=="function"&&this.process.send(e,void 0,void 0,t=>{t?(this.errorCount++,this.handleError(t,e)):this.errorCount=0}),Promise.resolve()}catch(t){return this.handleError(t,e),Promise.reject(t)}}handleError(e,t){this.errorCount++,this.fireError(e,t,this.errorCount)}end(){}};P.IPCMessageWriter=fn;var dn=class extends re.AbstractMessageReader{constructor(e){super(),this.onData=new re.Emitter,e.on("close",()=>this.fireClose),e.on("error",t=>this.fireError(t)),e.on("message",t=>{this.onData.fire(t)})}listen(e){return this.onData.event(e)}};P.PortMessageReader=dn;var hn=class extends re.AbstractMessageWriter{constructor(e){super(),this.port=e,this.errorCount=0,e.on("close",()=>this.fireClose()),e.on("error",t=>this.fireError(t))}write(e){try{return this.port.postMessage(e),Promise.resolve()}catch(t){return this.handleError(t,e),Promise.reject(t)}}handleError(e,t){this.errorCount++,this.fireError(e,t,this.errorCount)}end(){}};P.PortMessageWriter=hn;var Ce=class extends re.ReadableStreamMessageReader{constructor(e,t="utf-8"){super((0,Fe.default)().stream.asReadableStream(e),t)}};P.SocketMessageReader=Ce;var Oe=class extends re.WriteableStreamMessageWriter{constructor(e,t){super((0,Fe.default)().stream.asWritableStream(e),t),this.socket=e}dispose(){super.dispose(),this.socket.destroy()}};P.SocketMessageWriter=Oe;var jt=class extends re.ReadableStreamMessageReader{constructor(e,t){super((0,Fe.default)().stream.asReadableStream(e),t)}};P.StreamMessageReader=jt;var It=class extends re.WriteableStreamMessageWriter{constructor(e,t){super((0,Fe.default)().stream.asWritableStream(e),t)}};P.StreamMessageWriter=It;var Os=process.env.XDG_RUNTIME_DIR,Uo=new Map([["linux",107],["darwin",103]]);function Wo(){let r=(0,$o.randomBytes)(21).toString("hex");if(process.platform==="win32")return`\\\\.\\pipe\\vscode-jsonrpc-${r}-sock`;let e;Os?e=Cs.join(Os,`vscode-ipc-${r}.sock`):e=Cs.join(Ao.tmpdir(),`vscode-${r}.sock`);let t=Uo.get(process.platform);return t!==void 0&&e.length>t&&(0,Fe.default)().console.warn(`WARNING: IPC handle "${e}" is longer than ${t} characters.`),e}P.generateRandomPipeName=Wo;function Fo(r,e="utf-8"){let t,n=new Promise((s,i)=>{t=s});return new Promise((s,i)=>{let a=(0,Dt.createServer)(f=>{a.close(),t([new Ce(f,e),new Oe(f,e)])});a.on("error",i),a.listen(r,()=>{a.removeListener("error",i),s({onConnected:()=>n})})})}P.createClientPipeTransport=Fo;function Vo(r,e="utf-8"){let t=(0,Dt.createConnection)(r);return[new Ce(t,e),new Oe(t,e)]}P.createServerPipeTransport=Vo;function Go(r,e="utf-8"){let t,n=new Promise((s,i)=>{t=s});return new Promise((s,i)=>{let a=(0,Dt.createServer)(f=>{a.close(),t([new Ce(f,e),new Oe(f,e)])});a.on("error",i),a.listen(r,"127.0.0.1",()=>{a.removeListener("error",i),s({onConnected:()=>n})})})}P.createClientSocketTransport=Go;function zo(r,e="utf-8"){let t=(0,Dt.createConnection)(r,"127.0.0.1");return[new Ce(t,e),new Oe(t,e)]}P.createServerSocketTransport=zo;function Ho(r){let e=r;return e.read!==void 0&&e.addListener!==void 0}function Jo(r){let e=r;return e.write!==void 0&&e.addListener!==void 0}function Yo(r,e,t,n){t||(t=re.NullLogger);let s=Ho(r)?new jt(r):r,i=Jo(e)?new It(e):e;return re.ConnectionStrategy.is(n)&&(n={connectionStrategy:n}),(0,re.createMessageConnection)(s,i,t,n)}P.createMessageConnection=Yo});var Rs=N((Vc,Ns)=>{"use strict";Ns.exports=pn()});var he=N((eu,As)=>{"use strict";var qs=["nodebuffer","arraybuffer","fragments"],Bs=typeof Blob<"u";Bs&&qs.push("blob");As.exports={BINARY_TYPES:qs,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:Bs,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var at=N((tu,$t)=>{"use strict";var{EMPTY_BUFFER:Qo}=he(),_n=Buffer[Symbol.species];function Zo(r,e){if(r.length===0)return Qo;if(r.length===1)return r[0];let t=Buffer.allocUnsafe(e),n=0;for(let s=0;s<r.length;s++){let i=r[s];t.set(i,n),n+=i.length}return n<e?new _n(t.buffer,t.byteOffset,n):t}function $s(r,e,t,n,s){for(let i=0;i<s;i++)t[n+i]=r[i]^e[i&3]}function Us(r,e){for(let t=0;t<r.length;t++)r[t]^=e[t&3]}function ea(r){return r.length===r.buffer.byteLength?r.buffer:r.buffer.slice(r.byteOffset,r.byteOffset+r.length)}function gn(r){if(gn.readOnly=!0,Buffer.isBuffer(r))return r;let e;return r instanceof ArrayBuffer?e=new _n(r):ArrayBuffer.isView(r)?e=new _n(r.buffer,r.byteOffset,r.byteLength):(e=Buffer.from(r),gn.readOnly=!1),e}$t.exports={concat:Zo,mask:$s,toArrayBuffer:ea,toBuffer:gn,unmask:Us};if(!process.env.WS_NO_BUFFER_UTIL)try{let r=require("bufferutil");$t.exports.mask=function(e,t,n,s,i){i<48?$s(e,t,n,s,i):r.mask(e,t,n,s,i)},$t.exports.unmask=function(e,t){e.length<32?Us(e,t):r.unmask(e,t)}}catch{}});var Vs=N((ru,Fs)=>{"use strict";var Ws=Symbol("kDone"),yn=Symbol("kRun"),bn=class{constructor(e){this[Ws]=()=>{this.pending--,this[yn]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[yn]()}[yn](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[Ws])}}};Fs.exports=bn});var ut=N((nu,Js)=>{"use strict";var ct=require("zlib"),Gs=at(),ta=Vs(),{kStatusCode:zs}=he(),ra=Buffer[Symbol.species],na=Buffer.from([0,0,255,255]),Wt=Symbol("permessage-deflate"),pe=Symbol("total-length"),Ge=Symbol("callback"),we=Symbol("buffers"),ze=Symbol("error"),Ut,Sn=class{constructor(e,t,n){if(this._maxPayload=n|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Ut){let s=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Ut=new ta(s)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[Ge];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,n=e.find(s=>!(t.serverNoContextTakeover===!1&&s.server_no_context_takeover||s.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>s.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!s.client_max_window_bits));if(!n)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(n.server_no_context_takeover=!0),t.clientNoContextTakeover&&(n.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(n.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?n.client_max_window_bits=t.clientMaxWindowBits:(n.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete n.client_max_window_bits,n}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(n=>{let s=t[n];if(s.length>1)throw new Error(`Parameter "${n}" must have only a single value`);if(s=s[0],n==="client_max_window_bits"){if(s!==!0){let i=+s;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${n}": ${s}`);s=i}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${n}": ${s}`)}else if(n==="server_max_window_bits"){let i=+s;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${n}": ${s}`);s=i}else if(n==="client_no_context_takeover"||n==="server_no_context_takeover"){if(s!==!0)throw new TypeError(`Invalid value for parameter "${n}": ${s}`)}else throw new Error(`Unknown parameter "${n}"`);t[n]=s})}),e}decompress(e,t,n){Ut.add(s=>{this._decompress(e,t,(i,a)=>{s(),n(i,a)})})}compress(e,t,n){Ut.add(s=>{this._compress(e,t,(i,a)=>{s(),n(i,a)})})}_decompress(e,t,n){let s=this._isServer?"client":"server";if(!this._inflate){let i=`${s}_max_window_bits`,a=typeof this.params[i]!="number"?ct.Z_DEFAULT_WINDOWBITS:this.params[i];this._inflate=ct.createInflateRaw({...this._options.zlibInflateOptions,windowBits:a}),this._inflate[Wt]=this,this._inflate[pe]=0,this._inflate[we]=[],this._inflate.on("error",ia),this._inflate.on("data",Hs)}this._inflate[Ge]=n,this._inflate.write(e),t&&this._inflate.write(na),this._inflate.flush(()=>{let i=this._inflate[ze];if(i){this._inflate.close(),this._inflate=null,n(i);return}let a=Gs.concat(this._inflate[we],this._inflate[pe]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[pe]=0,this._inflate[we]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),n(null,a)})}_compress(e,t,n){let s=this._isServer?"server":"client";if(!this._deflate){let i=`${s}_max_window_bits`,a=typeof this.params[i]!="number"?ct.Z_DEFAULT_WINDOWBITS:this.params[i];this._deflate=ct.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:a}),this._deflate[pe]=0,this._deflate[we]=[],this._deflate.on("data",sa)}this._deflate[Ge]=n,this._deflate.write(e),this._deflate.flush(ct.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let i=Gs.concat(this._deflate[we],this._deflate[pe]);t&&(i=new ra(i.buffer,i.byteOffset,i.length-4)),this._deflate[Ge]=null,this._deflate[pe]=0,this._deflate[we]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),n(null,i)})}};Js.exports=Sn;function sa(r){this[we].push(r),this[pe]+=r.length}function Hs(r){if(this[pe]+=r.length,this[Wt]._maxPayload<1||this[pe]<=this[Wt]._maxPayload){this[we].push(r);return}this[ze]=new RangeError("Max payload size exceeded"),this[ze].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[ze][zs]=1009,this.removeListener("data",Hs),this.reset()}function ia(r){if(this[Wt]._inflate=null,this[ze]){this[Ge](this[ze]);return}r[zs]=1007,this[Ge](r)}});var He=N((su,Ft)=>{"use strict";var{isUtf8:Ys}=require("buffer"),{hasBlob:oa}=he(),aa=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function ca(r){return r>=1e3&&r<=1014&&r!==1004&&r!==1005&&r!==1006||r>=3e3&&r<=4999}function vn(r){let e=r.length,t=0;for(;t<e;)if((r[t]&128)===0)t++;else if((r[t]&224)===192){if(t+1===e||(r[t+1]&192)!==128||(r[t]&254)===192)return!1;t+=2}else if((r[t]&240)===224){if(t+2>=e||(r[t+1]&192)!==128||(r[t+2]&192)!==128||r[t]===224&&(r[t+1]&224)===128||r[t]===237&&(r[t+1]&224)===160)return!1;t+=3}else if((r[t]&248)===240){if(t+3>=e||(r[t+1]&192)!==128||(r[t+2]&192)!==128||(r[t+3]&192)!==128||r[t]===240&&(r[t+1]&240)===128||r[t]===244&&r[t+1]>143||r[t]>244)return!1;t+=4}else return!1;return!0}function ua(r){return oa&&typeof r=="object"&&typeof r.arrayBuffer=="function"&&typeof r.type=="string"&&typeof r.stream=="function"&&(r[Symbol.toStringTag]==="Blob"||r[Symbol.toStringTag]==="File")}Ft.exports={isBlob:ua,isValidStatusCode:ca,isValidUTF8:vn,tokenChars:aa};if(Ys)Ft.exports.isValidUTF8=function(r){return r.length<24?vn(r):Ys(r)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let r=require("utf-8-validate");Ft.exports.isValidUTF8=function(e){return e.length<32?vn(e):r(e)}}catch{}});var Cn=N((iu,ri)=>{"use strict";var{Writable:la}=require("stream"),Ks=ut(),{BINARY_TYPES:fa,EMPTY_BUFFER:Xs,kStatusCode:da,kWebSocket:ha}=he(),{concat:En,toArrayBuffer:pa,unmask:ma}=at(),{isValidStatusCode:_a,isValidUTF8:Qs}=He(),Vt=Buffer[Symbol.species],se=0,Zs=1,ei=2,ti=3,wn=4,xn=5,Gt=6,Tn=class extends la{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||fa[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[ha]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=se}_write(e,t,n){if(this._opcode===8&&this._state==se)return n();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(n)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let n=this._buffers[0];return this._buffers[0]=new Vt(n.buffer,n.byteOffset+e,n.length-e),new Vt(n.buffer,n.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let n=this._buffers[0],s=t.length-e;e>=n.length?t.set(this._buffers.shift(),s):(t.set(new Uint8Array(n.buffer,n.byteOffset,e),s),this._buffers[0]=new Vt(n.buffer,n.byteOffset+e,n.length-e)),e-=n.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case se:this.getInfo(e);break;case Zs:this.getPayloadLength16(e);break;case ei:this.getPayloadLength64(e);break;case ti:this.getMask();break;case wn:this.getData(e);break;case xn:case Gt:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if((t[0]&48)!==0){let s=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(s);return}let n=(t[0]&64)===64;if(n&&!this._extensions[Ks.extensionName]){let s=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(s);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(n){let s=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(s);return}if(!this._fragmented){let s=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(s);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let s=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(s);return}this._compressed=n}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let s=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(s);return}if(n){let s=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(s);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let s=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(s);return}}else{let s=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(s);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let s=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(s);return}}else if(this._masked){let s=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(s);return}this._payloadLength===126?this._state=Zs:this._payloadLength===127?this._state=ei:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),n=t.readUInt32BE(0);if(n>Math.pow(2,21)-1){let s=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(s);return}this._payloadLength=n*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=ti:this._state=wn}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=wn}getData(e){let t=Xs;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!==0&&ma(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=xn,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[Ks.extensionName].decompress(e,this._fin,(s,i)=>{if(s)return t(s);if(i.length){if(this._messageLength+=i.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let a=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(a);return}this._fragments.push(i)}this.dataMessage(t),this._state===se&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=se;return}let t=this._messageLength,n=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let s;this._binaryType==="nodebuffer"?s=En(n,t):this._binaryType==="arraybuffer"?s=pa(En(n,t)):this._binaryType==="blob"?s=new Blob(n):s=n,this._allowSynchronousEvents?(this.emit("message",s,!0),this._state=se):(this._state=Gt,setImmediate(()=>{this.emit("message",s,!0),this._state=se,this.startLoop(e)}))}else{let s=En(n,t);if(!this._skipUTF8Validation&&!Qs(s)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(i);return}this._state===xn||this._allowSynchronousEvents?(this.emit("message",s,!1),this._state=se):(this._state=Gt,setImmediate(()=>{this.emit("message",s,!1),this._state=se,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,Xs),this.end();else{let n=e.readUInt16BE(0);if(!_a(n)){let i=this.createError(RangeError,`invalid status code ${n}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(i);return}let s=new Vt(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Qs(s)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(i);return}this._loop=!1,this.emit("conclude",n,s),this.end()}this._state=se;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=se):(this._state=Gt,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=se,this.startLoop(t)}))}createError(e,t,n,s,i){this._loop=!1,this._errored=!0;let a=new e(n?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(a,this.createError),a.code=i,a[da]=s,a}};ri.exports=Tn});var kn=N((au,ii)=>{"use strict";var{Duplex:ou}=require("stream"),{randomFillSync:ga}=require("crypto"),ni=ut(),{EMPTY_BUFFER:ya,kWebSocket:ba,NOOP:Sa}=he(),{isBlob:Je,isValidStatusCode:va}=He(),{mask:si,toBuffer:Pe}=at(),ie=Symbol("kByteLength"),Ea=Buffer.alloc(4),zt=8*1024,ke,Ye=zt,ue=0,wa=1,xa=2,On=class r{constructor(e,t,n){this._extensions=t||{},n&&(this._generateMask=n,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=ue,this.onerror=Sa,this[ba]=void 0}static frame(e,t){let n,s=!1,i=2,a=!1;t.mask&&(n=t.maskBuffer||Ea,t.generateMask?t.generateMask(n):(Ye===zt&&(ke===void 0&&(ke=Buffer.alloc(zt)),ga(ke,0,zt),Ye=0),n[0]=ke[Ye++],n[1]=ke[Ye++],n[2]=ke[Ye++],n[3]=ke[Ye++]),a=(n[0]|n[1]|n[2]|n[3])===0,i=6);let f;typeof e=="string"?(!t.mask||a)&&t[ie]!==void 0?f=t[ie]:(e=Buffer.from(e),f=e.length):(f=e.length,s=t.mask&&t.readOnly&&!a);let h=f;f>=65536?(i+=8,h=127):f>125&&(i+=2,h=126);let l=Buffer.allocUnsafe(s?f+i:i);return l[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(l[0]|=64),l[1]=h,h===126?l.writeUInt16BE(f,2):h===127&&(l[2]=l[3]=0,l.writeUIntBE(f,4,6)),t.mask?(l[1]|=128,l[i-4]=n[0],l[i-3]=n[1],l[i-2]=n[2],l[i-1]=n[3],a?[l,e]:s?(si(e,n,l,i,f),[l]):(si(e,n,e,0,f),[l,e])):[l,e]}close(e,t,n,s){let i;if(e===void 0)i=ya;else{if(typeof e!="number"||!va(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0);else{let f=Buffer.byteLength(t);if(f>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+f),i.writeUInt16BE(e,0),typeof t=="string"?i.write(t,2):i.set(t,2)}}let a={[ie]:i.length,fin:!0,generateMask:this._generateMask,mask:n,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._state!==ue?this.enqueue([this.dispatch,i,!1,a,s]):this.sendFrame(r.frame(i,a),s)}ping(e,t,n){let s,i;if(typeof e=="string"?(s=Buffer.byteLength(e),i=!1):Je(e)?(s=e.size,i=!1):(e=Pe(e),s=e.length,i=Pe.readOnly),s>125)throw new RangeError("The data size must not be greater than 125 bytes");let a={[ie]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};Je(e)?this._state!==ue?this.enqueue([this.getBlobData,e,!1,a,n]):this.getBlobData(e,!1,a,n):this._state!==ue?this.enqueue([this.dispatch,e,!1,a,n]):this.sendFrame(r.frame(e,a),n)}pong(e,t,n){let s,i;if(typeof e=="string"?(s=Buffer.byteLength(e),i=!1):Je(e)?(s=e.size,i=!1):(e=Pe(e),s=e.length,i=Pe.readOnly),s>125)throw new RangeError("The data size must not be greater than 125 bytes");let a={[ie]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};Je(e)?this._state!==ue?this.enqueue([this.getBlobData,e,!1,a,n]):this.getBlobData(e,!1,a,n):this._state!==ue?this.enqueue([this.dispatch,e,!1,a,n]):this.sendFrame(r.frame(e,a),n)}send(e,t,n){let s=this._extensions[ni.extensionName],i=t.binary?2:1,a=t.compress,f,h;typeof e=="string"?(f=Buffer.byteLength(e),h=!1):Je(e)?(f=e.size,h=!1):(e=Pe(e),f=e.length,h=Pe.readOnly),this._firstFragment?(this._firstFragment=!1,a&&s&&s.params[s._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=f>=s._threshold),this._compress=a):(a=!1,i=0),t.fin&&(this._firstFragment=!0);let l={[ie]:f,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:h,rsv1:a};Je(e)?this._state!==ue?this.enqueue([this.getBlobData,e,this._compress,l,n]):this.getBlobData(e,this._compress,l,n):this._state!==ue?this.enqueue([this.dispatch,e,this._compress,l,n]):this.dispatch(e,this._compress,l,n)}getBlobData(e,t,n,s){this._bufferedBytes+=n[ie],this._state=xa,e.arrayBuffer().then(i=>{if(this._socket.destroyed){let f=new Error("The socket was closed while the blob was being read");process.nextTick(Pn,this,f,s);return}this._bufferedBytes-=n[ie];let a=Pe(i);t?this.dispatch(a,t,n,s):(this._state=ue,this.sendFrame(r.frame(a,n),s),this.dequeue())}).catch(i=>{process.nextTick(Ta,this,i,s)})}dispatch(e,t,n,s){if(!t){this.sendFrame(r.frame(e,n),s);return}let i=this._extensions[ni.extensionName];this._bufferedBytes+=n[ie],this._state=wa,i.compress(e,n.fin,(a,f)=>{if(this._socket.destroyed){let h=new Error("The socket was closed while data was being compressed");Pn(this,h,s);return}this._bufferedBytes-=n[ie],this._state=ue,n.readOnly=!1,this.sendFrame(r.frame(f,n),s),this.dequeue()})}dequeue(){for(;this._state===ue&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][ie],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][ie],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};ii.exports=On;function Pn(r,e,t){typeof t=="function"&&t(e);for(let n=0;n<r._queue.length;n++){let s=r._queue[n],i=s[s.length-1];typeof i=="function"&&i(e)}}function Ta(r,e,t){Pn(r,e,t),r.onerror(e)}});var pi=N((cu,hi)=>{"use strict";var{kForOnEventAttribute:lt,kListener:Nn}=he(),oi=Symbol("kCode"),ai=Symbol("kData"),ci=Symbol("kError"),ui=Symbol("kMessage"),li=Symbol("kReason"),Ke=Symbol("kTarget"),fi=Symbol("kType"),di=Symbol("kWasClean"),me=class{constructor(e){this[Ke]=null,this[fi]=e}get target(){return this[Ke]}get type(){return this[fi]}};Object.defineProperty(me.prototype,"target",{enumerable:!0});Object.defineProperty(me.prototype,"type",{enumerable:!0});var Ne=class extends me{constructor(e,t={}){super(e),this[oi]=t.code===void 0?0:t.code,this[li]=t.reason===void 0?"":t.reason,this[di]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[oi]}get reason(){return this[li]}get wasClean(){return this[di]}};Object.defineProperty(Ne.prototype,"code",{enumerable:!0});Object.defineProperty(Ne.prototype,"reason",{enumerable:!0});Object.defineProperty(Ne.prototype,"wasClean",{enumerable:!0});var Xe=class extends me{constructor(e,t={}){super(e),this[ci]=t.error===void 0?null:t.error,this[ui]=t.message===void 0?"":t.message}get error(){return this[ci]}get message(){return this[ui]}};Object.defineProperty(Xe.prototype,"error",{enumerable:!0});Object.defineProperty(Xe.prototype,"message",{enumerable:!0});var ft=class extends me{constructor(e,t={}){super(e),this[ai]=t.data===void 0?null:t.data}get data(){return this[ai]}};Object.defineProperty(ft.prototype,"data",{enumerable:!0});var Ca={addEventListener(r,e,t={}){for(let s of this.listeners(r))if(!t[lt]&&s[Nn]===e&&!s[lt])return;let n;if(r==="message")n=function(i,a){let f=new ft("message",{data:a?i:i.toString()});f[Ke]=this,Ht(e,this,f)};else if(r==="close")n=function(i,a){let f=new Ne("close",{code:i,reason:a.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});f[Ke]=this,Ht(e,this,f)};else if(r==="error")n=function(i){let a=new Xe("error",{error:i,message:i.message});a[Ke]=this,Ht(e,this,a)};else if(r==="open")n=function(){let i=new me("open");i[Ke]=this,Ht(e,this,i)};else return;n[lt]=!!t[lt],n[Nn]=e,t.once?this.once(r,n):this.on(r,n)},removeEventListener(r,e){for(let t of this.listeners(r))if(t[Nn]===e&&!t[lt]){this.removeListener(r,t);break}}};hi.exports={CloseEvent:Ne,ErrorEvent:Xe,Event:me,EventTarget:Ca,MessageEvent:ft};function Ht(r,e,t){typeof r=="object"&&r.handleEvent?r.handleEvent.call(r,t):r.call(e,t)}});var Rn=N((uu,mi)=>{"use strict";var{tokenChars:dt}=He();function fe(r,e,t){r[e]===void 0?r[e]=[t]:r[e].push(t)}function Oa(r){let e=Object.create(null),t=Object.create(null),n=!1,s=!1,i=!1,a,f,h=-1,l=-1,g=-1,p=0;for(;p<r.length;p++)if(l=r.charCodeAt(p),a===void 0)if(g===-1&&dt[l]===1)h===-1&&(h=p);else if(p!==0&&(l===32||l===9))g===-1&&h!==-1&&(g=p);else if(l===59||l===44){if(h===-1)throw new SyntaxError(`Unexpected character at index ${p}`);g===-1&&(g=p);let S=r.slice(h,g);l===44?(fe(e,S,t),t=Object.create(null)):a=S,h=g=-1}else throw new SyntaxError(`Unexpected character at index ${p}`);else if(f===void 0)if(g===-1&&dt[l]===1)h===-1&&(h=p);else if(l===32||l===9)g===-1&&h!==-1&&(g=p);else if(l===59||l===44){if(h===-1)throw new SyntaxError(`Unexpected character at index ${p}`);g===-1&&(g=p),fe(t,r.slice(h,g),!0),l===44&&(fe(e,a,t),t=Object.create(null),a=void 0),h=g=-1}else if(l===61&&h!==-1&&g===-1)f=r.slice(h,p),h=g=-1;else throw new SyntaxError(`Unexpected character at index ${p}`);else if(s){if(dt[l]!==1)throw new SyntaxError(`Unexpected character at index ${p}`);h===-1?h=p:n||(n=!0),s=!1}else if(i)if(dt[l]===1)h===-1&&(h=p);else if(l===34&&h!==-1)i=!1,g=p;else if(l===92)s=!0;else throw new SyntaxError(`Unexpected character at index ${p}`);else if(l===34&&r.charCodeAt(p-1)===61)i=!0;else if(g===-1&&dt[l]===1)h===-1&&(h=p);else if(h!==-1&&(l===32||l===9))g===-1&&(g=p);else if(l===59||l===44){if(h===-1)throw new SyntaxError(`Unexpected character at index ${p}`);g===-1&&(g=p);let S=r.slice(h,g);n&&(S=S.replace(/\\/g,""),n=!1),fe(t,f,S),l===44&&(fe(e,a,t),t=Object.create(null),a=void 0),f=void 0,h=g=-1}else throw new SyntaxError(`Unexpected character at index ${p}`);if(h===-1||i||l===32||l===9)throw new SyntaxError("Unexpected end of input");g===-1&&(g=p);let m=r.slice(h,g);return a===void 0?fe(e,m,t):(f===void 0?fe(t,m,!0):n?fe(t,f,m.replace(/\\/g,"")):fe(t,f,m),fe(e,a,t)),e}function Pa(r){return Object.keys(r).map(e=>{let t=r[e];return Array.isArray(t)||(t=[t]),t.map(n=>[e].concat(Object.keys(n).map(s=>{let i=n[s];return Array.isArray(i)||(i=[i]),i.map(a=>a===!0?s:`${s}=${a}`).join("; ")})).join("; ")).join(", ")}).join(", ")}mi.exports={format:Pa,parse:Oa}});var Xt=N((du,Oi)=>{"use strict";var ka=require("events"),Na=require("https"),Ra=require("http"),yi=require("net"),La=require("tls"),{randomBytes:Ma,createHash:ja}=require("crypto"),{Duplex:lu,Readable:fu}=require("stream"),{URL:Ln}=require("url"),xe=ut(),Ia=Cn(),Da=kn(),{isBlob:qa}=He(),{BINARY_TYPES:_i,EMPTY_BUFFER:Jt,GUID:Ba,kForOnEventAttribute:Mn,kListener:Aa,kStatusCode:$a,kWebSocket:H,NOOP:bi}=he(),{EventTarget:{addEventListener:Ua,removeEventListener:Wa}}=pi(),{format:Fa,parse:Va}=Rn(),{toBuffer:Ga}=at(),za=30*1e3,Si=Symbol("kAborted"),jn=[8,13],_e=["CONNECTING","OPEN","CLOSING","CLOSED"],Ha=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,A=class r extends ka{constructor(e,t,n){super(),this._binaryType=_i[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Jt,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=r.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(n=t,t=[]):t=[t]),vi(this,e,t,n)):(this._autoPong=n.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){_i.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,n){let s=new Ia({allowSynchronousEvents:n.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation}),i=new Da(e,this._extensions,n.generateMask);this._receiver=s,this._sender=i,this._socket=e,s[H]=this,i[H]=this,e[H]=this,s.on("conclude",Ka),s.on("drain",Xa),s.on("error",Qa),s.on("message",Za),s.on("ping",ec),s.on("pong",tc),i.onerror=rc,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",xi),e.on("data",Kt),e.on("end",Ti),e.on("error",Ci),this._readyState=r.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=r.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[xe.extensionName]&&this._extensions[xe.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=r.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==r.CLOSED){if(this.readyState===r.CONNECTING){ne(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===r.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=r.CLOSING,this._sender.close(e,t,!this._isServer,n=>{n||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),wi(this)}}pause(){this.readyState===r.CONNECTING||this.readyState===r.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,n){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(n=e,e=t=void 0):typeof t=="function"&&(n=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){In(this,e,n);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||Jt,t,n)}pong(e,t,n){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(n=e,e=t=void 0):typeof t=="function"&&(n=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){In(this,e,n);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||Jt,t,n)}resume(){this.readyState===r.CONNECTING||this.readyState===r.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,n){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(n=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){In(this,e,n);return}let s={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[xe.extensionName]||(s.compress=!1),this._sender.send(e||Jt,s,n)}terminate(){if(this.readyState!==r.CLOSED){if(this.readyState===r.CONNECTING){ne(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=r.CLOSING,this._socket.destroy())}}};Object.defineProperty(A,"CONNECTING",{enumerable:!0,value:_e.indexOf("CONNECTING")});Object.defineProperty(A.prototype,"CONNECTING",{enumerable:!0,value:_e.indexOf("CONNECTING")});Object.defineProperty(A,"OPEN",{enumerable:!0,value:_e.indexOf("OPEN")});Object.defineProperty(A.prototype,"OPEN",{enumerable:!0,value:_e.indexOf("OPEN")});Object.defineProperty(A,"CLOSING",{enumerable:!0,value:_e.indexOf("CLOSING")});Object.defineProperty(A.prototype,"CLOSING",{enumerable:!0,value:_e.indexOf("CLOSING")});Object.defineProperty(A,"CLOSED",{enumerable:!0,value:_e.indexOf("CLOSED")});Object.defineProperty(A.prototype,"CLOSED",{enumerable:!0,value:_e.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(r=>{Object.defineProperty(A.prototype,r,{enumerable:!0})});["open","error","close","message"].forEach(r=>{Object.defineProperty(A.prototype,`on${r}`,{enumerable:!0,get(){for(let e of this.listeners(r))if(e[Mn])return e[Aa];return null},set(e){for(let t of this.listeners(r))if(t[Mn]){this.removeListener(r,t);break}typeof e=="function"&&this.addEventListener(r,e,{[Mn]:!0})}})});A.prototype.addEventListener=Ua;A.prototype.removeEventListener=Wa;Oi.exports=A;function vi(r,e,t,n){let s={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:jn[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(r._autoPong=s.autoPong,!jn.includes(s.protocolVersion))throw new RangeError(`Unsupported protocol version: ${s.protocolVersion} (supported versions: ${jn.join(", ")})`);let i;if(e instanceof Ln)i=e;else try{i=new Ln(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}i.protocol==="http:"?i.protocol="ws:":i.protocol==="https:"&&(i.protocol="wss:"),r._url=i.href;let a=i.protocol==="wss:",f=i.protocol==="ws+unix:",h;if(i.protocol!=="ws:"&&!a&&!f?h=`The URL's protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"`:f&&!i.pathname?h="The URL's pathname is empty":i.hash&&(h="The URL contains a fragment identifier"),h){let w=new SyntaxError(h);if(r._redirects===0)throw w;Yt(r,w);return}let l=a?443:80,g=Ma(16).toString("base64"),p=a?Na.request:Ra.request,m=new Set,S;if(s.createConnection=s.createConnection||(a?Ya:Ja),s.defaultPort=s.defaultPort||l,s.port=i.port||l,s.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,s.headers={...s.headers,"Sec-WebSocket-Version":s.protocolVersion,"Sec-WebSocket-Key":g,Connection:"Upgrade",Upgrade:"websocket"},s.path=i.pathname+i.search,s.timeout=s.handshakeTimeout,s.perMessageDeflate&&(S=new xe(s.perMessageDeflate!==!0?s.perMessageDeflate:{},!1,s.maxPayload),s.headers["Sec-WebSocket-Extensions"]=Fa({[xe.extensionName]:S.offer()})),t.length){for(let w of t){if(typeof w!="string"||!Ha.test(w)||m.has(w))throw new SyntaxError("An invalid or duplicated subprotocol was specified");m.add(w)}s.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(s.origin&&(s.protocolVersion<13?s.headers["Sec-WebSocket-Origin"]=s.origin:s.headers.Origin=s.origin),(i.username||i.password)&&(s.auth=`${i.username}:${i.password}`),f){let w=s.path.split(":");s.socketPath=w[0],s.path=w[1]}let C;if(s.followRedirects){if(r._redirects===0){r._originalIpc=f,r._originalSecure=a,r._originalHostOrSocketPath=f?s.socketPath:i.host;let w=n&&n.headers;if(n={...n,headers:{}},w)for(let[L,$]of Object.entries(w))n.headers[L.toLowerCase()]=$}else if(r.listenerCount("redirect")===0){let w=f?r._originalIpc?s.socketPath===r._originalHostOrSocketPath:!1:r._originalIpc?!1:i.host===r._originalHostOrSocketPath;(!w||r._originalSecure&&!a)&&(delete s.headers.authorization,delete s.headers.cookie,w||delete s.headers.host,s.auth=void 0)}s.auth&&!n.headers.authorization&&(n.headers.authorization="Basic "+Buffer.from(s.auth).toString("base64")),C=r._req=p(s),r._redirects&&r.emit("redirect",r.url,C)}else C=r._req=p(s);s.timeout&&C.on("timeout",()=>{ne(r,C,"Opening handshake has timed out")}),C.on("error",w=>{C===null||C[Si]||(C=r._req=null,Yt(r,w))}),C.on("response",w=>{let L=w.headers.location,$=w.statusCode;if(L&&s.followRedirects&&$>=300&&$<400){if(++r._redirects>s.maxRedirects){ne(r,C,"Maximum redirects exceeded");return}C.abort();let G;try{G=new Ln(L,e)}catch{let b=new SyntaxError(`Invalid URL: ${L}`);Yt(r,b);return}vi(r,G,t,n)}else r.emit("unexpected-response",C,w)||ne(r,C,`Unexpected server response: ${w.statusCode}`)}),C.on("upgrade",(w,L,$)=>{if(r.emit("upgrade",w),r.readyState!==A.CONNECTING)return;C=r._req=null;let G=w.headers.upgrade;if(G===void 0||G.toLowerCase()!=="websocket"){ne(r,L,"Invalid Upgrade header");return}let x=ja("sha1").update(g+Ba).digest("base64");if(w.headers["sec-websocket-accept"]!==x){ne(r,L,"Invalid Sec-WebSocket-Accept header");return}let b=w.headers["sec-websocket-protocol"],E;if(b!==void 0?m.size?m.has(b)||(E="Server sent an invalid subprotocol"):E="Server sent a subprotocol but none was requested":m.size&&(E="Server sent no subprotocol"),E){ne(r,L,E);return}b&&(r._protocol=b);let F=w.headers["sec-websocket-extensions"];if(F!==void 0){if(!S){ne(r,L,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let O;try{O=Va(F)}catch{ne(r,L,"Invalid Sec-WebSocket-Extensions header");return}let oe=Object.keys(O);if(oe.length!==1||oe[0]!==xe.extensionName){ne(r,L,"Server indicated an extension that was not requested");return}try{S.accept(O[xe.extensionName])}catch{ne(r,L,"Invalid Sec-WebSocket-Extensions header");return}r._extensions[xe.extensionName]=S}r.setSocket(L,$,{allowSynchronousEvents:s.allowSynchronousEvents,generateMask:s.generateMask,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation})}),s.finishRequest?s.finishRequest(C,r):C.end()}function Yt(r,e){r._readyState=A.CLOSING,r._errorEmitted=!0,r.emit("error",e),r.emitClose()}function Ja(r){return r.path=r.socketPath,yi.connect(r)}function Ya(r){return r.path=void 0,!r.servername&&r.servername!==""&&(r.servername=yi.isIP(r.host)?"":r.host),La.connect(r)}function ne(r,e,t){r._readyState=A.CLOSING;let n=new Error(t);Error.captureStackTrace(n,ne),e.setHeader?(e[Si]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(Yt,r,n)):(e.destroy(n),e.once("error",r.emit.bind(r,"error")),e.once("close",r.emitClose.bind(r)))}function In(r,e,t){if(e){let n=qa(e)?e.size:Ga(e).length;r._socket?r._sender._bufferedBytes+=n:r._bufferedAmount+=n}if(t){let n=new Error(`WebSocket is not open: readyState ${r.readyState} (${_e[r.readyState]})`);process.nextTick(t,n)}}function Ka(r,e){let t=this[H];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=r,t._socket[H]!==void 0&&(t._socket.removeListener("data",Kt),process.nextTick(Ei,t._socket),r===1005?t.close():t.close(r,e))}function Xa(){let r=this[H];r.isPaused||r._socket.resume()}function Qa(r){let e=this[H];e._socket[H]!==void 0&&(e._socket.removeListener("data",Kt),process.nextTick(Ei,e._socket),e.close(r[$a])),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",r))}function gi(){this[H].emitClose()}function Za(r,e){this[H].emit("message",r,e)}function ec(r){let e=this[H];e._autoPong&&e.pong(r,!this._isServer,bi),e.emit("ping",r)}function tc(r){this[H].emit("pong",r)}function Ei(r){r.resume()}function rc(r){let e=this[H];e.readyState!==A.CLOSED&&(e.readyState===A.OPEN&&(e._readyState=A.CLOSING,wi(e)),this._socket.end(),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",r)))}function wi(r){r._closeTimer=setTimeout(r._socket.destroy.bind(r._socket),za)}function xi(){let r=this[H];this.removeListener("close",xi),this.removeListener("data",Kt),this.removeListener("end",Ti),r._readyState=A.CLOSING;let e;!this._readableState.endEmitted&&!r._closeFrameReceived&&!r._receiver._writableState.errorEmitted&&(e=r._socket.read())!==null&&r._receiver.write(e),r._receiver.end(),this[H]=void 0,clearTimeout(r._closeTimer),r._receiver._writableState.finished||r._receiver._writableState.errorEmitted?r.emitClose():(r._receiver.on("error",gi),r._receiver.on("finish",gi))}function Kt(r){this[H]._receiver.write(r)||this.pause()}function Ti(){let r=this[H];r._readyState=A.CLOSING,r._receiver.end(),this.end()}function Ci(){let r=this[H];this.removeListener("error",Ci),this.on("error",bi),r&&(r._readyState=A.CLOSING,this.destroy())}});var Ri=N((pu,Ni)=>{"use strict";var hu=Xt(),{Duplex:nc}=require("stream");function Pi(r){r.emit("close")}function sc(){!this.destroyed&&this._writableState.finished&&this.destroy()}function ki(r){this.removeListener("error",ki),this.destroy(),this.listenerCount("error")===0&&this.emit("error",r)}function ic(r,e){let t=!0,n=new nc({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return r.on("message",function(i,a){let f=!a&&n._readableState.objectMode?i.toString():i;n.push(f)||r.pause()}),r.once("error",function(i){n.destroyed||(t=!1,n.destroy(i))}),r.once("close",function(){n.destroyed||n.push(null)}),n._destroy=function(s,i){if(r.readyState===r.CLOSED){i(s),process.nextTick(Pi,n);return}let a=!1;r.once("error",function(h){a=!0,i(h)}),r.once("close",function(){a||i(s),process.nextTick(Pi,n)}),t&&r.terminate()},n._final=function(s){if(r.readyState===r.CONNECTING){r.once("open",function(){n._final(s)});return}r._socket!==null&&(r._socket._writableState.finished?(s(),n._readableState.endEmitted&&n.destroy()):(r._socket.once("finish",function(){s()}),r.close()))},n._read=function(){r.isPaused&&r.resume()},n._write=function(s,i,a){if(r.readyState===r.CONNECTING){r.once("open",function(){n._write(s,i,a)});return}r.send(s,a)},n.on("end",sc),n.on("error",ki),n}Ni.exports=ic});var Mi=N((mu,Li)=>{"use strict";var{tokenChars:oc}=He();function ac(r){let e=new Set,t=-1,n=-1,s=0;for(s;s<r.length;s++){let a=r.charCodeAt(s);if(n===-1&&oc[a]===1)t===-1&&(t=s);else if(s!==0&&(a===32||a===9))n===-1&&t!==-1&&(n=s);else if(a===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${s}`);n===-1&&(n=s);let f=r.slice(t,n);if(e.has(f))throw new SyntaxError(`The "${f}" subprotocol is duplicated`);e.add(f),t=n=-1}else throw new SyntaxError(`Unexpected character at index ${s}`)}if(t===-1||n!==-1)throw new SyntaxError("Unexpected end of input");let i=r.slice(t,s);if(e.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return e.add(i),e}Li.exports={parse:ac}});var $i=N((gu,Ai)=>{"use strict";var cc=require("events"),Qt=require("http"),{Duplex:_u}=require("stream"),{createHash:uc}=require("crypto"),ji=Rn(),Re=ut(),lc=Mi(),fc=Xt(),{GUID:dc,kWebSocket:hc}=he(),pc=/^[+/0-9A-Za-z]{22}==$/,Ii=0,Di=1,Bi=2,Dn=class extends cc{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:fc,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=Qt.createServer((n,s)=>{let i=Qt.STATUS_CODES[426];s.writeHead(426,{"Content-Length":i.length,"Content-Type":"text/plain"}),s.end(i)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let n=this.emit.bind(this,"connection");this._removeListeners=mc(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(s,i,a)=>{this.handleUpgrade(s,i,a,n)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=Ii}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===Bi){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(ht,this);return}if(e&&this.once("close",e),this._state!==Di)if(this._state=Di,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(ht,this):process.nextTick(ht,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{ht(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,n,s){t.on("error",qi);let i=e.headers["sec-websocket-key"],a=e.headers.upgrade,f=+e.headers["sec-websocket-version"];if(e.method!=="GET"){Le(this,e,t,405,"Invalid HTTP method");return}if(a===void 0||a.toLowerCase()!=="websocket"){Le(this,e,t,400,"Invalid Upgrade header");return}if(i===void 0||!pc.test(i)){Le(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(f!==13&&f!==8){Le(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});return}if(!this.shouldHandle(e)){pt(t,400);return}let h=e.headers["sec-websocket-protocol"],l=new Set;if(h!==void 0)try{l=lc.parse(h)}catch{Le(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let g=e.headers["sec-websocket-extensions"],p={};if(this.options.perMessageDeflate&&g!==void 0){let m=new Re(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let S=ji.parse(g);S[Re.extensionName]&&(m.accept(S[Re.extensionName]),p[Re.extensionName]=m)}catch{Le(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let m={origin:e.headers[`${f===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(m,(S,C,w,L)=>{if(!S)return pt(t,C||401,w,L);this.completeUpgrade(p,i,l,e,t,n,s)});return}if(!this.options.verifyClient(m))return pt(t,401)}this.completeUpgrade(p,i,l,e,t,n,s)}completeUpgrade(e,t,n,s,i,a,f){if(!i.readable||!i.writable)return i.destroy();if(i[hc])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>Ii)return pt(i,503);let l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${uc("sha1").update(t+dc).digest("base64")}`],g=new this.options.WebSocket(null,void 0,this.options);if(n.size){let p=this.options.handleProtocols?this.options.handleProtocols(n,s):n.values().next().value;p&&(l.push(`Sec-WebSocket-Protocol: ${p}`),g._protocol=p)}if(e[Re.extensionName]){let p=e[Re.extensionName].params,m=ji.format({[Re.extensionName]:[p]});l.push(`Sec-WebSocket-Extensions: ${m}`),g._extensions=e}this.emit("headers",l,s),i.write(l.concat(`\r
`).join(`\r
`)),i.removeListener("error",qi),g.setSocket(i,a,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(g),g.on("close",()=>{this.clients.delete(g),this._shouldEmitClose&&!this.clients.size&&process.nextTick(ht,this)})),f(g,s)}};Ai.exports=Dn;function mc(r,e){for(let t of Object.keys(e))r.on(t,e[t]);return function(){for(let n of Object.keys(e))r.removeListener(n,e[n])}}function ht(r){r._state=Bi,r.emit("close")}function qi(){this.destroy()}function pt(r,e,t,n){t=t||Qt.STATUS_CODES[e],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...n},r.once("finish",r.destroy),r.end(`HTTP/1.1 ${e} ${Qt.STATUS_CODES[e]}\r
`+Object.keys(n).map(s=>`${s}: ${n[s]}`).join(`\r
`)+`\r
\r
`+t)}function Le(r,e,t,n,s,i){if(r.listenerCount("wsClientError")){let a=new Error(s);Error.captureStackTrace(a,Le),r.emit("wsClientError",a,t,e)}else pt(t,n,s,i)}});var Qe=require("fs/promises"),Ui=require("path"),Wi=ae(es());var Ps=ae(pn(),1);var qt=class{disposables=[];dispose(){for(;this.disposables.length!==0;)this.disposables.pop().dispose()}push(e){let t=this.disposables;return t.push(e),{dispose(){let n=t.indexOf(e);n!==-1&&t.splice(n,1)}}}};function ks(r,e,t){r.forward(e,t),e.forward(r,t),r.onClose(()=>e.dispose()),e.onClose(()=>r.dispose())}function mn(r,e,t,n={}){let s=new qt;return r.onClose(()=>s.dispose()),e.onClose(()=>s.dispose()),{reader:r,writer:e,forward(i,a=f=>f){r.listen(f=>{let h=a(f);i.writer.write(h)})},onClose(i){return s.push(Ps.Disposable.create(i))},dispose:()=>t(),...n}}var js=ae(require("child_process"),1),Ve=ae(Rs(),1);var Ls=ae(Vr(),1),Bt=class extends Ls.AbstractMessageReader{socket;state="initial";callback;events=[];constructor(e){super(),this.socket=e,this.socket.onMessage(t=>this.readMessage(t)),this.socket.onError(t=>this.fireError(t)),this.socket.onClose((t,n)=>{if(t!==1e3){let s={name:""+t,message:`Error during socket reconnect: code = ${t}, reason = ${n}`};this.fireError(s)}this.fireClose()})}listen(e){if(this.state==="initial")for(this.state="listening",this.callback=e;this.events.length!==0;){let t=this.events.pop();t.message!==void 0?this.readMessage(t.message):t.error!==void 0?this.fireError(t.error):this.fireClose()}return{dispose:()=>{this.callback===e&&(this.state="initial",this.callback=void 0)}}}dispose(){super.dispose(),this.state="initial",this.callback=void 0,this.events.splice(0,this.events.length)}readMessage(e){if(this.state==="initial")this.events.splice(0,0,{message:e});else if(this.state==="listening")try{let t=JSON.parse(e);this.callback(t)}catch(t){let n={name:"400",message:`Error during message parsing, reason = ${typeof t=="object"?t.message:"unknown"}`};this.fireError(n)}}fireError(e){this.state==="initial"?this.events.splice(0,0,{error:e}):this.state==="listening"&&super.fireError(e)}fireClose(){this.state==="initial"?this.events.splice(0,0,{}):this.state==="listening"&&super.fireClose(),this.state="closed"}};var Ms=ae(Hr(),1),At=class extends Ms.AbstractMessageWriter{errorCount=0;socket;constructor(e){super(),this.socket=e}end(){}async write(e){try{let t=JSON.stringify(e);this.socket.send(t)}catch(t){this.errorCount++,this.fireError(t,e,this.errorCount)}}};function Is(r,e,t,n){let s=js.spawn(e,t||[],n||{});return s.on("error",i=>console.error(`Launching ${r} Server failed: ${i}`)),s.stderr!==null&&s.stderr.on("data",i=>console.error(`${r} Server: ${i}`)),Ko(s)}function Ds(r){let e=new Bt(r),t=new At(r);return mn(e,t,()=>r.dispose(),{socket:r})}function Ko(r){if(r.stdout!==null&&r.stdin!==null)return Xo(r.stdout,r.stdin,()=>r.kill())}function Xo(r,e,t){let n=new Ve.StreamMessageReader(r),s=new Ve.StreamMessageWriter(e);return mn(n,s,t)}var _c=ae(Ri(),1),gc=ae(Cn(),1),yc=ae(kn(),1),bc=ae(Xt(),1),qn=ae($i(),1);var Bn=class r{constructor(e){this.logFilePath=e;this.logFilePath=e}static async create(e){return await(0,Qe.mkdir)((0,Ui.dirname)(e),{recursive:!0}),await(0,Qe.writeFile)(e,""),new r(e)}async appendToLogFile(...e){let t=e.join(" ");try{await(0,Qe.appendFile)(this.logFilePath,`${t}
`)}catch(n){console.error("Failed to write to log file:",n)}}debug(...e){console.log(...e),this.appendToLogFile("[DEBUG]",...e)}log(...e){console.log(...e),this.appendToLogFile("[INFO]",...e)}error(...e){console.error(...e),this.appendToLogFile("[ERROR]",...e)}},An=class{constructor(e,t){this.webSocket=e;this.logger=t;this.webSocket=e,this.logger=t}send(e){try{this.webSocket.send(e),this.logger.debug("Sent message:",e)}catch(t){this.logger.error("Failed to send message:",t)}}onMessage(e){this.webSocket.onmessage=t=>{try{e(t.data),this.logger.debug("Received message:",t.data)}catch(n){this.logger.error("Error handling message:",n)}}}onError(e){this.webSocket.onerror=t=>{this.logger.error("WebSocket error:",t),"message"in t&&e(t.message)}}onClose(e){this.webSocket.onclose=t=>{this.logger.log(`WebSocket closed with code ${t.code}: ${t.reason}`),e(t.code,t.reason)}}dispose(){this.webSocket.close()}};function Sc(r,e,t,n){if(!r){t.close();return}let s=Is(r.join(" "),r[0],r.slice(1));if(!s)throw new Error("Not able to create json-rpc connection.");let i=new An(t,e),a=Ds(i);ks(a,s),i.onClose(()=>{s.dispose(),a.dispose()}),a.onClose(()=>{s.dispose(),i.dispose()})}function vc(r,e,t){let n=new qn.default({port:r,perMessageDeflate:!1});n.on("error",s=>{t.error("WebSocket server error:",s)}),n.on("connection",(s,i)=>{t.log(`New connection from ${i.socket.remoteAddress}`);try{Sc(e,t,s,i)}catch(a){t.error("Failed to start WebSocket bridge:",a),s.close()}})}async function Ec(){let r=(0,Wi.default)(process.argv);if(r.help){console.log('Usage: node index.cjs --log-file <path> --lsp "<command>" [--port <port>]');return}let e=await Bn.create(r["log-file"]),t=Number.parseInt(r.port)||3e3,n=r.lsp.split(" ");vc(t,n,e)}Ec();
