<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparrow Table Viewer</title>
    <script src="/static/vue.global.js"></script>
    <script src="/static/element-plus.js"></script>
    <script src="/static/element-plus-icons.js"></script>
    <link rel="stylesheet" href="/static/element-plus.css" />
    <link rel="stylesheet" href="/static/main.css" />
</head>
<body>
    {% raw %}
    <div id="app">
        <div class="main-container">
            <!-- Â§¥ÈÉ® -->
            <div class="header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <h1 style="margin: 0; font-size: 20px; color: #303133;">
                        üìä Sparrow Table Viewer
                    </h1>
                    <el-tag v-if="tableInfo" type="info">{{ tableInfo.file_path }}</el-tag>
                </div>
                <div style="display: flex; gap: 12px;">
                    <el-button @click="showUploadDialog = true" type="success" size="small">
                        ‰∏ä‰º†Êñá‰ª∂
                    </el-button>
                    <el-button @click="resetTable" type="warning" size="small">
                        ÈáçÁΩÆ
                    </el-button>
                    <el-button @click="saveTable" type="primary" size="small">
                        ‰øùÂ≠ò
                    </el-button>
                </div>
            </div>
            
            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div class="content">
                <!-- Â∑•ÂÖ∑Ê†è -->
                <div class="toolbar">
                    <el-button @click="refreshData" size="small" :loading="loading">
                        Âà∑Êñ∞Êï∞ÊçÆ
                    </el-button>
                    
                    <el-divider direction="vertical"></el-divider>
                    
                    <span style="color: #606266; font-size: 14px;">ÊØèÈ°µÊòæÁ§∫:</span>
                    <el-select v-model="pagination.pageSize" @change="loadTableData" size="small" style="width: 100px;">
                        <el-option :value="50" label="50"></el-option>
                        <el-option :value="100" label="100"></el-option>
                        <el-option :value="200" label="200"></el-option>
                        <el-option :value="500" label="500"></el-option>
                    </el-select>
                    
                    <el-divider direction="vertical"></el-divider>
                    
                    <el-button @click="showFilterDialog = true" size="small" type="info">
                        Ë°åÁ≠õÈÄâ ({{ activeFilters.length }})
                    </el-button>
                    
                    <el-button @click="clearFilters" size="small" v-if="activeFilters.length > 0">
                        Ê∏ÖÈô§Ë°åÁ≠õÈÄâ
                    </el-button>
                    
                    <el-divider direction="vertical"></el-divider>
                    
                    <el-button @click="showColumnDialog = true" size="small" type="success">
                        ÂàóÊòæÁ§∫ ({{ visibleColumns.length }}/{{ allColumns.length }})
                    </el-button>
                    
                    <el-button @click="resetColumns" size="small" v-if="visibleColumns.length < allColumns.length">
                        ÊòæÁ§∫ÂÖ®ÈÉ®Âàó
                    </el-button>
                    
                    <el-divider direction="vertical" v-if="tableInfo && tableInfo.image_columns && tableInfo.image_columns.length"></el-divider>
                    
                    <!-- ÂõæÂÉèËÆæÁΩÆ -->
                    <div v-if="tableInfo && tableInfo.image_columns && tableInfo.image_columns.length" style="display: flex; align-items: center; gap: 16px;">
                        <!-- ÂõæÂÉèÂ∞∫ÂØ∏ËÆæÁΩÆ -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #606266; font-size: 14px;">ÂõæÂÉèÂ∞∫ÂØ∏:</span>
                            <el-select v-model="imageSize" @change="onImageSizeChange" size="small" style="width: 140px;">
                                <el-option value="small" label="Â∞è (80x60)"></el-option>
                                <el-option value="medium" label="‰∏≠ (120x90)"></el-option>
                                <el-option value="large" label="Â§ß (160x120)"></el-option>
                                <el-option value="xlarge" label="Ë∂ÖÂ§ß (200x150)"></el-option>
                                <el-option value="xxlarge" label="ÊúÄÂ§ß (400x300)"></el-option>
                            </el-select>
                        </div>
                        
                        <!-- ÂàÜÈöîÁ¨¶ËÆæÁΩÆ -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #606266; font-size: 14px;">ÂàÜÈöîÁ¨¶:</span>
                            <el-select v-model="imageSeparator" @change="onSeparatorChange" @update:model-value="onSeparatorChange" size="small" style="width: 120px;">
                                <el-option value="auto" label="Ëá™Âä®Ê£ÄÊµã"></el-option>
                                <el-option value="semicolon" label="ÂàÜÂè∑ ;"></el-option>
                                <el-option value="newline" label="Êç¢Ë°åÁ¨¶"></el-option>
                                <el-option value="custom" label="Ëá™ÂÆö‰πâ"></el-option>
                            </el-select>
                            
                            <!-- Ëá™ÂÆö‰πâÂàÜÈöîÁ¨¶ËæìÂÖ• -->
                            <el-input 
                                v-if="imageSeparator === 'custom'"
                                v-model="customSeparator"
                                @change="onSeparatorChange"
                                placeholder="ËæìÂÖ•ÂàÜÈöîÁ¨¶"
                                size="small"
                                style="width: 100px;"
                            ></el-input>
                        </div>
                    </div>
                </div>
                
                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-info" v-if="tableInfo">
                    <span style="margin-right: 24px;">
                        <strong>ÊÄªË°åÊï∞:</strong> {{ tableData.total || 0 }} Ë°å
                    </span>
                    <span style="margin-right: 24px;">
                        <strong>ÊòæÁ§∫ÂàóÊï∞:</strong> {{ visibleColumns.length }}/{{ allColumns.length }} Âàó
                    </span>
                    <span v-if="tableInfo.image_columns && tableInfo.image_columns.length">
                        <strong>ÂõæÁâáÂàó:</strong> {{ tableInfo.image_columns.join(', ') }}
                    </span>
                </div>
                
                <!-- Ë°®Ê†ºÂÆπÂô® -->
                <div class="table-container">
                    <el-table 
                        :data="tableData.data" 
                        stripe
                        border
                        :loading="loading"
                        style="width: 100%;"
                        max-height="calc(100vh - 320px)"
                        size="small"
                    >
                        <el-table-column 
                            v-for="column in tableColumns" 
                            :key="column"
                            :prop="column"
                            :label="column"
                            :width="getColumnWidth(column)"
                            :sortable="false"
                            show-overflow-tooltip
                        >
                            <template #header="{ column: headerColumn }">
                                <div style="display: flex; align-items: center; gap: 8px; justify-content: space-between; width: 100%;">
                                    <span style="flex: 1;">{{ headerColumn.label }}</span>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <!-- ÊéíÂ∫èÊåâÈíÆ -->
                                        <el-button-group size="small">
                                            <el-button 
                                                @click.stop="handleSort(headerColumn.label, 'asc')"
                                                :type="sortConfig.prop === headerColumn.label && sortConfig.order === 'ascending' ? 'primary' : ''"
                                                size="small"
                                                style="padding: 2px 4px; font-size: 10px;"
                                                title="ÂçáÂ∫è"
                                            >
                                                ‚Üë
                                            </el-button>
                                            <el-button 
                                                @click.stop="handleSort(headerColumn.label, 'desc')"
                                                :type="sortConfig.prop === headerColumn.label && sortConfig.order === 'descending' ? 'primary' : ''"
                                                size="small"
                                                style="padding: 2px 4px; font-size: 10px;"
                                                title="ÈôçÂ∫è"
                                            >
                                                ‚Üì
                                            </el-button>
                                        </el-button-group>
                                        
                                        <!-- Á≠õÈÄâÊåâÈíÆ -->
                                        <el-button 
                                            @click.stop="addColumnFilter(headerColumn.label)"
                                            size="small"
                                            type="text"
                                            style="padding: 2px 4px; font-size: 10px;"
                                            title="Á≠õÈÄâ"
                                        >
                                            üîç
                                        </el-button>
                                    </div>
                                </div>
                            </template>
                            
                            <template #default="scope">
                                <div v-if="isImageColumn(column)">
                                    <div v-if="scope.row[column] && scope.row[column].paths && scope.row[column].paths.length > 0" class="multi-images-container">
                                        <template v-for="(imagePath, index) in scope.row[column].paths" :key="index">
                                            <!-- ÂõæÂÉèÂä†ËΩΩÊàêÂäüÊó∂ÊòæÁ§∫ÂõæÁâá -->
                                            <img 
                                                v-if="isImageLoaded(imagePath)"
                                                :src="`/api/image/proxy?url=${encodeURIComponent(imagePath)}`"
                                                :alt="imagePath"
                                                class="multi-image-item"
                                                @click="showImageDialog(imagePath, scope.row[column].paths, index)"
                                            />
                                            <!-- ÂõæÂÉèÊú™Âä†ËΩΩÊàêÂäüÊó∂ÊòæÁ§∫ÂéüÂßãURLÂ≠óÁ¨¶‰∏≤ -->
                                            <div 
                                                v-else
                                                style="color: #666; font-size: 12px; word-break: break-all; line-height: 1.4; cursor: pointer; margin-right: 8px; padding: 4px;"
                                                @click="showImageDialog(imagePath, scope.row[column].paths, index)"
                                            >
                                                {{ imagePath }}
                                            </div>
                                            <!-- ÈöêËóèÁöÑÂõæÁâáÂÖÉÁ¥†Áî®‰∫éÊ£ÄÊµãÂä†ËΩΩÁä∂ÊÄÅ -->
                                            <img 
                                                v-if="!isImageLoaded(imagePath)"
                                                :src="`/api/image/proxy?url=${encodeURIComponent(imagePath)}`"
                                                style="display: none;"
                                                @load="onImageLoadSuccess(imagePath)"
                                                @error="onImageLoadError(imagePath)"
                                            />
                                        </template>
                                    </div>
                                    <div v-else style="color: #666; font-size: 12px; word-break: break-all; line-height: 1.4; padding: 4px;">
                                        {{ scope.row[column] && scope.row[column].original ? scope.row[column].original : (scope.row[column] || '') }}
                                    </div>
                                </div>
                                <div v-else>
                                    <input 
                                        v-if="editingCell && editingCell.row === scope.$index && editingCell.column === column"
                                        v-model="editingValue"
                                        @blur="saveCell(scope.row._index, column)"
                                        @keyup.enter="saveCell(scope.row._index, column)"
                                        @keyup.escape="cancelEdit"
                                        class="cell-editor"
                                        ref="cellInput"
                                    />
                                    <span 
                                        v-else
                                        @dblclick="startEdit(scope.$index, column, scope.row[column])"
                                        style="cursor: pointer; display: block; min-height: 20px;"
                                    >
                                        {{ scope.row[column] || '' }}
                                    </span>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                    
                    <!-- ÂàÜÈ°µ -->
                    <div style="margin-top: 20px; display: flex; justify-content: center;">
                        <el-pagination
                            v-model:current-page="pagination.currentPage"
                            v-model:page-size="pagination.pageSize"
                            :page-sizes="[50, 100, 200, 500]"
                            layout="total, sizes, prev, pager, next, jumper"
                            :total="tableData.total"
                            @size-change="handleSizeChange"
                            @current-change="handleCurrentChange"
                        />
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Á≠õÈÄâÂØπËØùÊ°Ü -->
        <el-dialog v-model="showFilterDialog" title="È´òÁ∫ßÁ≠õÈÄâ" width="600px">
            <div v-for="(filter, index) in filterConfigs" :key="index" style="margin-bottom: 16px;">
                <el-row :gutter="12">
                    <el-col :span="6">
                        <el-select v-model="filter.column" placeholder="ÈÄâÊã©Âàó">
                            <el-option v-for="col in tableColumns" :key="col" :value="col" :label="col"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="6">
                        <el-select v-model="filter.operator" placeholder="Êìç‰ΩúÁ¨¶">
                            <el-option value="contains" label="ÂåÖÂê´"></el-option>
                            <el-option value="eq" label="Á≠â‰∫é"></el-option>
                            <el-option value="ne" label="‰∏çÁ≠â‰∫é"></el-option>
                            <el-option value="startswith" label="ÂºÄÂ§¥ÊòØ"></el-option>
                            <el-option value="endswith" label="ÁªìÂ∞æÊòØ"></el-option>
                            <el-option value="gt" label="Â§ß‰∫é"></el-option>
                            <el-option value="lt" label="Â∞è‰∫é"></el-option>
                            <el-option value="ge" label="Â§ß‰∫éÁ≠â‰∫é"></el-option>
                            <el-option value="le" label="Â∞è‰∫éÁ≠â‰∫é"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="8">
                        <el-input v-model="filter.value" placeholder="Á≠õÈÄâÂÄº"></el-input>
                    </el-col>
                    <el-col :span="4">
                        <el-button @click="removeFilter(index)" type="danger" size="small">Âà†Èô§</el-button>
                    </el-col>
                </el-row>
            </div>
            
            <el-button @click="addFilter" type="primary" size="small">Ê∑ªÂä†Á≠õÈÄâÊù°‰ª∂</el-button>
            
            <template #footer>
                <el-button @click="showFilterDialog = false">ÂèñÊ∂à</el-button>
                <el-button @click="applyFilters" type="primary">Â∫îÁî®Á≠õÈÄâ</el-button>
            </template>
        </el-dialog>
        
        <!-- ÂàóÊòæÁ§∫ÁÆ°ÁêÜÂØπËØùÊ°Ü -->
        <el-dialog v-model="showColumnDialog" title="ÂàóÊòæÁ§∫ÁÆ°ÁêÜ" width="500px">
            <div style="margin-bottom: 16px;">
                <el-button @click="selectAllColumns" size="small" type="primary">ÂÖ®ÈÄâ</el-button>
                <el-button @click="selectNoColumns" size="small">ÂÖ®‰∏çÈÄâ</el-button>
                <span style="margin-left: 16px; color: #666;">
                    Â∑≤ÈÄâÊã© {{ visibleColumns.length }} / {{ allColumns.length }} Âàó
                </span>
            </div>
            
            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 12px; border-radius: 4px;">
                <el-row :gutter="12">
                    <el-col :span="12" v-for="column in allColumns" :key="column" style="margin-bottom: 8px;">
                        <el-checkbox 
                            :model-value="visibleColumns.includes(column)"
                            @change="toggleColumn(column)"
                            style="width: 100%;"
                        >
                            <span :style="{ fontWeight: tableInfo && tableInfo.image_columns && tableInfo.image_columns.includes(column) ? 'bold' : 'normal', color: tableInfo && tableInfo.image_columns && tableInfo.image_columns.includes(column) ? '#409eff' : '' }">
                                {{ column }}
                                <el-tag v-if="tableInfo && tableInfo.image_columns && tableInfo.image_columns.includes(column)" size="small" type="primary">ÂõæÁâá</el-tag>
                            </span>
                        </el-checkbox>
                    </el-col>
                </el-row>
            </div>
            
            <template #footer>
                <el-button @click="showColumnDialog = false">ÂèñÊ∂à</el-button>
                <el-button @click="resetColumns" type="warning">ÈáçÁΩÆ</el-button>
                <el-button @click="applyColumnFilter" type="primary" :disabled="visibleColumns.length === 0">Â∫îÁî®</el-button>
            </template>
        </el-dialog>
        
        <!-- ÂõæÁâáÊü•ÁúãÂØπËØùÊ°Ü -->
        <el-dialog v-model="showImagePreview" :title="`${currentImageIndex + 1}/${currentImageList.length} - ${currentImageUrl}`" width="90%">
            <div style="position: relative; text-align: center;">
                <!-- Â∑¶ÁÆ≠Â§¥ÊåâÈíÆ -->
                <el-button 
                    v-if="currentImageList.length > 1 && currentImageIndex > 0"
                    @click="showPreviousImage"
                    type="primary"
                    size="large"
                    circle
                    style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); z-index: 10;"
                >
                    ‚Üê
                </el-button>
                
                <!-- ÂõæÁâá -->
                <img 
                    :src="`/api/image/proxy?url=${encodeURIComponent(currentImageUrl)}`"
                    style="max-width: 100%; max-height: 100vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                    @error="handleImageError"
                />
                
                <!-- Âè≥ÁÆ≠Â§¥ÊåâÈíÆ -->
                <el-button 
                    v-if="currentImageList.length > 1 && currentImageIndex < currentImageList.length - 1"
                    @click="showNextImage"
                    type="primary"
                    size="large"
                    circle
                    style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); z-index: 10;"
                >
                    ‚Üí
                </el-button>
            </div>
        </el-dialog>

        <!-- Êñá‰ª∂‰∏ä‰º†ÂØπËØùÊ°Ü -->
        <el-dialog v-model="showUploadDialog" title="‰∏ä‰º†Ë°®Ê†ºÊñá‰ª∂" width="600px">
            <div class="upload-area" 
                 @click="triggerFileInput"
                 @drop="handleFileDrop" 
                 @dragover="handleDragOver" 
                 @dragleave="handleDragLeave"
                 :class="{ 'dragover': isDragOver }">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">
                    <div>ÁÇπÂáªÈÄâÊã©Êñá‰ª∂ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
                    <div class="upload-hint">ÊîØÊåÅ .xlsx, .xls, .csv Ê†ºÂºè</div>
                </div>
            </div>
            
            <input type="file" 
                   ref="fileInput" 
                   @change="handleFileSelect" 
                   accept=".xlsx,.xls,.csv"
                   style="display: none;">
            
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showUploadDialog = false">ÂèñÊ∂à</el-button>
                </span>
            </template>
        </el-dialog>
    </div>
    {% endraw %}

    <script src="/static/main.js"></script>
</body>
</html>