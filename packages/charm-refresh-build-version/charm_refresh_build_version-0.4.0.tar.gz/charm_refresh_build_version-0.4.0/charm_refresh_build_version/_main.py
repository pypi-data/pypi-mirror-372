import os
import pathlib
import subprocess

import dunamai
import tomlkit

_refresh_versions_toml = pathlib.Path("refresh_versions.toml")


def _main():
    """Write charm refresh compatibility version during `charmcraft pack`

    Should be called in charmcraft.yaml
    """
    with _refresh_versions_toml.open("r") as file:
        versions = tomlkit.load(file)
    if not pathlib.Path(".git").exists() and versions.get("charm") is not None:
        # This charm is not at the root of the git repository (so the .git directory is not
        # available during `charmcraft pack`). The version was already set in refresh_versions.toml
        # by charmcraftlocal using `write_charm_version_before_pack`.
        return

    # Workaround for https://github.com/canonical/charmcraft/issues/2273
    subprocess.run(["git", "restore", "charmcraft.yaml"], check=True)

    _write_charm_version(_determine_charm_version())


def _determine_charm_version():
    try:
        result = dunamai.Version.from_git(
            strict=True, pattern=dunamai.Pattern.DefaultUnprefixed, pattern_prefix=r"v[^/]+/"
        )
    except Exception:
        if os.environ.get("CI") == "true":
            # Use strict mode on CI—if a charm refresh compatibility version tag is not
            # available, the build should fail
            raise Exception("Failed to determine charm refresh compatibility version")
        # In `charmcraft pack` LXC container, CI environment variable is not available
        elif (
            os.environ.get("TERM")
            # Typically, TERM is "xterm-256color" or "screen-256color" on Ubuntu machines
            in (
                "unknown",  # GitHub-hosted runner
                "vt220",  # IS-hosted runner
            )
            and os.environ.get("TZ") == "Etc/UTC"
        ):
            raise Exception(
                "Failed to determine charm refresh compatibility version. Heuristically assumed "
                "that `charmcraft pack` LXC container host is a CI machine"
            )
        # If a contributor forks a charm repository with "Copy the `main` branch only" checked,
        # tags will not be included in their fork. If they then clone their forked repository
        # and attempt to build the charm locally, the build would otherwise fail.
        # Disable strict mode so that build succeeds
        result = dunamai.Version.from_git(
            strict=False, pattern=dunamai.Pattern.DefaultUnprefixed, pattern_prefix=r"v[^/]+/"
        )
        # Mark result as dirty so that this charm build is recognized as unreleased (which will
        # fail refresh compatibility check)
        result.dirty = True

        track = "unknown"
    else:
        # Example: "v14/1.12.0"
        tag = result._matched_tag
        track, _ = tag.split("/")
        # Example: "14"
        track = track[1:]
    # Example: "14/1.12.0.post1.dev0+71201f4.dirty"
    charm_version = f"{track}/{result.serialize(dirty=True)}"
    if track == "unknown":
        assert ".dirty" in charm_version
    return charm_version


def _write_charm_version(charm_version: str):
    with _refresh_versions_toml.open("r") as file:
        versions = tomlkit.load(file)
    versions["charm"] = charm_version
    versions["charm"].comment("Autogenerated at build time")
    with _refresh_versions_toml.open("w") as file:
        tomlkit.dump(versions, file)


def determine_charm_version_before_pack() -> str:
    """Determine charm refresh compatibility version before `charmcraft pack` is called"""
    return _determine_charm_version()


def write_charm_version_before_pack(charm_version: str, /):
    """Write charm refresh compatibility version before `charmcraft pack` is called

    Use result of `determine_charm_version_before_pack()` as input

    Should not be called from charmcraft.yaml/during `charmcraft pack`—must be called before
    """
    _write_charm_version(charm_version)
