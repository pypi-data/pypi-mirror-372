<div id="agent_panel_root" style="display:flex; flex-direction:column; flex:1; min-height:0; position:relative;">
  <div id="ollama_status_dot" title="Checking Ollama..." style="position:absolute; top:8px; right:8px; width:10px; height:10px; border-radius:50%; background:#9ca3af; box-shadow:0 0 0 1px #e5e7eb;"></div>
  <div id="agent_onboarding" class="card" style="display:none;margin:20px;">
    <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
      <div>
        <h2>Agent Panel â€¢ Setup</h2>
        <p class="muted" style="margin-top: 0;">Let's setup your local AI environment.</p>
      </div>
      <img src="/static/ollama.png" alt="Ollama Logo" style="width: 30px; height: auto;" />
    </div>
    <ol>
      <li>Install Ollama: <a href="https://ollama.com" target="_blank" rel="noreferrer">https://ollama.com</a></li>
      <li>Start the service locally, then verify below.</li>
      <li>Pick a default model (ex: <code>gpt-oss:20b</code>).</li>
      <li>Save your Studio configuration.</li>
    </ol>
    <div class="actions" style="margin-top:12px;">
      <button id="btn_check_ollama" class="btn secondary" style="margin-top:5px;">Check Ollama</button>
      <input id="inp_model" type="text" placeholder="gpt-oss:20b" style="max-width:260px;" />
      <button id="btn_save_studio" class="btn" style="margin-top:5px;">Save</button>
    </div>
    <div id="onboarding_status" class="muted" style="margin-top:8px;"></div>
  </div>

  <div id="agent_chat" style="display:flex; flex-direction:column; min-height:0;">
    <h2>Agent Panel</h2>
    <div id="chat_log"
      style="flex:1; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:12px; background:#fff; min-height:0; height: calc(100vh - 183px);">
    </div>
    <div class="actions" style="margin-top:12px;">
      <input id="chat_input" type="text" placeholder="Ask something..." style="flex:1; width:100%;" />
      <button id="chat_send" class="btn" style="margin-top:5px;">Send</button>
      <button id="chat_stop" class="btn secondary" style="margin-top:5px; display:none;">Stop</button>
    </div>
  </div>
</div>

<script>
  (function () {
    const elOnboarding = document.getElementById('agent_onboarding');
    const elChat = document.getElementById('agent_chat');
    const status = document.getElementById('onboarding_status');
    const modelInp = document.getElementById('inp_model');
    const btnCheck = document.getElementById('btn_check_ollama');
    const btnSave = document.getElementById('btn_save_studio');
    const log = document.getElementById('chat_log');
    const input = document.getElementById('chat_input');
    const send = document.getElementById('chat_send');
    const stop = document.getElementById('chat_stop');
    const statusDot = document.getElementById('ollama_status_dot');
    let streamingController = null;
    let isStreaming = false;

    function append(role, text) {
      const item = document.createElement('div');
      item.style.marginBottom = '10px';
      item.innerHTML = '<b>' + role + ':</b> ' + (text || '').replace(/</g, '&lt;');
      log.appendChild(item);
      log.scrollTop = log.scrollHeight;
      return item;
    }

    async function refreshStatus() {
      try {
        const r = await fetch('/studio/status');
        const j = await r.json();
        if (j.configured) {
          elOnboarding.style.display = 'none';
          elChat.style.display = 'block';
        } else {
          elOnboarding.style.display = 'block';
          elChat.style.display = 'none';
        }
      } catch (e) { /* ignore */ }
    }

    async function checkOllama() {
      status.textContent = 'Checking Ollama...';
      if (statusDot) { statusDot.style.background = '#9ca3af'; statusDot.title = 'Checking Ollama...'; }
      try {
        const r = await fetch('/studio/check-ollama');
        const j = await r.json();
        status.textContent = j.ok ? 'Ollama is reachable on http://127.0.0.1:11434' : 'Ollama is not reachable';
        if (statusDot) { statusDot.style.background = j.ok ? '#10b981' : '#ef4444'; statusDot.title = j.ok ? 'Ollama reachable' : 'Ollama not reachable'; }
      } catch (e) {
        status.textContent = 'Ollama check failed';
        if (statusDot) { statusDot.style.background = '#ef4444'; statusDot.title = 'Ollama check failed'; }
      }
    }

    async function saveStudio() {
      const payload = { model: modelInp.value || 'deepseek-r1:8b' };
      try {
        const r = await fetch('/studio/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const j = await r.json();
        status.textContent = j.ok ? 'Saved. You can now use the chat.' : (j.message || 'Save failed');
        await refreshStatus();
      } catch (e) { status.textContent = 'Save failed'; }
    }

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      append('You', text);
      input.value = '';
      if (isStreaming) return;
      isStreaming = true;
      send.disabled = true; if (stop) stop.style.display = 'inline-block';
      const agentDiv = append('Agent', '');
      const decoder = new TextDecoder();
      streamingController = new AbortController();
      let accumulated = '';
      function render(text) {
        agentDiv.innerHTML = '<b>Agent:</b> ' + (text || '').replace(/</g, '&lt;');
        log.scrollTop = log.scrollHeight;
      }
      try {
        const r = await fetch('/studio/chat?stream=1', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt: text }), signal: streamingController.signal });
        if (!r.ok) {
          // Non-streaming error response
          try {
            const j = await r.json();
            let show = j.response || (j.error && (typeof j.error === 'string' ? j.error : (j.error.detail || j.error.message || j.error.error))) || j.message || ('HTTP ' + r.status);
            render(show);
          } catch (_) {
            const t = await r.text();
            render(t || ('HTTP ' + r.status));
          }
        } else if (r.body) {
          const reader = r.body.getReader();
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            accumulated += chunk;
            render(accumulated);
          }
        } else {
          render('(no response)');
        }
      } catch (e) {
        if (e && e.name === 'AbortError') {
          render(accumulated || '(stopped)');
        } else {
          render('Request failed');
        }
      } finally {
        isStreaming = false;
        send.disabled = false; if (stop) stop.style.display = 'none';
        streamingController = null;
      }
    }

    btnCheck && btnCheck.addEventListener('click', checkOllama);
    btnSave && btnSave.addEventListener('click', saveStudio);
    send && send.addEventListener('click', sendMessage);
    stop && stop.addEventListener('click', function () { if (streamingController) { try { streamingController.abort(); } catch (e) { } } });
    input && input.addEventListener('keydown', function (e) { if (e.key === 'Enter') sendMessage(); });

    refreshStatus();
    checkOllama();
  })();
</script>