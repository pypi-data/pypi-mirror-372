spec:
  inputs:
    addon-name:
      description: "The path of the addon you want to build"
    addon-parent_path:
      default: "."
      description: "The default path where the addon is"
    name:
      default: "pypi"
      description: "The name of the job"
    stage:
      description: "The stage where to add this job"
      default: deploy
    tag:
      default: "lint"
      description: "The name of the tag for this job"
    dependencies:
      type: array
      description: "Previous builder job"
    publish_url:
      default: "https://upload.pypi.org/legacy/"
      description: "The repository target to publish"
    registry_user:
      default: "__token__"
      description: "The user used to publish (pypi use '__token__' as default)"
    registry_token_var:
      description: "The environment variable where to find the token for twine"
      default: "$PYPI_REGISTRY_TOKEN"
    python_version:
      default: "3.13"
---
"upload:$[[ inputs.name ]]:$[[ inputs.addon-name ]]":
  stage: $[[ inputs.stage ]]
  interruptible: true
  tags:
    - $[[ inputs.tag ]]
  dependencies:
    - $[[ inputs.dependencies ]]
  image:
    name: "ghcr.io/astral-sh/uv:python$[[ inputs.python_version ]]-bookworm"
    entrypoint: [ "" ]
  variables:
    UV_CACHE_DIR: .uv-cache
    UV_SYSTEM_PYTHON: 1
    # GitLab CI creates a separate mountpoint for the build directory,
    # so we need to copy instead of using hard links.
    UV_LINK_MODE: copy
  cache:
    - key:
        files:
          - uv.lock
      paths:
        - $UV_CACHE_DIR
  script:
    - uv build $[[ inputs.addon-parent_path ]]/$[[ inputs.addon-name ]]
    - export UV_PUBLISH_URL="$[[ inputs.publish_url | expand_vars]]"
    - export UV_PUBLISH_USERNAME="$[[ inputs.registry_user | expand_vars ]]"
    - export UV_PUBLISH_PASSWORD="$[[ inputs.registry_token_var ]]"
    - |
      if [[ $UV_PUBLISH_URL = "$CI_SERVER_HOST" ]]
      then
        export UV_PUBLISH_URL="$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/pypi"
        export UV_PUBLISH_USERNAME="gitlab-ci-token"
        export UV_PUBLISH_PASSWORD=$CI_JOB_TOKEN
        unset UV_PUBLISH_TOKEN
      fi
    - uv publish dist/*.whl
  rules:
    - changes: # Include the job and set to when:manual if any of the follow paths match a modified file.
        - $[[ inputs.addon-parent_path ]]/$[[ inputs.addon-name ]]/**/*
