spec:
  inputs:
    addon-name:
      description: "The path of the addon you want to build"
    addon-parent_path:
      default: "."
      description: "The default path where the addon is"
    name:
      default: "addon"
      description: "The name of the job"
    stage:
      description: "The stage where to add this job"
      default: build
    tag:
      default: "lint"
      description: "The name of the tag for this job"
    python_version:
      default: "3.13"


---
"build:$[[ inputs.name ]]:$[[ inputs.addon-name ]]":
  stage: $[[ inputs.stage ]]
  interruptible: true
  tags:
    - $[[ inputs.tag ]]
  image:
    name: "ghcr.io/astral-sh/uv:python$[[ inputs.python_version ]]-bookworm"
    entrypoint: [ "" ]
  variables:
    UV_CACHE_DIR: .uv-cache
    UV_SYSTEM_PYTHON: 1
    # GitLab CI creates a separate mountpoint for the build directory,
    # so we need to copy instead of using hard links.
    UV_LINK_MODE: copy
  cache:
    - key:
        files:
          - uv.lock
      paths:
        - $UV_CACHE_DIR
  script:
    - uv build $[[ inputs.addon-parent_path ]]/$[[ inputs.addon-name ]] -o dist
  after_script:
    # Your `uv` commands
    - uv cache prune --ci
  artifacts:
    paths:
      - "dist/"
