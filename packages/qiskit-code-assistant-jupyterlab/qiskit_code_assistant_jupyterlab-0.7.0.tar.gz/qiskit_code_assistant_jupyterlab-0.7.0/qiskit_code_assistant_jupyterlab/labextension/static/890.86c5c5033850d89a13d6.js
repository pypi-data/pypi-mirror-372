"use strict";(self.webpackChunkqiskit_code_assistant_jupyterlab=self.webpackChunkqiskit_code_assistant_jupyterlab||[]).push([[890],{890:(t,e,s)=>{s.r(e),s.d(e,{default:()=>U});var n=s(715),i=s(597),a=s(531),o=s(361),r=s(797),c=s(159),l=s(256),d=s(310),u=s(269);async function m(t="",e={}){const s=u.ServerConnection.makeSettings(),n=d.URLExt.join(s.baseUrl,"qiskit-code-assistant",t);let i;try{i=await u.ServerConnection.makeRequest(n,e,s)}catch(t){throw console.error("The qiskit_code_assistant_jupyterlab server extension appears to be missing.\n",t),new u.ServerConnection.NetworkError(t)}return i}const p=[401,403,422];async function h(t){p.includes(t.status)&&await t.json().then((t=>{t.detail&&n.Notification.error(`Qiskit Code Assistant:\n${t.detail}`,{autoClose:!1})}))}async function f(t){return await m("service",{method:"POST",body:JSON.stringify({url:t})}).then((t=>{if(t.ok)return t.json().then((t=>(console.debug("Updated service URL:",t.url),t)));throw console.error("Error updating service URL",t.status,t.statusText),Error(t.statusText)}))}async function g(t){return await m(`prompt/${t}/acceptance`,{method:"POST",body:JSON.stringify({accepted:!0})}).then((async t=>{if(t.ok)return await t.json();throw h(t),console.error("Error accepting prompt",t.status,t.statusText),Error(t.statusText)}))}var v=s(345),k=s.n(v);let w,y=[];function b(){return y}function _(){return w}function C(t){var e;w=y.find((e=>e._id===(null==t?void 0:t._id))),null===(e=Z.widget)||void 0===e||e.refreshStatusBar()}async function A(){return await async function(){return await m("models").then((async t=>{if(t.ok){const e=await t.json();return console.debug("models list:",e),e.models}throw h(t),console.error("Error getting models",t.status,t.statusText),Error(t.statusText)}))}().then((t=>{var e;y=t,w=y.find((t=>t._id===(null==w?void 0:w._id)))||(null==t?void 0:t[0]),null===(e=Z.widget)||void 0===e||e.refreshStatusBar()})).catch((t=>{throw new Error(t)}))}async function E(t){return await async function(t){return await m(`model/${t}/disclaimer`).then((async t=>{if(t.ok)return await t.json();throw h(t),console.error("Error getting disclaimer",t.status,t.statusText),Error(t.statusText)}))}(t).then((async e=>{if(e.accepted)return e.accepted;const s={__html:e.body};return await(0,n.showDialog)({title:e.title,body:k().createElement("div",{dangerouslySetInnerHTML:s}),buttons:[n.Dialog.cancelButton(),n.Dialog.okButton({label:"Accept"})]}).then((async s=>!!s.button.accept&&await async function(t,e){return await m(`disclaimer/${t}/acceptance`,{method:"POST",body:JSON.stringify({model:e,accepted:!0})}).then((async t=>{if(t.ok)return await t.json();throw h(t),console.error("Error accepting disclaimer",t.status,t.statusText),Error(t.statusText)}))}(e._id,t).then((async t=>await A().then((()=>t.success))))))}))}async function x(){if(!await async function(){return await m("token").then((async t=>{if(t.ok)return(await t.json()).success;throw console.error("Error getting models",t.status,t.statusText),Error(t.statusText)}))}())return await S()}async function S(){await n.InputDialog.getPassword({title:"Enter your API token from quantum.cloud.ibm.com",label:"In order to use Qiskit Code Assistant you need a IBM Quantum API Token"}).then((async t=>{if(t.button.accept&&t.value)return await async function(t){return await m("token",{method:"POST",body:JSON.stringify({token:t})}).then((t=>{if(!t.ok)throw console.error("Error submitting IBM Quantum API Token",t.status,t.statusText),Error(t.statusText);t.json().then((t=>{const e="IBM Quantum API Token saved";n.Notification.info(`Qiskit Code Assistant:\n${e}`,{autoClose:!1}),console.debug(e)}))}))}(t.value).then((async()=>{try{return await A()}catch(t){console.error("Failed to load models list",t)}}));throw Error("API token not set")})).catch((()=>{throw Error("API token not set")}))}async function T(t,e){return Z.widget.setLoadingStatus(),async function(t,e){return await m(`model/${t}/prompt`,{method:"POST",body:JSON.stringify({input:e})}).then((async t=>{if(t.ok){const e=await t.json();return console.debug("prompt:",e),e}throw h(t),console.error("Error sending prompt",t.status,t.statusText),Error(t.statusText)}))}(t,e).then((t=>{const s=[];return t.results.map((t=>s.push(t.generated_text))),{items:s,prompt_id:t.prompt_id,input:e}}))}async function*I(t,e){Z.widget.setLoadingStatus();const s=async function*(t,e){const s=await async function*(t="",e={}){const s=u.ServerConnection.makeSettings(),n=d.URLExt.join(s.baseUrl,"qiskit-code-assistant",t);let i;try{if(i=await u.ServerConnection.makeRequest(n,e,s),!i.body)throw console.error("The qiskit_code_assistant_jupyterlab server extension request returned no body."),new u.ServerConnection.ResponseError(i,"Fetch failed. No response body returned.");const t=i.body.getReader();for(;;){const{done:e,value:s}=await t.read();if(e)break;yield(new TextDecoder).decode(s)}}catch(t){throw console.error("The qiskit_code_assistant_jupyterlab server extension appears to be missing.\n",t),new u.ServerConnection.NetworkError(t)}}(`model/${t}/prompt`,{method:"POST",body:JSON.stringify({input:e,stream:!0})});for await(const t of s){const e=t.split("\n");for(let t=0;t<e.length;t++){const s=e[t].trim();if(s.startsWith("data: "))try{const t=JSON.parse(s.substring(6));yield t}catch(t){console.error(`Error parsing JSON: ${t}`)}}}}(t,e);for await(const t of s){const s={items:[(n=t,void 0,void 0,null!==(a=null!==(i=null==n?void 0:n.generated_text)&&void 0!==i?i:null==n?void 0:n.results[0].generated_text)&&void 0!==a?a:"")],prompt_id:t.prompt_id,input:e};yield s}var n,i,a}async function j(t){const e={items:[],prompt_id:"",input:""};return await x().then((async()=>{var s;const n=Math.max(0,t.length-4e3),i=t.slice(n,t.length),a=_();return void 0===a?(console.error("Failed to send prompt","No model selected"),e):(null===(s=a.disclaimer)||void 0===s?void 0:s.accepted)?await T(a._id,i):await E(a._id).then((async t=>t?await T(a._id,i):(console.error("Disclaimer not accepted"),e)))})).catch((t=>(console.error("Failed to send prompt",t),e))).finally((()=>{Z.widget.refreshStatusBar()}))}const q=new c.LabIcon({name:"qiskit:feedback",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 32 32">\n  <polygon class="jp-icon2" fill="#000" points="22 4 22 6 26.586 6 20 12.586 21.414 14 28 7.414 28 12 30 12 30 4 22 4"/>\n  <path class="jp-icon2" fill="#000" d="M28,16v4a1.9965,1.9965,0,0,1-2,2H20l-4,7,1.7358,1,3.4288-6H26a3.9992,3.9992,0,0,0,4-4V16Z"/>\n  <path class="jp-icon2" fill="#000" d="M4,20V8A1.9965,1.9965,0,0,1,6,6H18V4H6A3.9986,3.9986,0,0,0,2,8V20a3.9992,3.9992,0,0,0,4,4h9V22H6A1.9965,1.9965,0,0,1,4,20Z"/>\n</svg>\n'}),B=new c.LabIcon({name:"qiskit:logo",svgstr:'<svg id="qiskit" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 200 200">\n    <path fill="#fff" d="M174.09,100.19c0-.07,0-.14,0-.22s0-.44,0-.67a74.13,74.13,0,0,0-15-44,12.85,12.85,0,0,0-3.37-4.11A74.34,74.34,0,0,0,102.42,26c-.8,0-1.61-.08-2.42-.08s-1.41,0-2.11.06A74,74,0,0,0,44.23,51.21a12.68,12.68,0,0,0-3.42,4.24A74.53,74.53,0,0,0,25.91,99.7a2.45,2.45,0,0,0,0,.27c0,.13,0,.25,0,.37A73.93,73.93,0,0,0,41.12,145a11.89,11.89,0,0,0,2.3,2.88,74.38,74.38,0,0,0,54.51,26.19c.69,0,1.38.05,2.07.05s1.27,0,1.91,0a74,74,0,0,0,54.88-26.49,12.65,12.65,0,0,0,2-2.51A74.64,74.64,0,0,0,174.09,100.19Zm-20.54,44.66c-3.56,3.23-11.35,6.54-22.6,8.83a6.47,6.47,0,0,0-5.68-3.35l-.51,0L114.07,126a128.16,128.16,0,0,1,24.71,4.12c10.45,3,16.95,7.17,16.95,11a3.66,3.66,0,0,1-.44,1.62C154.73,143.4,154.15,144.13,153.55,144.85Zm-54.9,11.78c-25.6-.27-45-5.52-51.76-11.25-.77-.91-1.53-1.84-2.27-2.8a3.91,3.91,0,0,1-.35-1.53c0-3.3,5.24-8.11,19.94-11.74a152.92,152.92,0,0,1,34-3.85H100c3.14,0,6.25.08,9.3.23l11.57,26.38a6.48,6.48,0,0,0-2,3.49A181.25,181.25,0,0,1,98.65,156.63Zm-1.18,13.16c-7.52-.48-12-3-12-4.38S91,161,100,161s14.56,2.89,14.56,4.46-4.66,4-12.39,4.4C100.6,169.85,99,169.85,97.47,169.79ZM47.37,54.07c4-3.1,11.52-6,21.71-8a7,7,0,0,0,6.22,3.8,5.85,5.85,0,0,0,.73,0L86.62,74C61.15,72,44.27,65.06,44.27,58.89a4,4,0,0,1,.24-1.3C45.43,56.39,46.37,55.21,47.37,54.07ZM100,43.29c25.78,0,45.41,5.07,52.67,10.82,1,1.1,1.9,2.25,2.8,3.42a3.9,3.9,0,0,1,.26,1.36c0,6.51-21.73,15.59-57.08,15.59-2.49,0-4.91-.1-7.27-.22L79.91,48.11a7,7,0,0,0,2.26-4C87.68,43.6,93.65,43.29,100,43.29Zm-14.56-8.7c0-1.47,4.85-4.1,12.9-4.42l1.54,0c.65,0,1.29,0,1.94,0,8,.35,12.74,3,12.74,4.41S109,39.05,100,39.05,85.44,36.17,85.44,34.59Zm50.43,47.27c20.23,3.84,33.44,10.74,34,17.68,0,.2,0,.4,0,.59-.27,8.9-23.45,18.63-58,20.69l-18.41-42q3.28-.1,6.61-.11A195.75,195.75,0,0,1,135.87,81.86ZM71.59,76.35q-4.26.59-8.28,1.35h0c-15.25,2.9-26.5,7.44-32.49,12.87A70.51,70.51,0,0,1,41,62.63C44.42,69.11,56.6,73.76,71.59,76.35ZM30.15,99.76c.26-7,13.53-14,33.95-17.89h0A186.59,186.59,0,0,1,88.84,79l18.43,42c-2.92.11-5.9.18-9,.18-40.45-.46-67.71-11.18-68.15-21C30.16,100.07,30.15,99.91,30.15,99.76ZM139.94,126a110.87,110.87,0,0,0-11.74-2.6,142.17,142.17,0,0,0,22.48-4.9c8.4-2.64,14.61-5.76,18.52-9.24a70.22,70.22,0,0,1-10.17,28C156.75,132.82,150.27,129,139.94,126Zm29.28-35.41c-6-5.46-17.26-10-32.55-12.92q-4.15-.78-8.57-1.38C143.38,73.67,155.57,69,159,62.57c.91,1.43,1.77,2.89,2.58,4.4A69.53,69.53,0,0,1,169.22,90.61Zm-53.7-50.9A6.4,6.4,0,0,0,118.76,35a2.12,2.12,0,0,0,0-.44,2,2,0,0,0,0-.43,5.19,5.19,0,0,0-.36-1.52A70.09,70.09,0,0,1,142.68,44.7,127.08,127.08,0,0,0,115.52,39.71ZM67,38.43A70.14,70.14,0,0,1,81.62,32.6a4.82,4.82,0,0,0-.38,1.56,2,2,0,0,0,0,.43,2.12,2.12,0,0,0,0,.44,6.43,6.43,0,0,0,3.24,4.68L81.66,40a7,7,0,0,0-13.28,1.93,94.18,94.18,0,0,0-11,2.79A70,70,0,0,1,67,38.43Zm-36.2,70.9c3.71,3.34,9.49,6.35,17.25,8.91a136.36,136.36,0,0,0,23.4,5.24c-2.86.49-5.61,1.06-8.22,1.71h0c-12,3-19.68,7.2-22.22,12.14-.89-1.4-1.74-2.82-2.54-4.3A69.65,69.65,0,0,1,30.77,109.33Zm53.86,50.85c-2,1.27-3.22,2.87-3.39,4.8a2,2,0,0,0,0,.43,2.12,2.12,0,0,0,0,.44,5,5,0,0,0,.35,1.49A70.2,70.2,0,0,1,56.9,155,127.31,127.31,0,0,0,84.63,160.18Zm48.4,1.39a69.81,69.81,0,0,1-14.64,5.82,5.1,5.1,0,0,0,.37-1.54,2.12,2.12,0,0,0,0-.44,2,2,0,0,0,0-.43c-.17-2-1.45-3.58-3.48-4.85,1.41-.13,2.8-.28,4.19-.44a6.48,6.48,0,0,0,12.21-1.9,98,98,0,0,0,11.72-3.06A69.92,69.92,0,0,1,133,161.57Z"/>\n</svg>'}),N="qiskit-code-assistant:prompt-feedback";let P;const L=()=>P=void 0;function M(t,e){const s=[];if(e instanceof a.NotebookPanel){const n=e.content.activeCellIndex,i=e.content.widgets;for(let t=0;t<n;t++)if(["code","markdown"].includes(i[t].model.type)){const e=i[t].model.toJSON().source;s.push(Array.isArray(e)?e.join("\n"):e)}return s.push(t),s.join("\n")}return t}class O{constructor(t){this.identifier="QiskitCodeAssistant:completer",this.rank=1100,this.prompt_id="",this.results=[],this.settings=t.settings,this.app=t.app}async fetch(t,e){return j(M(t.text,e.widget)).then((e=>(this.prompt_id=e.prompt_id,this.results=e.items,this.prompt_id&&(P=e,this.app.commands.notifyCommandChanged(N)),{start:t.offset,end:t.offset,items:e.items.map((t=>({label:t.trim(),insertText:t,icon:B})))})))}async isApplicable(t){return this.settings.composite.enableCompleter}accept(t){this.prompt_id&&this.results.includes(t)&&g(this.prompt_id)}}class Q{constructor(t){this.icon=B,this.identifier="qiskit-code-assistant-inline-completer",this.name="Qiskit Code Assistant",this.prompt_id="",this.schema={default:{enabled:!0,timeout:15e3}},this._streamPromises=new Map,this.settings=t.settings,this.app=t.app}async fetch(t,e){if(e.triggerKind===i.InlineCompletionTriggerKind.Automatic)return{items:[]};const s=this.settings.composite.enableStreaming,n=M(t.text,e.widget);if(s){const t=async function*(t){var e;const s={items:[],prompt_id:"",input:""};try{await x();const n=Math.max(0,t.length-4e3),i=t.slice(n,t.length),a=_();if(void 0===a)console.error("Failed to send prompt","No model selected"),yield s;else if(null===(e=a.disclaimer)||void 0===e?void 0:e.accepted){const t=await I(a._id,i);for await(const e of t)yield e}else if(await E(a._id)){const t=await I(a._id,i);for await(const e of t)yield e}else console.error("Disclaimer not accepted"),yield s}catch(t){return console.error("Failed to send prompt",t),s}finally{Z.widget.refreshStatusBar()}}(n),e=`qiskit-code-assitant_${(new Date).toISOString()}`;return this._streamPromises.set(e,t),Promise.resolve({items:[{insertText:"",isIncomplete:!0,token:e}]})}return j(n).then((t=>(this.prompt_id=t.prompt_id,this.prompt_id&&(P=t,this.app.commands.notifyCommandChanged(N)),{items:t.items.map((t=>({insertText:t})))})))}async*stream(t){const e=this._streamPromises.get(t);if(!e)return;let s,n="";for await(const t of e)s=t,n+=s.items[0],yield{response:{insertText:n}};this._streamPromises.delete(t),s&&(this.prompt_id=s.prompt_id,this.prompt_id&&(P=s,this.app.commands.notifyCommandChanged(N)))}async isApplicable(t){return!0}accept(){this.prompt_id&&g(this.prompt_id)}}class Z extends l.Widget{constructor(){super();const t=document.createElement("div");t.title="Click to change the model",t.classList.add("jp-qiskit-code-assistant-statusbar"),t.classList.add("jp-StatusBar-GroupItem"),this.addClass("jp-mod-highlighted"),this.node.appendChild(t),this._statusBar=t,this.refreshStatusBar(),Z.widget=this}refreshStatusBar(){const t=_();t?(this._statusBar.innerHTML="Qiskit Code Assistant: "+t.display_name,this.removeClass("jp-qiskit-code-assistant-statusbar-warn")):(this._statusBar.innerHTML="Qiskit Code Assistant: No Model Selected",this.addClass("jp-qiskit-code-assistant-statusbar-warn"))}setLoadingStatus(){this._statusBar.innerHTML=this._statusBar.innerHTML+c.refreshIcon.svgstr}async onClick(){await x().then((()=>{var t;const e=b(),s=[...e.map((t=>t.display_name))];n.InputDialog.getItem({title:"Select a Model",items:s,current:s.indexOf((null===(t=_())||void 0===t?void 0:t.display_name)||"")}).then((t=>{if(t.button.accept){const s=e.find((e=>e.display_name===t.value));s&&E(s._id).then((t=>{t&&(L(),C(s))}))}}))}))}onAfterAttach(t){super.onAfterAttach(t),this._statusBar.addEventListener("click",this.onClick.bind(this))}onBeforeDetach(t){this._statusBar.removeEventListener("click",this.onClick.bind(this)),super.onBeforeDetach(t)}}function D(){const t=c.ReactWidget.create(k().createElement("div",{className:"jp-qiskit-code-assistant-feedback",title:"Give feedback for the Qiskit Code Assistant",onClick:()=>F(!1)},k().createElement(q.react,{stylesheet:"statusBar",tag:"span",top:"2px",verticalAlign:"middle"})));return t.addClass("jp-mod-highlighted"),t}function F(t=!0){var e;const s=null===(e=_())||void 0===e?void 0:e._id,i=t?null==P?void 0:P.prompt_id:void 0,a=t?null==P?void 0:P.input:void 0,o=t?null==P?void 0:P.items[0]:void 0,r=new n.Dialog({title:"Qiskit Code Assistant Feedback",body:H(o),buttons:[n.Dialog.cancelButton(),n.Dialog.okButton({label:"Submit"})],focusNodeSelector:".jp-qiskit-code-assistant-feedback-form textarea"}),c=r.handleEvent;return r.handleEvent=t=>{"keydown"===t.type&&"Enter"===t.code&&document.activeElement instanceof HTMLTextAreaElement||c.call(r,t)},r.launch().then((t=>{var e,r,c,l;t.button.accept&&((null===(e=t.value)||void 0===e?void 0:e.positive_feedback)||(null===(r=t.value)||void 0===r?void 0:r.comment))&&async function(t,e,s,n,i,a){return await m("feedback",{method:"POST",body:JSON.stringify({model_id:t,prompt_id:e,positive_feedback:s,comment:n,input:i,output:a})}).then((async t=>{if(t.ok)return await t.json();throw h(t),console.error("Error sending feedback",t.status,t.statusText),Error(t.statusText)}))}(s,i,(t=>{switch(t){case"true":return!0;case"false":return!1;default:return}})(null===(c=t.value)||void 0===c?void 0:c.positive_feedback),null===(l=t.value)||void 0===l?void 0:l.comment,a,o).then((t=>{n.Notification.info(`Qiskit Code Assistant:\n${t.message}`,{autoClose:5e3})}))}))}function H(t){const e=c.ReactWidget.create(k().createElement(k().Fragment,null,!!t&&k().createElement(k().Fragment,null,k().createElement("b",null,"Completion"),k().createElement("pre",null,t.trim())),k().createElement("form",null,!!t&&k().createElement("p",null,"How helpful was this completion?      ",k().createElement("label",null,k().createElement("input",{type:"radio",name:"positive_feedback",value:"true"}),k().createElement("span",{className:"positive-feedback"},"👍")),"     ",k().createElement("label",null,k().createElement("input",{type:"radio",name:"positive_feedback",value:"false"}),k().createElement("span",{className:"positive-feedback"},"👎"))),k().createElement("p",null,k().createElement("label",null,k().createElement("p",null,t?"Additional feedback (Optional)":"Please share your experience with Qiskit Code Assistant"),k().createElement("textarea",{name:"comment"}))))));return e.addClass("jp-qiskit-code-assistant-feedback-form"),t?e.addClass("jp-qiskit-code-assistant-feedback-prompt"):e.addClass("jp-qiskit-code-assistant-feedback-general"),e.getValue=()=>{const t=e.node.querySelector("form"),s=new FormData(t||void 0);return{positive_feedback:s.get("positive_feedback")||void 0,comment:s.get("comment")||void 0}},e}const J="qiskit-code-assistant-jupyterlab";var R;!function(t){t.acceptInline="inline-completer:accept",t.selectCompleterNotebook="completer:select-notebook",t.selectCompleterFile="completer:select-file",t.updateApiToken="qiskit-code-assistant:set-api-token",t.promptFeedback="qiskit-code-assistant:prompt-feedback"}(R||(R={}));const $={id:J+":plugin",description:"AI Autocomplete JupyterLab extension for Qiskit Code Assistant",autoStart:!0,requires:[i.ICompletionProviderManager,a.INotebookTracker,n.ICommandPalette,o.ISettingRegistry,r.IStatusBar],activate:async(t,e,s,n,i,a)=>{console.debug("JupyterLab extension "+J+" is activated!");const o=await i.load($.id);console.debug(J+" settings loaded:",o.composite);let r=!1;f(o.composite.serviceUrl).then((t=>{r=t.is_openai,L()})),o.changed.connect((()=>f(o.composite.serviceUrl).then((t=>{r=t.is_openai,L(),A()}))));const c=new O({settings:o,app:t}),l=new Q({settings:o,app:t});e.registerProvider(c),e.registerInlineProvider(l),a.registerStatusItem(J+":feedback",{item:D(),align:"left",isActive:()=>!r});const d=new Z;a.registerStatusItem(J+":statusbar",{item:d,align:"left"}),await A().catch((t=>{console.error("Failed initial load of models list",t)})),t.commands.addCommand(R.promptFeedback,{label:"Give feedback for the Qiskit Code Assistant",icon:q,execute:()=>F(),isEnabled:()=>!r&&void 0!==P,isVisible:()=>{var t;return!r&&["code","markdown"].includes((null===(t=s.activeCell)||void 0===t?void 0:t.model.type)||"")&&void 0!==P}}),t.commands.addCommand(R.updateApiToken,{label:"Qiskit Code Assistant: Set IBM Quantum API token",execute:()=>S()}),n.addItem({command:R.updateApiToken,category:"Qiskit Code Assistant"}),e.selected.connect(((t,e)=>{o.composite.enableTelemetry&&c.accept(e.insertText)})),t.commands.commandExecuted.connect(((t,e)=>{e.id===R.acceptInline&&o.composite.enableTelemetry&&l.accept()}))}},U=$}}]);