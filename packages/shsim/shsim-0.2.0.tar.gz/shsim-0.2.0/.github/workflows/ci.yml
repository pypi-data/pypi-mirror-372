name: ci
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    name: ${{ matrix.os }} / py${{ matrix.py }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        py: ['3.10','3.11','3.12']

    env:
      # Force UTF-8 everywhere; avoids Windows cp1252 surprises
      PYTHONUTF8: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.py }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}

      # Use bash on Windows too, for consistent commands
      - name: Show environment
        shell: bash
        run: |
          set -x
          python --version
          pip --version
          uname -a || ver
          printf "OS=%s PY=%s\n" "${{ matrix.os }}" "${{ matrix.py }}"

      - name: List repo contents
        shell: bash
        run: |
          set -x
          ls -la
          echo "---- tree src ----"
          (command -v find >/dev/null 2>&1 && find src -maxdepth 3 -print) || true
          echo "---- pyproject ----"
          sed -n '1,200p' pyproject.toml || true
          echo "---- pytest.ini ----"
          sed -n '1,200p' pytest.ini || true

      - name: Install package + deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          pip install -e .
          pip install pytest coverage

      - name: Sanity import
        shell: bash
        run: |
          set -euxo pipefail
          python - << 'PY'
          import importlib
          m = importlib.import_module("shsim")
          print("shsim version:", getattr(m, "__version__", "n/a"))
          PY

      - name: Run tests (verbose)
        shell: bash
        env:
          PYTEST_ADDOPTS: "-vv -ra"
        run: |
          set -euxo pipefail
          coverage run -m pytest
          coverage report -m || true
          coverage xml || true

      - name: Show installed files for shsim
        if: always()
        shell: bash
        run: |
          set -x
          pip show -f shsim || true

      - name: Upload coverage.xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-py${{ matrix.py }}
          path: coverage.xml
